"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2992],{87015:(e,t,n)=>{n.d(t,{BN:()=>lp,Dc:()=>P,GG:()=>lg,H9:()=>og,My:()=>o9,P:()=>o5,_A:()=>ow,_M:()=>o8,c4:()=>lx,kd:()=>ly,rJ:()=>om,vK:()=>lI,wP:()=>lD,x7:()=>lf});var r,i,s,a,o=n(68998),l=n(56391),u=n(10796),h=n(17222),c=n(2107),d=n(80927),f=n(87358),m=n(44134).hp;let g="@firebase/firestore";class p{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}p.UNAUTHENTICATED=new p(null),p.GOOGLE_CREDENTIALS=new p("google-credentials-uid"),p.FIRST_PARTY=new p("first-party-uid"),p.MOCK_USER=new p("mock-user");let y="10.14.0",w=new u.Vy("@firebase/firestore");function v(){return w.logLevel}function I(e,...t){if(w.logLevel<=u.$b.DEBUG){let n=t.map(E);w.debug(`Firestore (${y}): ${e}`,...n)}}function _(e,...t){if(w.logLevel<=u.$b.ERROR){let n=t.map(E);w.error(`Firestore (${y}): ${e}`,...n)}}function T(e,...t){if(w.logLevel<=u.$b.WARN){let n=t.map(E);w.warn(`Firestore (${y}): ${e}`,...n)}}function E(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function b(e="Unexpected state"){let t=`FIRESTORE (${y}) INTERNAL ASSERTION FAILED: `+e;throw _(t),Error(t)}let S={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class x extends h.g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class D{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class C{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class N{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(p.UNAUTHENTICATED))}shutdown(){}}class A{constructor(e){this.t=e,this.currentUser=p.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){void 0===this.o||b();let n=this.i,r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve(),i=new D;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new D,e.enqueueRetryable(()=>r(this.currentUser))};let s=()=>{let t=i;e.enqueueRetryable(async()=>{await t.promise,await r(this.currentUser)})},a=e=>{I("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),s())};this.t.onInit(e=>a(e)),setTimeout(()=>{if(!this.auth){let e=this.t.getImmediate({optional:!0});e?a(e):(I("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new D)}},0),s()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(I("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?("string"==typeof t.accessToken||b(),new C(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let e=this.auth&&this.auth.getUid();return null===e||"string"==typeof e||b(),new p(e)}}class k{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=p.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);let e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class R{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new k(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(p.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class V{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class M{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){void 0===this.o||b();let n=e=>{null!=e.error&&I("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);let n=e.token!==this.R;return this.R=e.token,I("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>n(t))};let r=e=>{I("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit(e=>r(e)),setTimeout(()=>{if(!this.appCheck){let e=this.A.getImmediate({optional:!0});e?r(e):I("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?("string"==typeof e.token||b(),this.R=e.token,new V(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}class O{static newId(){let e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length,n="";for(;n.length<20;){let r=function(e){let t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(40);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let e=0;e<40;e++)n[e]=Math.floor(256*Math.random());return n}(40);for(let i=0;i<r.length;++i)n.length<20&&r[i]<t&&(n+=e.charAt(r[i]%e.length))}return n}}function F(e,t){return e<t?-1:+(e>t)}function L(e,t,n){return e.length===t.length&&e.every((e,r)=>n(e,t[r]))}class P{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0||t>=1e9)throw new x(S.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-0xe7791f700||e>=0x3afff44180)throw new x(S.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return P.fromMillis(Date.now())}static fromDate(e){return P.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new P(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?F(this.nanoseconds,e.nanoseconds):F(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){return String(this.seconds- -0xe7791f700).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class U{constructor(e){this.timestamp=e}static fromTimestamp(e){return new U(e)}static min(){return new U(new P(0,0))}static max(){return new U(new P(0x3afff4417f,0x3b9ac9ff))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class q{constructor(e,t,n){void 0===t?t=0:t>e.length&&b(),void 0===n?n=e.length-t:n>e.length-t&&b(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===q.comparator(this,e)}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof q?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=e.get(r),i=t.get(r);if(n<i)return -1;if(n>i)return 1}return e.length<t.length?-1:+(e.length>t.length)}}class B extends q{construct(e,t,n){return new B(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let n of e){if(n.indexOf("//")>=0)throw new x(S.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>e.length>0))}return new B(t)}static emptyPath(){return new B([])}}let z=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class K extends q{construct(e,t,n){return new K(e,t,n)}static isValidIdentifier(e){return z.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),K.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new K(["__name__"])}static fromServerFormat(e){let t=[],n="",r=0,i=()=>{if(0===n.length)throw new x(S.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""},s=!1;for(;r<e.length;){let t=e[r];if("\\"===t){if(r+1===e.length)throw new x(S.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new x(S.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new x(S.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new K(t)}static emptyPath(){return new K([])}}class G{constructor(e){this.path=e}static fromPath(e){return new G(B.fromString(e))}static fromName(e){return new G(B.fromString(e).popFirst(5))}static empty(){return new G(B.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===B.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return B.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new G(new B(e.slice()))}}class ${constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function Q(e){return e.fields.find(e=>2===e.kind)}function j(e){return e.fields.filter(e=>2!==e.kind)}$.UNKNOWN_ID=-1;class W{constructor(e,t){this.fieldPath=e,this.kind=t}}class J{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new J(0,X.min())}}function H(e,t){let n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1;return new X(U.fromTimestamp(1e9===r?new P(n+1,0):new P(n,r)),G.empty(),t)}function Y(e){return new X(e.readTime,e.key,-1)}class X{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new X(U.min(),G.empty(),-1)}static max(){return new X(U.max(),G.empty(),-1)}}function Z(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n||0!==(n=G.comparator(e.documentKey,t.documentKey))?n:F(e.largestBatchId,t.largestBatchId)}let ee="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class et{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function en(e){if(e.code!==S.FAILED_PRECONDITION||e.message!==ee)throw e;I("LocalStore","Unexpectedly lost primary lease")}class er{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&b(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new er((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof er?t:er.resolve(t)}catch(e){return er.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):er.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):er.reject(t)}static resolve(e){return new er((t,n)=>{t(e)})}static reject(e){return new er((t,n)=>{n(e)})}static waitFor(e){return new er((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=er.resolve(!1);for(let n of e)t=t.next(e=>e?er.resolve(e):n());return t}static forEach(e,t){let n=[];return e.forEach((e,r)=>{n.push(t.call(this,e,r))}),this.waitFor(n)}static mapArray(e,t){return new er((n,r)=>{let i=e.length,s=Array(i),a=0;for(let o=0;o<i;o++){let l=o;t(e[l]).next(e=>{s[l]=e,++a===i&&n(s)},e=>r(e))}})}static doWhile(e,t){return new er((n,r)=>{let i=()=>{!0===e()?t().next(()=>{i()},r):n()};i()})}}class ei{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.V=new D,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{t.error?this.V.reject(new el(e,t.error)):this.V.resolve()},this.transaction.onerror=t=>{let n=ef(t.target.error);this.V.reject(new el(e,n))}}static open(e,t,n,r){try{return new ei(t,e.transaction(r,n))}catch(e){throw new el(t,e)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(I("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){let e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){return new eh(this.transaction.objectStore(e))}}class es{constructor(e,t,n){this.name=e,this.version=t,this.p=n,12.2===es.S((0,h.ZQ)())&&_("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return I("SimpleDb","Removing database:",e),ec(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!(0,h.zW)())return!1;if(es.v())return!0;let e=(0,h.ZQ)(),t=es.S(e),n=ea(e);return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||0<t&&t<10||0<n&&n<4.5)}static v(){var e;return void 0!==f&&"YES"===(null==(e=f.__PRIVATE_env)?void 0:e.C)}static F(e,t){return e.store(t)}static S(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i);return Number(t?t[1].split("_").slice(0,2).join("."):"-1")}async M(e){return this.db||(I("SimpleDb","Opening database:",this.name),this.db=await new Promise((t,n)=>{let r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{t(e.target.result)},r.onblocked=()=>{n(new el(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{let r=t.target.error;"VersionError"===r.name?n(new x(S.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new x(S.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new el(e,r))},r.onupgradeneeded=e=>{I("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);let t=e.target.result;this.p.O(t,r.transaction,e.oldVersion,this.version).next(()=>{I("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.N&&(this.db.onversionchange=e=>this.N(e)),this.db}L(e){this.N=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){let i="readonly"===t,s=0;for(;;){++s;try{this.db=await this.M(e);let t=ei.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.g(),e)).catch(e=>(t.abort(e),er.reject(e))).toPromise();return s.catch(()=>{}),await t.m,s}catch(t){let e="FirebaseError"!==t.name&&s<3;if(I("SimpleDb","Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function ea(e){let t=e.match(/Android ([\d.]+)/i);return Number(t?t[1].split(".").slice(0,2).join("."):"-1")}class eo{constructor(e){this.B=e,this.k=!1,this.q=null}get isDone(){return this.k}get K(){return this.q}set cursor(e){this.B=e}done(){this.k=!0}$(e){this.q=e}delete(){return ec(this.B.delete())}}class el extends x{constructor(e,t){super(S.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function eu(e){return"IndexedDbTransactionError"===e.name}class eh{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(I("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(I("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),ec(n)}add(e){return I("SimpleDb","ADD",this.store.name,e,e),ec(this.store.add(e))}get(e){return ec(this.store.get(e)).next(t=>(void 0===t&&(t=null),I("SimpleDb","GET",this.store.name,e,t),t))}delete(e){return I("SimpleDb","DELETE",this.store.name,e),ec(this.store.delete(e))}count(){return I("SimpleDb","COUNT",this.store.name),ec(this.store.count())}U(e,t){let n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){let e=r.getAll(n.range);return new er((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{let e=this.cursor(n),t=[];return this.W(e,(e,n)=>{t.push(n)}).next(()=>t)}}G(e,t){let n=this.store.getAll(e,null===t?void 0:t);return new er((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}})}j(e,t){I("SimpleDb","DELETE ALL",this.store.name);let n=this.options(e,t);n.H=!1;let r=this.cursor(n);return this.W(r,(e,t,n)=>n.delete())}J(e,t){let n;t?n=e:(n={},t=e);let r=this.cursor(n);return this.W(r,t)}Y(e){let t=this.cursor({});return new er((n,r)=>{t.onerror=e=>{r(ef(e.target.error))},t.onsuccess=t=>{let r=t.target.result;r?e(r.primaryKey,r.value).next(e=>{e?r.continue():n()}):n()}})}W(e,t){let n=[];return new er((r,i)=>{e.onerror=e=>{i(e.target.error)},e.onsuccess=e=>{let i=e.target.result;if(!i)return void r();let s=new eo(i),a=t(i.primaryKey,i.value,s);if(a instanceof er){let e=a.catch(e=>(s.done(),er.reject(e)));n.push(e)}s.isDone?r():null===s.K?i.continue():i.continue(s.K)}}).next(()=>er.waitFor(n))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let n=this.store.index(e.index);return e.H?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function ec(e){return new er((t,n)=>{e.onsuccess=e=>{t(e.target.result)},e.onerror=e=>{n(ef(e.target.error))}})}let ed=!1;function ef(e){let t=es.S((0,h.ZQ)());if(t>=12.2&&t<13){let t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){let e=new x("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ed||(ed=!0,setTimeout(()=>{throw e},0)),e}}return e}class em{constructor(e,t){this.asyncQueue=e,this.Z=t,this.task=null}start(){this.X(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}X(e){I("IndexBackfiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{I("IndexBackfiller",`Documents written: ${await this.Z.ee()}`)}catch(e){eu(e)?I("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",e):await en(e)}await this.X(6e4)})}}class eg{constructor(e,t){this.localStore=e,this.persistence=t}async ee(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.te(t,e))}te(e,t){let n=new Set,r=t,i=!0;return er.doWhile(()=>!0===i&&r>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!n.has(t))return I("IndexBackfiller",`Processing collection: ${t}`),this.ne(e,t,r).next(e=>{r-=e,n.add(t)});i=!1})).next(()=>t-r)}ne(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next(n=>{let i=n.changes;return this.localStore.indexManager.updateIndexEntries(e,i).next(()=>this.re(r,n)).next(n=>(I("IndexBackfiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n))).next(()=>i.size)}))}re(e,t){let n=e;return t.changes.forEach((e,t)=>{let r=Y(t);Z(r,n)>0&&(n=r)}),new X(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class ep{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ie(e),this.se=e=>t.writeSequenceNumber(e))}ie(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this.se&&this.se(e),e}}function ey(e){return null==e}function ew(e){return 0===e&&1/e==-1/0}function ev(e){return"number"==typeof e&&Number.isInteger(e)&&!ew(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function eI(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t+="\x01\x01"),t=function(e,t){let n=t,r=e.length;for(let t=0;t<r;t++){let r=e.charAt(t);switch(r){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=r}}return n}(e.get(n),t);return t+"\x01\x01"}ep.oe=-1;function e_(e){let t=e.length;if(t>=2||b(),2===t)return"\x01"===e.charAt(0)&&"\x01"===e.charAt(1)||b(),B.emptyPath();let n=t-2,r=[],i="";for(let s=0;s<t;){let t=e.indexOf("\x01",s);switch((t<0||t>n)&&b(),e.charAt(t+1)){case"\x01":let a,o=e.substring(s,t);0===i.length?a=o:(i+=o,a=i,i=""),r.push(a);break;case"\x10":i+=e.substring(s,t),i+="\0";break;case"\x11":i+=e.substring(s,t+1);break;default:b()}s=t+2}return new B(r)}let eT=["userId","batchId"],eE={},eb=["prefixPath","collectionGroup","readTime","documentId"],eS=["prefixPath","collectionGroup","documentId"],ex=["collectionGroup","readTime","prefixPath","documentId"],eD=["canonicalId","targetId"],eC=["targetId","path"],eN=["path","targetId"],eA=["collectionId","parent"],ek=["indexId","uid"],eR=["uid","sequenceNumber"],eV=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],eM=["indexId","uid","orderedDocumentKey"],eO=["userId","collectionPath","documentId"],eF=["userId","collectionPath","largestBatchId"],eL=["userId","collectionGroup","largestBatchId"],eP=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],eU=[...eP,"documentOverlays"],eq=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],eB=[...eq,"indexConfiguration","indexState","indexEntries"],ez=[...eB,"globals"];class eK extends et{constructor(e,t){super(),this._e=e,this.currentSequenceNumber=t}}function eG(e,t){return es.F(e._e,t)}function e$(e){let t=0;for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function eQ(e,t){for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function ej(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class eW{constructor(e,t){this.comparator=e,this.root=t||eH.EMPTY}insert(e,t){return new eW(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,eH.BLACK,null,null))}remove(e){return new eW(this.comparator,this.root.remove(e,this.comparator).copy(null,null,eH.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){let r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return -1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,n)=>(e(t,n),!1))}toString(){let e=[];return this.inorderTraversal((t,n)=>(e.push(`${t}:${n}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new eJ(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new eJ(this.root,e,this.comparator,!1)}getReverseIterator(){return new eJ(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new eJ(this.root,e,this.comparator,!0)}}class eJ{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class eH{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:eH.RED,this.left=null!=r?r:eH.EMPTY,this.right=null!=i?i:eH.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new eH(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}removeMin(){if(this.left.isEmpty())return eH.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let n,r=this;if(0>t(e,r.key))r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return eH.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e}rotateLeft(){let e=this.copy(null,null,eH.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,eH.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){return Math.pow(2,this.check())<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw b();let e=this.left.check();if(e!==this.right.check())throw b();return e+ +!this.isRed()}}eH.EMPTY=null,eH.RED=!0,eH.BLACK=!1,eH.EMPTY=new class{constructor(){this.size=0}get key(){throw b()}get value(){throw b()}get color(){throw b()}get left(){throw b()}get right(){throw b()}copy(e,t,n,r,i){return this}insert(e,t,n){return new eH(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class eY{constructor(e){this.comparator=e,this.data=new eW(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,n)=>(e(t),!1))}forEachInRange(e,t){let n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){let r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new eX(this.data.getIterator())}getIteratorFrom(e){return new eX(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof eY)||this.size!==e.size)return!1;let t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new eY(this.comparator);return t.data=e,t}}class eX{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function eZ(e){return e.hasNext()?e.getNext():void 0}class e0{constructor(e){this.fields=e,e.sort(K.comparator)}static empty(){return new e0([])}unionWith(e){let t=new eY(K.comparator);for(let e of this.fields)t=t.add(e);for(let n of e)t=t.add(n);return new e0(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return L(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class e1 extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class e2{constructor(e){this.binaryString=e}static fromBase64String(e){return new e2(function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new e1("Invalid base64 string: "+e):e}}(e))}static fromUint8Array(e){return new e2(function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e))}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return btoa(this.binaryString)}toUint8Array(){var e=this.binaryString;let t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return F(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}e2.EMPTY_BYTE_STRING=new e2("");let e5=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function e4(e){if(e||b(),"string"==typeof e){let t=0,n=e5.exec(e);if(n||b(),n[1]){let e=n[1];t=Number(e=(e+"000000000").substr(0,9))}return{seconds:Math.floor(new Date(e).getTime()/1e3),nanos:t}}return{seconds:e8(e.seconds),nanos:e8(e.nanos)}}function e8(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function e3(e){return"string"==typeof e?e2.fromBase64String(e):e2.fromUint8Array(e)}function e6(e){var t,n;return"server_timestamp"===(null==(n=((null==(t=null==e?void 0:e.mapValue)?void 0:t.fields)||{}).__type__)?void 0:n.stringValue)}function e9(e){let t=e.mapValue.fields.__previous_value__;return e6(t)?e9(t):t}function e7(e){let t=e4(e.mapValue.fields.__local_write_time__.timestampValue);return new P(t.seconds,t.nanos)}class te{constructor(e,t,n,r,i,s,a,o,l){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=l}}class tt{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new tt("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof tt&&e.projectId===this.projectId&&e.database===this.database}}let tn={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},tr={nullValue:"NULL_VALUE"};function ti(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?e6(e)?4:tv(e)?0x1fffffffffffff:ty(e)?10:11:b()}function ts(e,t){if(e===t)return!0;let n=ti(e);if(n!==ti(t))return!1;switch(n){case 0:case 0x1fffffffffffff:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return e7(e).isEqual(e7(t));case 3:if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;let r=e4(e.timestampValue),i=e4(t.timestampValue);return r.seconds===i.seconds&&r.nanos===i.nanos;case 5:return e.stringValue===t.stringValue;case 6:return e3(e.bytesValue).isEqual(e3(t.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return e8(e.geoPointValue.latitude)===e8(t.geoPointValue.latitude)&&e8(e.geoPointValue.longitude)===e8(t.geoPointValue.longitude);case 2:if("integerValue"in e&&"integerValue"in t)return e8(e.integerValue)===e8(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){let n=e8(e.doubleValue),r=e8(t.doubleValue);return n===r?ew(n)===ew(r):isNaN(n)&&isNaN(r)}return!1;case 9:return L(e.arrayValue.values||[],t.arrayValue.values||[],ts);case 10:case 11:let s=e.mapValue.fields||{},a=t.mapValue.fields||{};if(e$(s)!==e$(a))return!1;for(let e in s)if(s.hasOwnProperty(e)&&(void 0===a[e]||!ts(s[e],a[e])))return!1;return!0;default:return b()}}function ta(e,t){return void 0!==(e.values||[]).find(e=>ts(e,t))}function to(e,t){if(e===t)return 0;let n=ti(e),r=ti(t);if(n!==r)return F(n,r);switch(n){case 0:case 0x1fffffffffffff:return 0;case 1:return F(e.booleanValue,t.booleanValue);case 2:let i=e8(e.integerValue||e.doubleValue),s=e8(t.integerValue||t.doubleValue);return i<s?-1:i>s?1:i===s?0:isNaN(i)?isNaN(s)?0:-1:1;case 3:return tl(e.timestampValue,t.timestampValue);case 4:return tl(e7(e),e7(t));case 5:return F(e.stringValue,t.stringValue);case 6:return function(e,t){let n=e3(e),r=e3(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){let n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){let t=F(n[e],r[e]);if(0!==t)return t}return F(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){let n=F(e8(e.latitude),e8(t.latitude));return 0!==n?n:F(e8(e.longitude),e8(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return tu(e.arrayValue,t.arrayValue);case 10:return function(e,t){var n,r,i,s;let a=e.fields||{},o=t.fields||{},l=null==(n=a.value)?void 0:n.arrayValue,u=null==(r=o.value)?void 0:r.arrayValue,h=F((null==(i=null==l?void 0:l.values)?void 0:i.length)||0,(null==(s=null==u?void 0:u.values)?void 0:s.length)||0);return 0!==h?h:tu(l,u)}(e.mapValue,t.mapValue);case 11:return function(e,t){if(e===tn.mapValue&&t===tn.mapValue)return 0;if(e===tn.mapValue)return 1;if(t===tn.mapValue)return -1;let n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let e=0;e<r.length&&e<s.length;++e){let t=F(r[e],s[e]);if(0!==t)return t;let a=to(n[r[e]],i[s[e]]);if(0!==a)return a}return F(r.length,s.length)}(e.mapValue,t.mapValue);default:throw b()}}function tl(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return F(e,t);let n=e4(e),r=e4(t),i=F(n.seconds,r.seconds);return 0!==i?i:F(n.nanos,r.nanos)}function tu(e,t){let n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){let t=to(n[e],r[e]);if(t)return t}return F(n.length,r.length)}function th(e){var t,n;return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){let t=e4(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?e3(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,G.fromName(t).toString()):"geoPointValue"in e?(n=e.geoPointValue,`geo(${n.latitude},${n.longitude})`):"arrayValue"in e?function(e){let t="[",n=!0;for(let r of e.values||[])n?n=!1:t+=",",t+=th(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){let t=Object.keys(e.fields||{}).sort(),n="{",r=!0;for(let i of t)r?r=!1:n+=",",n+=`${i}:${th(e.fields[i])}`;return n+"}"}(e.mapValue):b()}function tc(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function td(e){return!!e&&"integerValue"in e}function tf(e){return!!e&&"arrayValue"in e}function tm(e){return!!e&&"nullValue"in e}function tg(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function tp(e){return!!e&&"mapValue"in e}function ty(e){var t,n;return"__vector__"===(null==(n=((null==(t=null==e?void 0:e.mapValue)?void 0:t.fields)||{}).__type__)?void 0:n.stringValue)}function tw(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){let t={mapValue:{fields:{}}};return eQ(e.mapValue.fields,(e,n)=>t.mapValue.fields[e]=tw(n)),t}if(e.arrayValue){let t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=tw(e.arrayValue.values[n]);return t}return Object.assign({},e)}function tv(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}let tI={mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{}}}}};function t_(e,t){let n=to(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function tT(e,t){let n=to(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class tE{constructor(e){this.value=e}static empty(){return new tE({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(!tp(t=(t.mapValue.fields||{})[e.get(n)]))return null;return(t=(t.mapValue.fields||{})[e.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=tw(t)}setAll(e){let t=K.emptyPath(),n={},r=[];e.forEach((e,i)=>{if(!t.isImmediateParentOf(i)){let e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=i.popLast()}e?n[i.lastSegment()]=tw(e):r.push(i.lastSegment())});let i=this.getFieldsMap(t);this.applyChanges(i,n,r)}delete(e){let t=this.field(e.popLast());tp(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return ts(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];tp(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){for(let r of(eQ(t,(t,n)=>e[t]=n),n))delete e[r]}clone(){return new tE(tw(this.value))}}class tb{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new tb(e,0,U.min(),U.min(),U.min(),tE.empty(),0)}static newFoundDocument(e,t,n,r){return new tb(e,1,t,U.min(),n,r,0)}static newNoDocument(e,t){return new tb(e,2,t,U.min(),U.min(),tE.empty(),0)}static newUnknownDocument(e,t){return new tb(e,3,t,U.min(),U.min(),tE.empty(),2)}convertToFoundDocument(e,t){return this.createTime.isEqual(U.min())&&(2===this.documentType||0===this.documentType)&&(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=tE.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=tE.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=U.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof tb&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new tb(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class tS{constructor(e,t){this.position=e,this.inclusive=t}}function tx(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){let s=t[i],a=e.position[i];if(r=s.field.isKeyField()?G.comparator(G.fromName(a.referenceValue),n.key):to(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function tD(e,t){if(null===e)return null===t;if(null===t||e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!ts(e.position[n],t.position[n]))return!1;return!0}class tC{constructor(e,t="asc"){this.field=e,this.dir=t}}class tN{}class tA extends tN{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new tL(e,t,n):"array-contains"===t?new tB(e,n):"in"===t?new tz(e,n):"not-in"===t?new tK(e,n):"array-contains-any"===t?new tG(e,n):new tA(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new tP(e,n):new tU(e,n)}matches(e){let t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(to(t,this.value)):null!==t&&ti(this.value)===ti(t)&&this.matchesComparison(to(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return b()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class tk extends tN{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new tk(e,t)}matches(e){return tR(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.ae||(this.ae=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}}function tR(e){return"and"===e.op}function tV(e){return"or"===e.op}function tM(e){return tO(e)&&tR(e)}function tO(e){for(let t of e.filters)if(t instanceof tk)return!1;return!0}function tF(e,t){let n=e.filters.concat(t);return tk.create(n,e.op)}class tL extends tA{constructor(e,t,n){super(e,t,n),this.key=G.fromName(n.referenceValue)}matches(e){let t=G.comparator(e.key,this.key);return this.matchesComparison(t)}}class tP extends tA{constructor(e,t){super(e,"in",t),this.keys=tq("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class tU extends tA{constructor(e,t){super(e,"not-in",t),this.keys=tq("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function tq(e,t){var n;return((null==(n=t.arrayValue)?void 0:n.values)||[]).map(e=>G.fromName(e.referenceValue))}class tB extends tA{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return tf(t)&&ta(t.arrayValue,this.value)}}class tz extends tA{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return null!==t&&ta(this.value.arrayValue,t)}}class tK extends tA{constructor(e,t){super(e,"not-in",t)}matches(e){if(ta(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return null!==t&&!ta(this.value.arrayValue,t)}}class tG extends tA{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!tf(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>ta(this.value.arrayValue,e))}}class t${constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.ue=null}}function tQ(e,t=null,n=[],r=[],i=null,s=null,a=null){return new t$(e,t,n,r,i,s,a)}function tj(e){if(null===e.ue){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(e=>(function e(t){if(t instanceof tA)return t.field.canonicalString()+t.op.toString()+th(t.value);if(tM(t))return t.filters.map(t=>e(t)).join(",");{let n=t.filters.map(t=>e(t)).join(",");return`${t.op}(${n})`}})(e)).join(","),t+="|ob:",t+=e.orderBy.map(e=>e.field.canonicalString()+e.dir).join(","),ey(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>th(e)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>th(e)).join(",")),e.ue=t}return e.ue}function tW(e,t){if(e.limit!==t.limit||e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++){var n,r;if(n=e.orderBy[i],r=t.orderBy[i],!(n.dir===r.dir&&n.field.isEqual(r.field)))return!1}if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!function e(t,n){return t instanceof tA?n instanceof tA&&t.op===n.op&&t.field.isEqual(n.field)&&ts(t.value,n.value):t instanceof tk?n instanceof tk&&t.op===n.op&&t.filters.length===n.filters.length&&t.filters.reduce((t,r,i)=>t&&e(r,n.filters[i]),!0):void b()}(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!tD(e.startAt,t.startAt)&&tD(e.endAt,t.endAt)}function tJ(e){return G.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function tH(e,t){return e.filters.filter(e=>e instanceof tA&&e.field.isEqual(t))}function tY(e,t,n){let r=tr,i=!0;for(let n of tH(e,t)){let e=tr,t=!0;switch(n.op){case"<":case"<=":var s;e="nullValue"in(s=n.value)?tr:"booleanValue"in s?{booleanValue:!1}:"integerValue"in s||"doubleValue"in s?{doubleValue:NaN}:"timestampValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in s?{stringValue:""}:"bytesValue"in s?{bytesValue:""}:"referenceValue"in s?tc(tt.empty(),G.empty()):"geoPointValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in s?{arrayValue:{}}:"mapValue"in s?ty(s)?tI:{mapValue:{}}:b();break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=tr}0>t_({value:r,inclusive:i},{value:e,inclusive:t})&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];0>t_({value:r,inclusive:i},{value:e,inclusive:n.inclusive})&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}function tX(e,t,n){let r=tn,i=!0;for(let n of tH(e,t)){let e=tn,t=!0;switch(n.op){case">=":case">":var s;e="nullValue"in(s=n.value)?{booleanValue:!1}:"booleanValue"in s?{doubleValue:NaN}:"integerValue"in s||"doubleValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in s?{stringValue:""}:"stringValue"in s?{bytesValue:""}:"bytesValue"in s?tc(tt.empty(),G.empty()):"referenceValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in s?{arrayValue:{}}:"arrayValue"in s?tI:"mapValue"in s?ty(s)?{mapValue:{}}:tn:b(),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=tn}tT({value:r,inclusive:i},{value:e,inclusive:t})>0&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];tT({value:r,inclusive:i},{value:e,inclusive:n.inclusive})>0&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}class tZ{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}}function t0(e){return new tZ(e)}function t1(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function t2(e){return null!==e.collectionGroup}function t5(e){if(null===e.ce){let t;e.ce=[];let n=new Set;for(let t of e.explicitOrderBy)e.ce.push(t),n.add(t.field.canonicalString());let r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(t=new eY(K.comparator),e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t).forEach(t=>{n.has(t.canonicalString())||t.isKeyField()||e.ce.push(new tC(t,r))}),n.has(K.keyField().canonicalString())||e.ce.push(new tC(K.keyField(),r))}return e.ce}function t4(e){return e.le||(e.le=t8(e,t5(e))),e.le}function t8(e,t){if("F"===e.limitType)return tQ(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{let t="desc"===e.dir?"asc":"desc";return new tC(e.field,t)});let n=e.endAt?new tS(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new tS(e.startAt.position,e.startAt.inclusive):null;return tQ(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}function t3(e,t){let n=e.filters.concat([t]);return new tZ(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function t6(e,t,n){return new tZ(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function t9(e,t){return tW(t4(e),t4(t))&&e.limitType===t.limitType}function t7(e){return`${tj(t4(e))}|lt:${e.limitType}`}function ne(e){var t;let n;return`Query(target=${n=(t=t4(e)).path.canonicalString(),null!==t.collectionGroup&&(n+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(n+=`, filters: [${t.filters.map(e=>(function e(t){return t instanceof tA?`${t.field.canonicalString()} ${t.op} ${th(t.value)}`:t instanceof tk?t.op.toString()+" {"+t.getFilters().map(e).join(" ,")+"}":"Filter"})(e)).join(", ")}]`),ey(t.limit)||(n+=", limit: "+t.limit),t.orderBy.length>0&&(n+=`, orderBy: [${t.orderBy.map(e=>`${e.field.canonicalString()} (${e.dir})`).join(", ")}]`),t.startAt&&(n+=", startAt: ",n+=t.startAt.inclusive?"b:":"a:",n+=t.startAt.position.map(e=>th(e)).join(",")),t.endAt&&(n+=", endAt: ",n+=t.endAt.inclusive?"a:":"b:",n+=t.endAt.position.map(e=>th(e)).join(",")),`Target(${n})`}; limitType=${e.limitType})`}function nt(e,t){return t.isFoundDocument()&&function(e,t){let n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):G.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(let n of t5(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(let n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&(!e.startAt||!!function(e,t,n){let r=tx(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,t5(e),t))&&(!e.endAt||!!function(e,t,n){let r=tx(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,t5(e),t))}function nn(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function nr(e){return(t,n)=>{let r=!1;for(let i of t5(e)){let e=function(e,t,n){let r=e.field.isKeyField()?G.comparator(t.key,n.key):function(e,t,n){let r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?to(r,i):b()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return -1*r;default:return b()}}(i,t,n);if(0!==e)return e;r=r||i.field.isKeyField()}return 0}}class ni{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n){for(let[t,r]of n)if(this.equalsFn(t,e))return r}}has(e){return void 0!==this.get(e)}set(e,t){let n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){eQ(this.inner,(t,n)=>{for(let[t,r]of n)e(t,r)})}isEmpty(){return ej(this.inner)}size(){return this.innerSize}}let ns=new eW(G.comparator),na=new eW(G.comparator);function no(...e){let t=na;for(let n of e)t=t.insert(n.key,n);return t}function nl(e){let t=na;return e.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function nu(){return new ni(e=>e.toString(),(e,t)=>e.isEqual(t))}let nh=new eW(G.comparator),nc=new eY(G.comparator);function nd(...e){let t=nc;for(let n of e)t=t.add(n);return t}let nf=new eY(F);function nm(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ew(t)?"-0":t}}function ng(e){return{integerValue:""+e}}function np(e,t){return ev(t)?ng(t):nm(e,t)}class ny{constructor(){this._=void 0}}function nw(e,t){return e instanceof nb?td(t)||t&&"doubleValue"in t?t:{integerValue:0}:null}class nv extends ny{}class nI extends ny{constructor(e){super(),this.elements=e}}function n_(e,t){let n=nx(t);for(let t of e.elements)n.some(e=>ts(e,t))||n.push(t);return{arrayValue:{values:n}}}class nT extends ny{constructor(e){super(),this.elements=e}}function nE(e,t){let n=nx(t);for(let t of e.elements)n=n.filter(e=>!ts(e,t));return{arrayValue:{values:n}}}class nb extends ny{constructor(e,t){super(),this.serializer=e,this.Pe=t}}function nS(e){return e8(e.integerValue||e.doubleValue)}function nx(e){return tf(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class nD{constructor(e,t){this.field=e,this.transform=t}}class nC{constructor(e,t){this.version=e,this.transformResults=t}}class nN{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new nN}static exists(e){return new nN(void 0,e)}static updateTime(e){return new nN(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function nA(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class nk{}function nR(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new nq(e.key,nN.none()):new nO(e.key,e.data,nN.none());{let n=e.data,r=tE.empty(),i=new eY(K.comparator);for(let e of t.fields)if(!i.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),i=i.add(e)}return new nF(e.key,r,new e0(i.toArray()),nN.none())}}function nV(e,t,n,r){return e instanceof nO?function(e,t,n,r){if(!nA(e.precondition,t))return n;let i=e.value.clone(),s=nU(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof nF?function(e,t,n,r){if(!nA(e.precondition,t))return n;let i=nU(e.fieldTransforms,r,t),s=t.data;return(s.setAll(nL(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n)?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):nA(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}function nM(e,t){var n,r;return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||!(!n||!r)&&L(n,r,(e,t)=>{var n,r;return e.field.isEqual(t.field)&&(n=e.transform,r=t.transform,n instanceof nI&&r instanceof nI||n instanceof nT&&r instanceof nT?L(n.elements,r.elements,ts):n instanceof nb&&r instanceof nb?ts(n.Pe,r.Pe):n instanceof nv&&r instanceof nv)})))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class nO extends nk{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class nF extends nk{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function nL(e){let t=new Map;return e.fieldMask.fields.forEach(n=>{if(!n.isEmpty()){let r=e.data.field(n);t.set(n,r)}}),t}function nP(e,t,n){var r;let i=new Map;e.length===n.length||b();for(let s=0;s<n.length;s++){let a=e[s],o=a.transform,l=t.data.field(a.field);i.set(a.field,(r=n[s],o instanceof nI?n_(o,l):o instanceof nT?nE(o,l):r))}return i}function nU(e,t,n){let r=new Map;for(let i of e){let e=i.transform,s=n.data.field(i.field);r.set(i.field,e instanceof nv?function(e,t){let n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&e6(t)&&(t=e9(t)),t&&(n.fields.__previous_value__=t),{mapValue:n}}(t,s):e instanceof nI?n_(e,s):e instanceof nT?nE(e,s):function(e,t){let n=nw(e,t),r=nS(n)+nS(e.Pe);return td(n)&&td(e.Pe)?ng(r):nm(e.serializer,r)}(e,s))}return r}class nq extends nk{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class nB extends nk{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class nz{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){let n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){let r=this.mutations[t];r.key.isEqual(e.key)&&function(e,t,n){e instanceof nO?function(e,t,n){let r=e.value.clone(),i=nP(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof nF?function(e,t,n){if(!nA(e.precondition,t))return t.convertToUnknownDocument(n.version);let r=nP(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(nL(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):t.convertToNoDocument(n.version).setHasCommittedMutations()}(r,e,n[t])}}applyToLocalView(e,t){for(let n of this.baseMutations)n.key.isEqual(e.key)&&(t=nV(n,e,t,this.localWriteTime));for(let n of this.mutations)n.key.isEqual(e.key)&&(t=nV(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let n=nu();return this.mutations.forEach(r=>{let i=e.get(r.key),s=i.overlayedDocument,a=this.applyToLocalView(s,i.mutatedFields),o=nR(s,a=t.has(r.key)?null:a);null!==o&&n.set(r.key,o),s.isValidDocument()||s.convertToNoDocument(U.min())}),n}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),nd())}isEqual(e){return this.batchId===e.batchId&&L(this.mutations,e.mutations,(e,t)=>nM(e,t))&&L(this.baseMutations,e.baseMutations,(e,t)=>nM(e,t))}}class nK{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){e.mutations.length===n.length||b();let r=nh,i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new nK(e,t,n,r)}}class nG{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class n${constructor(e,t){this.count=e,this.unchangedNames=t}}function nQ(e){switch(e){default:return b();case S.CANCELLED:case S.UNKNOWN:case S.DEADLINE_EXCEEDED:case S.RESOURCE_EXHAUSTED:case S.INTERNAL:case S.UNAVAILABLE:case S.UNAUTHENTICATED:return!1;case S.INVALID_ARGUMENT:case S.NOT_FOUND:case S.ALREADY_EXISTS:case S.PERMISSION_DENIED:case S.FAILED_PRECONDITION:case S.ABORTED:case S.OUT_OF_RANGE:case S.UNIMPLEMENTED:case S.DATA_LOSS:return!0}}function nj(e){if(void 0===e)return _("GRPC error has no .code"),S.UNKNOWN;switch(e){case r.OK:return S.OK;case r.CANCELLED:return S.CANCELLED;case r.UNKNOWN:return S.UNKNOWN;case r.DEADLINE_EXCEEDED:return S.DEADLINE_EXCEEDED;case r.RESOURCE_EXHAUSTED:return S.RESOURCE_EXHAUSTED;case r.INTERNAL:return S.INTERNAL;case r.UNAVAILABLE:return S.UNAVAILABLE;case r.UNAUTHENTICATED:return S.UNAUTHENTICATED;case r.INVALID_ARGUMENT:return S.INVALID_ARGUMENT;case r.NOT_FOUND:return S.NOT_FOUND;case r.ALREADY_EXISTS:return S.ALREADY_EXISTS;case r.PERMISSION_DENIED:return S.PERMISSION_DENIED;case r.FAILED_PRECONDITION:return S.FAILED_PRECONDITION;case r.ABORTED:return S.ABORTED;case r.OUT_OF_RANGE:return S.OUT_OF_RANGE;case r.UNIMPLEMENTED:return S.UNIMPLEMENTED;case r.DATA_LOSS:return S.DATA_LOSS;default:return b()}}(i=r||(r={}))[i.OK=0]="OK",i[i.CANCELLED=1]="CANCELLED",i[i.UNKNOWN=2]="UNKNOWN",i[i.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",i[i.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",i[i.NOT_FOUND=5]="NOT_FOUND",i[i.ALREADY_EXISTS=6]="ALREADY_EXISTS",i[i.PERMISSION_DENIED=7]="PERMISSION_DENIED",i[i.UNAUTHENTICATED=16]="UNAUTHENTICATED",i[i.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",i[i.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",i[i.ABORTED=10]="ABORTED",i[i.OUT_OF_RANGE=11]="OUT_OF_RANGE",i[i.UNIMPLEMENTED=12]="UNIMPLEMENTED",i[i.INTERNAL=13]="INTERNAL",i[i.UNAVAILABLE=14]="UNAVAILABLE",i[i.DATA_LOSS=15]="DATA_LOSS";let nW=new c.jz([0xffffffff,0xffffffff],0);function nJ(e){let t=(new TextEncoder).encode(e),n=new c.VV;return n.update(t),new Uint8Array(n.digest())}function nH(e){let t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new c.jz([n,r],0),new c.jz([i,s],0)]}class nY{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new nX(`Invalid padding: ${t}`);if(n<0||e.length>0&&0===this.hashCount)throw new nX(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new nX(`Invalid padding when bitmap length is 0: ${t}`);this.Ie=8*e.length-t,this.Te=c.jz.fromNumber(this.Ie)}Ee(e,t,n){let r=e.add(t.multiply(c.jz.fromNumber(n)));return 1===r.compare(nW)&&(r=new c.jz([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Te).toNumber()}de(e){return 0!=(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Ie)return!1;let[t,n]=nH(nJ(e));for(let e=0;e<this.hashCount;e++){let r=this.Ee(t,n,e);if(!this.de(r))return!1}return!0}static create(e,t,n){let r=new nY(new Uint8Array(Math.ceil(e/8)),e%8==0?0:8-e%8,t);return n.forEach(e=>r.insert(e)),r}insert(e){if(0===this.Ie)return;let[t,n]=nH(nJ(e));for(let e=0;e<this.hashCount;e++){let r=this.Ee(t,n,e);this.Ae(r)}}Ae(e){let t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class nX extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class nZ{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){let r=new Map;return r.set(e,n0.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new nZ(U.min(),r,new eW(F),ns,nd())}}class n0{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new n0(n,t,nd(),nd(),nd())}}class n1{constructor(e,t,n,r){this.Re=e,this.removedTargetIds=t,this.key=n,this.Ve=r}}class n2{constructor(e,t){this.targetId=e,this.me=t}}class n5{constructor(e,t,n=e2.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class n4{constructor(){this.fe=0,this.ge=n6(),this.pe=e2.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return 0!==this.fe}get be(){return this.we}De(e){e.approximateByteSize()>0&&(this.we=!0,this.pe=e)}ve(){let e=nd(),t=nd(),n=nd();return this.ge.forEach((r,i)=>{switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:b()}}),new n0(this.pe,this.ye,e,t,n)}Ce(){this.we=!1,this.ge=n6()}Fe(e,t){this.we=!0,this.ge=this.ge.insert(e,t)}Me(e){this.we=!0,this.ge=this.ge.remove(e)}xe(){this.fe+=1}Oe(){this.fe-=1,this.fe>=0||b()}Ne(){this.we=!0,this.ye=!0}}class n8{constructor(e){this.Le=e,this.Be=new Map,this.ke=ns,this.qe=n3(),this.Qe=new eW(F)}Ke(e){for(let t of e.Re)e.Ve&&e.Ve.isFoundDocument()?this.$e(t,e.Ve):this.Ue(t,e.key,e.Ve);for(let t of e.removedTargetIds)this.Ue(t,e.key,e.Ve)}We(e){this.forEachTarget(e,t=>{let n=this.Ge(t);switch(e.state){case 0:this.ze(t)&&n.De(e.resumeToken);break;case 1:n.Oe(),n.Se||n.Ce(),n.De(e.resumeToken);break;case 2:n.Oe(),n.Se||this.removeTarget(t);break;case 3:this.ze(t)&&(n.Ne(),n.De(e.resumeToken));break;case 4:this.ze(t)&&(this.je(t),n.De(e.resumeToken));break;default:b()}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Be.forEach((e,n)=>{this.ze(n)&&t(n)})}He(e){let t=e.targetId,n=e.me.count,r=this.Je(t);if(r){let i=r.target;if(tJ(i))if(0===n){let e=new G(i.path);this.Ue(t,e,tb.newNoDocument(e,U.min()))}else 1===n||b();else{let r=this.Ye(t);if(r!==n){let n=this.Ze(e),i=n?this.Xe(n,e,r):1;0!==i&&(this.je(t),this.Qe=this.Qe.insert(t,2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch"))}}}}Ze(e){let t,n,r=e.me.unchangedNames;if(!r||!r.bits)return null;let{bits:{bitmap:i="",padding:s=0},hashCount:a=0}=r;try{t=e3(i).toUint8Array()}catch(e){if(e instanceof e1)return T("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{n=new nY(t,s,a)}catch(e){return T(e instanceof nX?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===n.Ie?null:n}Xe(e,t,n){return 2*(t.me.count!==n-this.nt(e,t.targetId))}nt(e,t){let n=this.Le.getRemoteKeysForTarget(t),r=0;return n.forEach(n=>{let i=this.Le.tt(),s=`projects/${i.projectId}/databases/${i.database}/documents/${n.path.canonicalString()}`;e.mightContain(s)||(this.Ue(t,n,null),r++)}),r}rt(e){let t=new Map;this.Be.forEach((n,r)=>{let i=this.Je(r);if(i){if(n.current&&tJ(i.target)){let t=new G(i.target.path);null!==this.ke.get(t)||this.it(r,t)||this.Ue(r,t,tb.newNoDocument(t,e))}n.be&&(t.set(r,n.ve()),n.Ce())}});let n=nd();this.qe.forEach((e,t)=>{let r=!0;t.forEachWhile(e=>{let t=this.Je(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)}),r&&(n=n.add(e))}),this.ke.forEach((t,n)=>n.setReadTime(e));let r=new nZ(e,t,this.Qe,this.ke,n);return this.ke=ns,this.qe=n3(),this.Qe=new eW(F),r}$e(e,t){if(!this.ze(e))return;let n=2*!!this.it(e,t.key);this.Ge(e).Fe(t.key,n),this.ke=this.ke.insert(t.key,t),this.qe=this.qe.insert(t.key,this.st(t.key).add(e))}Ue(e,t,n){if(!this.ze(e))return;let r=this.Ge(e);this.it(e,t)?r.Fe(t,1):r.Me(t),this.qe=this.qe.insert(t,this.st(t).delete(e)),n&&(this.ke=this.ke.insert(t,n))}removeTarget(e){this.Be.delete(e)}Ye(e){let t=this.Ge(e).ve();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}xe(e){this.Ge(e).xe()}Ge(e){let t=this.Be.get(e);return t||(t=new n4,this.Be.set(e,t)),t}st(e){let t=this.qe.get(e);return t||(t=new eY(F),this.qe=this.qe.insert(e,t)),t}ze(e){let t=null!==this.Je(e);return t||I("WatchChangeAggregator","Detected inactive target",e),t}Je(e){let t=this.Be.get(e);return t&&t.Se?null:this.Le.ot(e)}je(e){this.Be.set(e,new n4),this.Le.getRemoteKeysForTarget(e).forEach(t=>{this.Ue(e,t,null)})}it(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}}function n3(){return new eW(G.comparator)}function n6(){return new eW(G.comparator)}let n9={asc:"ASCENDING",desc:"DESCENDING"},n7={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},re={and:"AND",or:"OR"};class rt{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function rn(e,t){return e.useProto3Json||ey(t)?t:{value:t}}function rr(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function ri(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function rs(e){return e||b(),U.fromTimestamp(function(e){let t=e4(e);return new P(t.seconds,t.nanos)}(e))}function ra(e,t){return ro(e,t).canonicalString()}function ro(e,t){let n=new B(["projects",e.projectId,"databases",e.database]).child("documents");return void 0===t?n:n.child(t)}function rl(e){let t=B.fromString(e);return rb(t)||b(),t}function ru(e,t){return ra(e.databaseId,t.path)}function rh(e,t){let n=rl(t);if(n.get(1)!==e.databaseId.projectId)throw new x(S.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new x(S.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new G(rm(n))}function rc(e,t){return ra(e.databaseId,t)}function rd(e){let t=rl(e);return 4===t.length?B.emptyPath():rm(t)}function rf(e){return new B(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function rm(e){return e.length>4&&"documents"===e.get(4)||b(),e.popFirst(5)}function rg(e,t,n){return{name:ru(e,t),fields:n.value.mapValue.fields}}function rp(e,t,n){let r=rh(e,t.name),i=rs(t.updateTime),s=t.createTime?rs(t.createTime):U.min(),a=new tE({mapValue:{fields:t.fields}}),o=tb.newFoundDocument(r,i,s,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function ry(e,t){var n;let r;if(t instanceof nO)r={update:rg(e,t.key,t.value)};else if(t instanceof nq)r={delete:ru(e,t.key)};else if(t instanceof nF)r={update:rg(e,t.key,t.data),updateMask:function(e){let t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof nB))return b();r={verify:ru(e,t.key)}}return t.fieldTransforms.length>0&&(r.updateTransforms=t.fieldTransforms.map(e=>(function(e,t){let n=t.transform;if(n instanceof nv)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof nI)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof nT)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof nb)return{fieldPath:t.field.canonicalString(),increment:n.Pe};throw b()})(0,e))),t.precondition.isNone||(r.currentDocument=void 0!==(n=t.precondition).updateTime?{updateTime:rr(e,n.updateTime.toTimestamp())}:void 0!==n.exists?{exists:n.exists}:b()),r}function rw(e,t){var n;let r=t.currentDocument?void 0!==(n=t.currentDocument).updateTime?nN.updateTime(rs(n.updateTime)):void 0!==n.exists?nN.exists(n.exists):nN.none():nN.none(),i=t.updateTransforms?t.updateTransforms.map(t=>{var n,r;let i;return n=e,i=null,"setToServerValue"in(r=t)?("REQUEST_TIME"===r.setToServerValue||b(),i=new nv):"appendMissingElements"in r?i=new nI(r.appendMissingElements.values||[]):"removeAllFromArray"in r?i=new nT(r.removeAllFromArray.values||[]):"increment"in r?i=new nb(n,r.increment):b(),new nD(K.fromServerFormat(r.fieldPath),i)}):[];if(t.update){t.update.name;let n=rh(e,t.update.name),s=new tE({mapValue:{fields:t.update.fields}});return t.updateMask?new nF(n,s,new e0((t.updateMask.fieldPaths||[]).map(e=>K.fromServerFormat(e))),r,i):new nO(n,s,r,i)}return t.delete?new nq(rh(e,t.delete),r):t.verify?new nB(rh(e,t.verify),r):b()}function rv(e,t){return{documents:[rc(e,t.path)]}}function rI(e,t){var n,r;let i,s={structuredQuery:{}},a=t.path;null!==t.collectionGroup?(i=a,s.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=a.popLast(),s.structuredQuery.from=[{collectionId:a.lastSegment()}]),s.parent=rc(e,i);let o=function(e){if(0!==e.length)return function e(t){return t instanceof tA?function(e){if("=="===e.op){if(tg(e.value))return{unaryFilter:{field:rT(e.field),op:"IS_NAN"}};if(tm(e.value))return{unaryFilter:{field:rT(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(tg(e.value))return{unaryFilter:{field:rT(e.field),op:"IS_NOT_NAN"}};if(tm(e.value))return{unaryFilter:{field:rT(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:rT(e.field),op:n7[e.op],value:e.value}}}(t):t instanceof tk?function(t){let n=t.getFilters().map(t=>e(t));return 1===n.length?n[0]:{compositeFilter:{op:re[t.op],filters:n}}}(t):b()}(tk.create(e,"and"))}(t.filters);o&&(s.structuredQuery.where=o);let l=function(e){if(0!==e.length)return e.map(e=>({field:rT(e.field),direction:n9[e.dir]}))}(t.orderBy);l&&(s.structuredQuery.orderBy=l);let u=rn(e,t.limit);return null!==u&&(s.structuredQuery.limit=u),t.startAt&&(s.structuredQuery.startAt={before:(n=t.startAt).inclusive,values:n.position}),t.endAt&&(s.structuredQuery.endAt={before:!(r=t.endAt).inclusive,values:r.position}),{_t:s,parent:i}}function r_(e){var t;let n,r=rd(e.parent),i=e.structuredQuery,s=i.from?i.from.length:0,a=null;if(s>0){1===s||b();let e=i.from[0];e.allDescendants?a=e.collectionId:r=r.child(e.collectionId)}let o=[];i.where&&(o=function(e){let t=function e(t){return void 0!==t.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":let t=rE(e.unaryFilter.field);return tA.create(t,"==",{doubleValue:NaN});case"IS_NULL":let n=rE(e.unaryFilter.field);return tA.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let r=rE(e.unaryFilter.field);return tA.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let i=rE(e.unaryFilter.field);return tA.create(i,"!=",{nullValue:"NULL_VALUE"});default:return b()}}(t):void 0!==t.fieldFilter?tA.create(rE(t.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return b()}}(t.fieldFilter.op),t.fieldFilter.value):void 0!==t.compositeFilter?tk.create(t.compositeFilter.filters.map(t=>e(t)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return b()}}(t.compositeFilter.op)):b()}(e);return t instanceof tk&&tM(t)?t.getFilters():[t]}(i.where));let l=[];i.orderBy&&(l=i.orderBy.map(e=>new tC(rE(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))));let u=null;i.limit&&(u=ey(n="object"==typeof(t=i.limit)?t.value:t)?null:n);let h=null;i.startAt&&(h=function(e){let t=!!e.before;return new tS(e.values||[],t)}(i.startAt));let c=null;return i.endAt&&(c=function(e){let t=!e.before;return new tS(e.values||[],t)}(i.endAt)),new tZ(r,a,l,o,u,"F",h,c)}function rT(e){return{fieldPath:e.canonicalString()}}function rE(e){return K.fromServerFormat(e.fieldPath)}function rb(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class rS{constructor(e,t,n,r,i=U.min(),s=U.min(),a=e2.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new rS(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new rS(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new rS(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new rS(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class rx{constructor(e){this.ct=e}}function rD(e,t){let n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:rC(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument()){var i;r.document={name:ru(i=e.ct,t.key),fields:t.data.value.mapValue.fields,updateTime:rr(i,t.version.toTimestamp()),createTime:rr(i,t.createTime.toTimestamp())}}else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:rN(t.version)};else{if(!t.isUnknownDocument())return b();r.unknownDocument={path:n.path.toArray(),version:rN(t.version)}}return r}function rC(e){let t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function rN(e){let t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function rA(e){let t=new P(e.seconds,e.nanoseconds);return U.fromTimestamp(t)}function rk(e,t){let n=(t.baseMutations||[]).map(t=>rw(e.ct,t));for(let e=0;e<t.mutations.length-1;++e){let n=t.mutations[e];e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform&&(n.updateTransforms=t.mutations[e+1].transform.fieldTransforms,t.mutations.splice(e+1,1),++e)}let r=t.mutations.map(t=>rw(e.ct,t)),i=P.fromMillis(t.localWriteTimeMs);return new nz(t.batchId,i,n,r)}function rR(e){var t;let n=rA(e.readTime),r=void 0!==e.lastLimboFreeSnapshotVersion?rA(e.lastLimboFreeSnapshotVersion):U.min();return new rS(void 0!==e.query.documents?(1===(t=e.query).documents.length||b(),t4(t0(rd(t.documents[0])))):t4(r_(e.query)),e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,n,r,e2.fromBase64String(e.resumeToken))}function rV(e,t){let n,r=rN(t.snapshotVersion),i=rN(t.lastLimboFreeSnapshotVersion);n=tJ(t.target)?rv(e.ct,t.target):rI(e.ct,t.target)._t;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:tj(t.target),readTime:r,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:i,query:n}}function rM(e){let t=r_({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?t6(t,t.limit,"L"):t}function rO(e,t){return new nG(t.largestBatchId,rw(e.ct,t.overlayMutation))}function rF(e,t){let n=t.path.lastSegment();return[e,eI(t.path.popLast()),n]}function rL(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:rN(r.readTime),documentKey:eI(r.documentKey.path),largestBatchId:r.largestBatchId}}class rP{getBundleMetadata(e,t){return rU(e).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:rA(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return rU(e).put({bundleId:t.id,createTime:rN(rs(t.createTime)),version:t.version})}getNamedQuery(e,t){return rq(e).get(t).next(e=>{if(e)return{name:e.name,query:rM(e.bundledQuery),readTime:rA(e.readTime)}})}saveNamedQuery(e,t){return rq(e).put({name:t.name,readTime:rN(rs(t.readTime)),bundledQuery:t.bundledQuery})}}function rU(e){return eG(e,"bundles")}function rq(e){return eG(e,"namedQueries")}class rB{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){return new rB(e,t.uid||"")}getOverlay(e,t){return rz(e).get(rF(this.userId,t)).next(e=>e?rO(this.serializer,e):null)}getOverlays(e,t){let n=nu();return er.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){let r=[];return n.forEach((n,i)=>{let s=new nG(t,i);r.push(this.ht(e,s))}),er.waitFor(r)}removeOverlaysForBatchId(e,t,n){let r=new Set;t.forEach(e=>r.add(eI(e.getCollectionPath())));let i=[];return r.forEach(t=>{let r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);i.push(rz(e).j("collectionPathOverlayIndex",r))}),er.waitFor(i)}getOverlaysForCollection(e,t,n){let r=nu(),i=eI(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return rz(e).U("collectionPathOverlayIndex",s).next(e=>{for(let t of e){let e=rO(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,r){let i,s=nu(),a=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return rz(e).J({index:"collectionGroupOverlayIndex",range:a},(e,t,n)=>{let a=rO(this.serializer,t);s.size()<r||a.largestBatchId===i?(s.set(a.getKey(),a),i=a.largestBatchId):n.done()}).next(()=>s)}ht(e,t){return rz(e).put(function(e,t,n){let[r,i,s]=rF(t,n.mutation.key);return{userId:t,collectionPath:i,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:ry(e.ct,n.mutation)}}(this.serializer,this.userId,t))}}function rz(e){return eG(e,"documentOverlays")}class rK{Pt(e){return eG(e,"globals")}getSessionToken(e){return this.Pt(e).get("sessionToken").next(e=>{let t=null==e?void 0:e.value;return t?e2.fromUint8Array(t):e2.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.Pt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class rG{constructor(){}It(e,t){this.Tt(e,t),t.Et()}Tt(e,t){if("nullValue"in e)this.dt(t,5);else if("booleanValue"in e)this.dt(t,10),t.At(+!!e.booleanValue);else if("integerValue"in e)this.dt(t,15),t.At(e8(e.integerValue));else if("doubleValue"in e){let n=e8(e.doubleValue);isNaN(n)?this.dt(t,13):(this.dt(t,15),ew(n)?t.At(0):t.At(n))}else if("timestampValue"in e){let n=e.timestampValue;this.dt(t,20),"string"==typeof n&&(n=e4(n)),t.Rt(`${n.seconds||""}`),t.At(n.nanos||0)}else if("stringValue"in e)this.Vt(e.stringValue,t),this.ft(t);else if("bytesValue"in e)this.dt(t,30),t.gt(e3(e.bytesValue)),this.ft(t);else if("referenceValue"in e)this.yt(e.referenceValue,t);else if("geoPointValue"in e){let n=e.geoPointValue;this.dt(t,45),t.At(n.latitude||0),t.At(n.longitude||0)}else"mapValue"in e?tv(e)?this.dt(t,Number.MAX_SAFE_INTEGER):ty(e)?this.wt(e.mapValue,t):(this.St(e.mapValue,t),this.ft(t)):"arrayValue"in e?(this.bt(e.arrayValue,t),this.ft(t)):b()}Vt(e,t){this.dt(t,25),this.Dt(e,t)}Dt(e,t){t.Rt(e)}St(e,t){let n=e.fields||{};for(let e of(this.dt(t,55),Object.keys(n)))this.Vt(e,t),this.Tt(n[e],t)}wt(e,t){var n,r;let i=e.fields||{};this.dt(t,53);let s="value",a=(null==(r=null==(n=i[s].arrayValue)?void 0:n.values)?void 0:r.length)||0;this.dt(t,15),t.At(e8(a)),this.Vt(s,t),this.Tt(i[s],t)}bt(e,t){let n=e.values||[];for(let e of(this.dt(t,50),n))this.Tt(e,t)}yt(e,t){this.dt(t,37),G.fromName(e).path.forEach(e=>{this.dt(t,60),this.Dt(e,t)})}dt(e,t){e.At(t)}ft(e){e.At(2)}}function r$(e){return Math.ceil((64-function(e){let t=0;for(let n=0;n<8;++n){let r=function(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}(255&e[n]);if(t+=r,8!==r)break}return t}(e))/8)}rG.vt=new rG;class rQ{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ct(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.Ft(n.value),n=t.next();this.Mt()}xt(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.Ot(n.value),n=t.next();this.Nt()}Lt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Ft(e);else if(e<2048)this.Ft(960|e>>>6),this.Ft(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ft(480|e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e);else{let e=t.codePointAt(0);this.Ft(240|e>>>18),this.Ft(128|63&e>>>12),this.Ft(128|63&e>>>6),this.Ft(128|63&e)}}this.Mt()}Bt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Ot(e);else if(e<2048)this.Ot(960|e>>>6),this.Ot(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ot(480|e>>>12),this.Ot(128|63&e>>>6),this.Ot(128|63&e);else{let e=t.codePointAt(0);this.Ot(240|e>>>18),this.Ot(128|63&e>>>12),this.Ot(128|63&e>>>6),this.Ot(128|63&e)}}this.Nt()}kt(e){let t=this.qt(e),n=r$(t);this.Qt(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}Kt(e){let t=this.qt(e),n=r$(t);this.Qt(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}$t(){this.Ut(255),this.Ut(255)}Wt(){this.Gt(255),this.Gt(255)}reset(){this.position=0}seed(e){this.Qt(e.length),this.buffer.set(e,this.position),this.position+=e.length}zt(){return this.buffer.slice(0,this.position)}qt(e){let t=function(e){let t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=255*!!n;return t}Ft(e){let t=255&e;0===t?(this.Ut(0),this.Ut(255)):255===t?(this.Ut(255),this.Ut(0)):this.Ut(t)}Ot(e){let t=255&e;0===t?(this.Gt(0),this.Gt(255)):255===t?(this.Gt(255),this.Gt(0)):this.Gt(e)}Mt(){this.Ut(0),this.Ut(1)}Nt(){this.Gt(0),this.Gt(1)}Ut(e){this.Qt(1),this.buffer[this.position++]=e}Gt(e){this.Qt(1),this.buffer[this.position++]=~e}Qt(e){let t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);let r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class rj{constructor(e){this.jt=e}gt(e){this.jt.Ct(e)}Rt(e){this.jt.Lt(e)}At(e){this.jt.kt(e)}Et(){this.jt.$t()}}class rW{constructor(e){this.jt=e}gt(e){this.jt.xt(e)}Rt(e){this.jt.Bt(e)}At(e){this.jt.Kt(e)}Et(){this.jt.Wt()}}class rJ{constructor(){this.jt=new rQ,this.Ht=new rj(this.jt),this.Jt=new rW(this.jt)}seed(e){this.jt.seed(e)}Yt(e){return 0===e?this.Ht:this.Jt}zt(){return this.jt.zt()}reset(){this.jt.reset()}}class rH{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Zt(){let e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new rH(this.indexId,this.documentKey,this.arrayValue,n)}}function rY(e,t){let n=e.indexId-t.indexId;return 0!==n||0!==(n=rX(e.arrayValue,t.arrayValue))||0!==(n=rX(e.directionalValue,t.directionalValue))?n:G.comparator(e.documentKey,t.documentKey)}function rX(e,t){for(let n=0;n<e.length&&n<t.length;++n){let r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}class rZ{constructor(e){for(let t of(this.Xt=new eY((e,t)=>K.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.en=e.orderBy,this.tn=[],e.filters))t.isInequality()?this.Xt=this.Xt.add(t):this.tn.push(t)}get nn(){return this.Xt.size>1}rn(e){if(e.collectionGroup===this.collectionId||b(),this.nn)return!1;let t=Q(e);if(void 0!==t&&!this.sn(t))return!1;let n=j(e),r=new Set,i=0,s=0;for(;i<n.length&&this.sn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(this.Xt.size>0){let e=this.Xt.getIterator().getNext();if(!r.has(e.field.canonicalString())){let t=n[i];if(!this.on(e,t)||!this._n(this.en[s++],t))return!1}++i}for(;i<n.length;++i){let e=n[i];if(s>=this.en.length||!this._n(this.en[s++],e))return!1}return!0}an(){if(this.nn)return null;let e=new eY(K.comparator),t=[];for(let n of this.tn)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new W(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new W(n.field,0))}for(let n of this.en)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new W(n.field,+("asc"!==n.dir))));return new $($.UNKNOWN_ID,this.collectionId,t,J.empty())}sn(e){for(let t of this.tn)if(this.on(t,e))return!0;return!1}on(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;let n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}_n(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function r0(e){return e instanceof tA}function r1(e){return e instanceof tk&&tM(e)}function r2(e){return r0(e)||r1(e)||function(e){if(e instanceof tk&&tV(e)){for(let t of e.getFilters())if(!r0(t)&&!r1(t))return!1;return!0}return!1}(e)}function r5(e,t){return e instanceof tA||e instanceof tk||b(),t instanceof tA||t instanceof tk||b(),r8(e instanceof tA?t instanceof tA?tk.create([e,t],"and"):r4(e,t):t instanceof tA?r4(t,e):function(e,t){if(e.filters.length>0&&t.filters.length>0||b(),tR(e)&&tR(t))return tF(e,t.getFilters());let n=tV(e)?e:t,r=tV(e)?t:e,i=n.filters.map(e=>r5(e,r));return tk.create(i,"or")}(e,t))}function r4(e,t){if(tR(t))return tF(t,e.getFilters());{let n=t.filters.map(t=>r5(e,t));return tk.create(n,"or")}}function r8(e){if(e instanceof tA||e instanceof tk||b(),e instanceof tA)return e;let t=e.getFilters();if(1===t.length)return r8(t[0]);if(tO(e))return e;let n=t.map(e=>r8(e)),r=[];return n.forEach(t=>{t instanceof tA?r.push(t):t instanceof tk&&(t.op===e.op?r.push(...t.filters):r.push(t))}),1===r.length?r[0]:tk.create(r,e.op)}class r3{constructor(){this.un=new r6}addToCollectionParentIndex(e,t){return this.un.add(t),er.resolve()}getCollectionParents(e,t){return er.resolve(this.un.getEntries(t))}addFieldIndex(e,t){return er.resolve()}deleteFieldIndex(e,t){return er.resolve()}deleteAllFieldIndexes(e){return er.resolve()}createTargetIndexes(e,t){return er.resolve()}getDocumentsMatchingTarget(e,t){return er.resolve(null)}getIndexType(e,t){return er.resolve(0)}getFieldIndexes(e,t){return er.resolve([])}getNextCollectionGroupToUpdate(e){return er.resolve(null)}getMinOffset(e,t){return er.resolve(X.min())}getMinOffsetFromCollectionGroup(e,t){return er.resolve(X.min())}updateCollectionGroup(e,t,n){return er.resolve()}updateIndexEntries(e,t){return er.resolve()}}class r6{constructor(){this.index={}}add(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new eY(B.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new eY(B.comparator)).toArray()}}let r9=new Uint8Array(0);class r7{constructor(e,t){this.databaseId=t,this.cn=new r6,this.ln=new ni(e=>tj(e),(e,t)=>tW(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.cn.has(t)){let n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.cn.add(t)});let i={collectionId:n,parent:eI(r)};return ie(e).put(i)}return er.resolve()}getCollectionParents(e,t){let n=[],r=IDBKeyRange.bound([t,""],[t+"\0",""],!1,!0);return ie(e).U(r).next(e=>{for(let r of e){if(r.collectionId!==t)break;n.push(e_(r.parent))}return n})}addFieldIndex(e,t){let n=ir(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;let i=n.add(r);if(t.indexState){let n=ii(e);return i.next(e=>{n.put(rL(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){let n=ir(e),r=ii(e),i=it(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=ir(e),n=it(e),r=ii(e);return t.j().next(()=>n.j()).next(()=>r.j())}createTargetIndexes(e,t){return er.forEach(this.hn(t),t=>this.getIndexType(e,t).next(n=>{if(0===n||1===n){let n=new rZ(t).an();if(null!=n)return this.addFieldIndex(e,n)}}))}getDocumentsMatchingTarget(e,t){let n=it(e),r=!0,i=new Map;return er.forEach(this.hn(t),t=>this.Pn(e,t).next(e=>{r&&(r=!!e),i.set(t,e)})).next(()=>{if(r){let e=nd(),r=[];return er.forEach(i,(i,s)=>{I("IndexedDbIndexManager",`Using index id=${i.indexId}|cg=${i.collectionGroup}|f=${i.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")} to execute ${tj(t)}`);let a=function(e,t){let n=Q(t);if(void 0===n)return null;for(let t of tH(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(s,i),o=function(e,t){let n=new Map;for(let r of j(t))for(let t of tH(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(s,i),l=function(e,t){let n=[],r=!0;for(let i of j(t)){let t=0===i.kind?tY(e,i.fieldPath,e.startAt):tX(e,i.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new tS(n,r)}(s,i),u=function(e,t){let n=[],r=!0;for(let i of j(t)){let t=0===i.kind?tX(e,i.fieldPath,e.endAt):tY(e,i.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new tS(n,r)}(s,i),h=this.In(i,s,l),c=this.In(i,s,u),d=this.Tn(i,s,o),f=this.En(i.indexId,a,h,l.inclusive,c,u.inclusive,d);return er.forEach(f,i=>n.G(i,t.limit).next(t=>{t.forEach(t=>{let n=G.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))})}))}).next(()=>r)}return er.resolve(null)})}hn(e){let t=this.ln.get(e);return t||(t=0===e.filters.length?[e]:(function(e){if(0===e.getFilters().length)return[];let t=function e(t){if(t instanceof tA||t instanceof tk||b(),t instanceof tA)return t;if(1===t.filters.length)return e(t.filters[0]);let n=t.filters.map(t=>e(t)),r=tk.create(n,t.op);return r2(r=r8(r))?r:(r instanceof tk||b(),tR(r)||b(),r.filters.length>1||b(),r.filters.reduce((e,t)=>r5(e,t)))}(function e(t){var n,r;if(t instanceof tA||t instanceof tk||b(),t instanceof tA){if(t instanceof tz){let e=(null==(r=null==(n=t.value.arrayValue)?void 0:n.values)?void 0:r.map(e=>tA.create(t.field,"==",e)))||[];return tk.create(e,"or")}return t}let i=t.filters.map(t=>e(t));return tk.create(i,t.op)}(e));return r2(t)||b(),r0(t)||r1(t)?[t]:t.getFilters()})(tk.create(e.filters,"and")).map(t=>tQ(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt)),this.ln.set(e,t)),t}En(e,t,n,r,i,s,a){let o=(null!=t?t.length:1)*Math.max(n.length,i.length),l=o/(null!=t?t.length:1),u=[];for(let h=0;h<o;++h){let o=t?this.dn(t[h/l]):r9,c=this.An(e,o,n[h%l],r),d=this.Rn(e,o,i[h%l],s),f=a.map(t=>this.An(e,o,t,!0));u.push(...this.createRange(c,d,f))}return u}An(e,t,n,r){let i=new rH(e,G.empty(),t,n);return r?i:i.Zt()}Rn(e,t,n,r){let i=new rH(e,G.empty(),t,n);return r?i.Zt():i}Pn(e,t){let n=new rZ(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next(e=>{let t=null;for(let r of e)n.rn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t})}getIndexType(e,t){let n=2,r=this.hn(t);return er.forEach(r,t=>this.Pn(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new eY(K.comparator),n=!1;for(let r of e.filters)for(let e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(let n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+ +!!n}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&r.length>1&&2===n?1:n)}Vn(e,t){let n=new rJ;for(let r of j(e)){let e=t.data.field(r.fieldPath);if(null==e)return null;let i=n.Yt(r.kind);rG.vt.It(e,i)}return n.zt()}dn(e){let t=new rJ;return rG.vt.It(e,t.Yt(0)),t.zt()}mn(e,t){let n=new rJ;return rG.vt.It(tc(this.databaseId,t),n.Yt(function(e){let t=j(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.zt()}Tn(e,t,n){if(null===n)return[];let r=[];r.push(new rJ);let i=0;for(let s of j(e)){let e=n[i++];for(let n of r)if(this.fn(t,s.fieldPath)&&tf(e))r=this.gn(r,s,e);else{let t=n.Yt(s.kind);rG.vt.It(e,t)}}return this.pn(r)}In(e,t,n){return this.Tn(e,t,n.position)}pn(e){let t=[];for(let n=0;n<e.length;++n)t[n]=e[n].zt();return t}gn(e,t,n){let r=[...e],i=[];for(let e of n.arrayValue.values||[])for(let n of r){let r=new rJ;r.seed(n.zt()),rG.vt.It(e,r.Yt(t.kind)),i.push(r)}return i}fn(e,t){return!!e.filters.find(e=>e instanceof tA&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){let n=ir(e),r=ii(e);return(t?n.U("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.U()).next(e=>{let t=[];return er.forEach(e,e=>r.get([e.indexId,this.uid]).next(n=>{t.push(function(e,t){let n=t?new J(t.sequenceNumber,new X(rA(t.readTime),new G(e_(t.documentKey)),t.largestBatchId)):J.empty(),r=e.fields.map(([e,t])=>new W(K.fromServerFormat(e),t));return new $(e.indexId,e.collectionGroup,r,n)}(e,n))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{let n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:F(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,n){let r=ir(e),i=ii(e);return this.yn(e).next(e=>r.U("collectionGroupIndex",IDBKeyRange.bound(t,t)).next(t=>er.forEach(t,t=>i.put(rL(t.indexId,this.uid,e,n)))))}updateIndexEntries(e,t){let n=new Map;return er.forEach(t,(t,r)=>{let i=n.get(t.collectionGroup);return(i?er.resolve(i):this.getFieldIndexes(e,t.collectionGroup)).next(i=>(n.set(t.collectionGroup,i),er.forEach(i,n=>this.wn(e,t,n).next(t=>{let i=this.Sn(r,n);return t.isEqual(i)?er.resolve():this.bn(e,r,n,t,i)}))))})}Dn(e,t,n,r){return it(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.mn(n,t.key),documentKey:t.key.path.toArray()})}vn(e,t,n,r){return it(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.mn(n,t.key),t.key.path.toArray()])}wn(e,t,n){let r=it(e),i=new eY(rY);return r.J({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.mn(n,t)])},(e,r)=>{i=i.add(new rH(n.indexId,t,r.arrayValue,r.directionalValue))}).next(()=>i)}Sn(e,t){let n=new eY(rY),r=this.Vn(t,e);if(null==r)return n;let i=Q(t);if(null!=i){let s=e.data.field(i.fieldPath);if(tf(s))for(let i of s.arrayValue.values||[])n=n.add(new rH(t.indexId,e.key,this.dn(i),r))}else n=n.add(new rH(t.indexId,e.key,r9,r));return n}bn(e,t,n,r,i){I("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);let s=[];return function(e,t,n,r,i){let s=e.getIterator(),a=t.getIterator(),o=eZ(s),l=eZ(a);for(;o||l;){let e=!1,t=!1;if(o&&l){let r=n(o,l);r<0?t=!0:r>0&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(l),l=eZ(a)):t?(i(o),o=eZ(s)):(o=eZ(s),l=eZ(a))}}(r,i,rY,r=>{s.push(this.Dn(e,t,n,r))},r=>{s.push(this.vn(e,t,n,r))}),er.waitFor(s)}yn(e){let t=1;return ii(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,n,r)=>{r.done(),t=n.sequenceNumber+1}).next(()=>t)}createRange(e,t,n){n=n.sort((e,t)=>rY(e,t)).filter((e,t,n)=>!t||0!==rY(e,n[t-1]));let r=[];for(let i of(r.push(e),n)){let n=rY(i,e),s=rY(i,t);if(0===n)r[0]=e.Zt();else if(n>0&&s<0)r.push(i),r.push(i.Zt());else if(s>0)break}r.push(t);let i=[];for(let e=0;e<r.length;e+=2){if(this.Cn(r[e],r[e+1]))return[];let t=[r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,r9,[]],n=[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,r9,[]];i.push(IDBKeyRange.bound(t,n))}return i}Cn(e,t){return rY(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(is)}getMinOffset(e,t){return er.mapArray(this.hn(t),t=>this.Pn(e,t).next(e=>e||b())).next(is)}}function ie(e){return eG(e,"collectionParents")}function it(e){return eG(e,"indexEntries")}function ir(e){return eG(e,"indexConfiguration")}function ii(e){return eG(e,"indexState")}function is(e){0!==e.length||b();let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){let i=e[r].indexState.offset;0>Z(i,t)&&(t=i),n<i.largestBatchId&&(n=i.largestBatchId)}return new X(t.readTime,t.documentKey,n)}let ia={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class io{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new io(e,io.DEFAULT_COLLECTION_PERCENTILE,io.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function il(e,t,n){let r=e.store("mutations"),i=e.store("documentMutations"),s=[],a=IDBKeyRange.only(n.batchId),o=0,l=r.J({range:a},(e,t,n)=>(o++,n.delete()));s.push(l.next(()=>{1===o||b()}));let u=[];for(let e of n.mutations){var h,c;let r=(h=e.key.path,c=n.batchId,[t,eI(h),c]);s.push(i.delete(r)),u.push(e.key)}return er.waitFor(s).next(()=>u)}function iu(e){let t;if(!e)return 0;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw b();t=e.noDocument}return JSON.stringify(t).length}io.DEFAULT_COLLECTION_PERCENTILE=10,io.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,io.DEFAULT=new io(0x2800000,io.DEFAULT_COLLECTION_PERCENTILE,io.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),io.DISABLED=new io(-1,0,0);class ih{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Fn={}}static lt(e,t,n,r){return""!==e.uid||b(),new ih(e.isAuthenticated()?e.uid:"",t,n,r)}checkEmpty(e){let t=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return id(e).J({index:"userMutationsIndex",range:n},(e,n,r)=>{t=!1,r.done()}).next(()=>t)}addMutationBatch(e,t,n,r){let i=im(e),s=id(e);return s.add({}).next(a=>{var o,l;"number"==typeof a||b();let u=new nz(a,t,n,r),h=function(e,t,n){let r=n.baseMutations.map(t=>ry(e.ct,t)),i=n.mutations.map(t=>ry(e.ct,t));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:i}}(this.serializer,this.userId,u),c=[],d=new eY((e,t)=>F(e.canonicalString(),t.canonicalString()));for(let e of r){let t=(o=this.userId,l=e.key.path,[o,eI(l),a]);d=d.add(e.key.path.popLast()),c.push(s.put(h)),c.push(i.put(t,eE))}return d.forEach(t=>{c.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.Fn[a]=u.keys()}),er.waitFor(c).next(()=>u)})}lookupMutationBatch(e,t){return id(e).get(t).next(e=>e?(e.userId===this.userId||b(),rk(this.serializer,e)):null)}Mn(e,t){return this.Fn[t]?er.resolve(this.Fn[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){let n=e.keys();return this.Fn[t]=n,n}return null})}getNextMutationBatchAfterBatchId(e,t){let n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]),i=null;return id(e).J({index:"userMutationsIndex",range:r},(e,t,r)=>{t.userId===this.userId&&(t.batchId>=n||b(),i=rk(this.serializer,t)),r.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=-1;return id(e).J({index:"userMutationsIndex",range:t,reverse:!0},(e,t,r)=>{n=t.batchId,r.done()}).next(()=>n)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return id(e).U("userMutationsIndex",t).next(e=>e.map(e=>rk(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){let n=[this.userId,eI(t.path)],r=IDBKeyRange.lowerBound(n),i=[];return im(e).J({range:r},(n,r,s)=>{let[a,o,l]=n,u=e_(o);if(a===this.userId&&t.path.isEqual(u))return id(e).get(l).next(e=>{if(!e)throw b();e.userId===this.userId||b(),i.push(rk(this.serializer,e))});s.done()}).next(()=>i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new eY(F),r=[];return t.forEach(t=>{let i=[this.userId,eI(t.path)],s=IDBKeyRange.lowerBound(i),a=im(e).J({range:s},(e,r,i)=>{let[s,a,o]=e,l=e_(a);s===this.userId&&t.path.isEqual(l)?n=n.add(o):i.done()});r.push(a)}),er.waitFor(r).next(()=>this.xn(e,n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=[this.userId,eI(n)],s=IDBKeyRange.lowerBound(i),a=new eY(F);return im(e).J({range:s},(e,t,i)=>{let[s,o,l]=e,u=e_(o);s===this.userId&&n.isPrefixOf(u)?u.length===r&&(a=a.add(l)):i.done()}).next(()=>this.xn(e,a))}xn(e,t){let n=[],r=[];return t.forEach(t=>{r.push(id(e).get(t).next(e=>{if(null===e)throw b();e.userId===this.userId||b(),n.push(rk(this.serializer,e))}))}),er.waitFor(r).next(()=>n)}removeMutationBatch(e,t){return il(e._e,this.userId,t).next(n=>(e.addOnCommittedListener(()=>{this.On(t.batchId)}),er.forEach(n,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}On(e){delete this.Fn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return er.resolve();let n=IDBKeyRange.lowerBound([this.userId]),r=[];return im(e).J({range:n},(e,t,n)=>{if(e[0]===this.userId){let t=e_(e[1]);r.push(t)}else n.done()}).next(()=>{0===r.length||b()})})}containsKey(e,t){return ic(e,this.userId,t)}Nn(e){return ig(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function ic(e,t,n){let r=[t,eI(n.path)],i=r[1],s=IDBKeyRange.lowerBound(r),a=!1;return im(e).J({range:s,H:!0},(e,n,r)=>{let[s,o,l]=e;s===t&&o===i&&(a=!0),r.done()}).next(()=>a)}function id(e){return eG(e,"mutations")}function im(e){return eG(e,"documentMutations")}function ig(e){return eG(e,"mutationQueues")}class ip{constructor(e){this.Ln=e}next(){return this.Ln+=2,this.Ln}static Bn(){return new ip(0)}static kn(){return new ip(-1)}}class iy{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.qn(e).next(t=>{let n=new ip(t.highestTargetId);return t.highestTargetId=n.next(),this.Qn(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.qn(e).next(e=>U.fromTimestamp(new P(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.qn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,n){return this.qn(e).next(r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.Qn(e,r)))}addTargetData(e,t){return this.Kn(e,t).next(()=>this.qn(e).next(n=>(n.targetCount+=1,this.$n(t,n),this.Qn(e,n))))}updateTargetData(e,t){return this.Kn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>iw(e).delete(t.targetId)).next(()=>this.qn(e)).next(t=>(t.targetCount>0||b(),t.targetCount-=1,this.Qn(e,t)))}removeTargets(e,t,n){let r=0,i=[];return iw(e).J((s,a)=>{let o=rR(a);o.sequenceNumber<=t&&null===n.get(o.targetId)&&(r++,i.push(this.removeTargetData(e,o)))}).next(()=>er.waitFor(i)).next(()=>r)}forEachTarget(e,t){return iw(e).J((e,n)=>{t(rR(n))})}qn(e){return iv(e).get("targetGlobalKey").next(e=>(null!==e||b(),e))}Qn(e,t){return iv(e).put("targetGlobalKey",t)}Kn(e,t){return iw(e).put(rV(this.serializer,t))}$n(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.qn(e).next(e=>e.targetCount)}getTargetData(e,t){let n=tj(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]),i=null;return iw(e).J({range:r,index:"queryTargetsIndex"},(e,n,r)=>{let s=rR(n);tW(t,s.target)&&(i=s,r.done())}).next(()=>i)}addMatchingKeys(e,t,n){let r=[],i=iI(e);return t.forEach(t=>{let s=eI(t.path);r.push(i.put({targetId:n,path:s})),r.push(this.referenceDelegate.addReference(e,n,t))}),er.waitFor(r)}removeMatchingKeys(e,t,n){let r=iI(e);return er.forEach(t,t=>{let i=eI(t.path);return er.waitFor([r.delete([n,i]),this.referenceDelegate.removeReference(e,n,t)])})}removeMatchingKeysForTargetId(e,t){let n=iI(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){let n=IDBKeyRange.bound([t],[t+1],!1,!0),r=iI(e),i=nd();return r.J({range:n,H:!0},(e,t,n)=>{let r=new G(e_(e[1]));i=i.add(r)}).next(()=>i)}containsKey(e,t){let n=eI(t.path),r=IDBKeyRange.bound([n],[n+"\0"],!1,!0),i=0;return iI(e).J({index:"documentTargetsIndex",H:!0,range:r},([e,t],n,r)=>{0!==e&&(i++,r.done())}).next(()=>i>0)}ot(e,t){return iw(e).get(t).next(e=>e?rR(e):null)}}function iw(e){return eG(e,"targets")}function iv(e){return eG(e,"targetGlobal")}function iI(e){return eG(e,"targetDocuments")}function i_([e,t],[n,r]){let i=F(e,n);return 0===i?F(t,r):i}class iT{constructor(e){this.Un=e,this.buffer=new eY(i_),this.Wn=0}Gn(){return++this.Wn}zn(e){let t=[e,this.Gn()];if(this.buffer.size<this.Un)this.buffer=this.buffer.add(t);else{let e=this.buffer.last();0>i_(t,e)&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class iE{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.jn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Hn(6e4)}stop(){this.jn&&(this.jn.cancel(),this.jn=null)}get started(){return null!==this.jn}Hn(e){I("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.jn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.jn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){eu(e)?I("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await en(e)}await this.Hn(3e5)})}}class ib{constructor(e,t){this.Jn=e,this.params=t}calculateTargetCount(e,t){return this.Jn.Yn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return er.resolve(ep.oe);let n=new iT(t);return this.Jn.forEachTarget(e,e=>n.zn(e.sequenceNumber)).next(()=>this.Jn.Zn(e,e=>n.zn(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.Jn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.Jn.removeOrphanedDocuments(e,t)}collect(e,t){return -1===this.params.cacheSizeCollectionThreshold?(I("LruGarbageCollector","Garbage collection skipped; disabled"),er.resolve(ia)):this.getCacheSize(e).next(n=>n<this.params.cacheSizeCollectionThreshold?(I("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),ia):this.Xn(e,t))}getCacheSize(e){return this.Jn.getCacheSize(e)}Xn(e,t){let n,r,i,s,a,o,l,h=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(t>this.params.maximumSequenceNumbersToCollect?(I("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,s=Date.now(),this.nthSequenceNumber(e,r))).next(r=>(n=r,a=Date.now(),this.removeTargets(e,n,t))).next(t=>(i=t,o=Date.now(),this.removeOrphanedDocuments(e,n))).next(e=>(l=Date.now(),v()<=u.$b.DEBUG&&I("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${s-h}ms
	Determined least recently used ${r} in `+(a-s)+"ms\n"+`	Removed ${i} targets in `+(o-a)+"ms\n"+`	Removed ${e} documents in `+(l-o)+"ms\n"+`Total Duration: ${l-h}ms`),er.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:e})))}}class iS{constructor(e,t){this.db=e,this.garbageCollector=new ib(this,t)}Yn(e){let t=this.er(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}er(e){let t=0;return this.Zn(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Zn(e,t){return this.tr(e,(e,n)=>t(n))}addReference(e,t,n){return ix(e,n)}removeReference(e,t,n){return ix(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return ix(e,t)}nr(e,t){let n;return n=!1,ig(e).Y(r=>ic(e,r,t).next(e=>(e&&(n=!0),er.resolve(!e)))).next(()=>n)}removeOrphanedDocuments(e,t){let n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[],i=0;return this.tr(e,(s,a)=>{if(a<=t){let t=this.nr(e,s).next(t=>{if(!t)return i++,n.getEntry(e,s).next(()=>(n.removeEntry(s,U.min()),iI(e).delete([0,eI(s.path)])))});r.push(t)}}).next(()=>er.waitFor(r)).next(()=>n.apply(e)).next(()=>i)}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return ix(e,t)}tr(e,t){let n=iI(e),r,i=ep.oe;return n.J({index:"documentTargetsIndex"},([e,n],{path:s,sequenceNumber:a})=>{0===e?(i!==ep.oe&&t(new G(e_(r)),i),i=a,r=s):i=ep.oe}).next(()=>{i!==ep.oe&&t(new G(e_(r)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function ix(e,t){var n;return iI(e).put((n=e.currentSequenceNumber,{targetId:0,path:eI(t.path),sequenceNumber:n}))}class iD{constructor(){this.changes=new ni(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,tb.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let n=this.changes.get(t);return void 0!==n?er.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class iC{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return ik(e).put(n)}removeEntry(e,t,n){return ik(e).delete(function(e,t){let n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],rC(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next(n=>(n.byteSize+=t,this.rr(e,n)))}getEntry(e,t){let n=tb.newInvalidDocument(t);return ik(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(iR(t))},(e,r)=>{n=this.ir(t,r)}).next(()=>n)}sr(e,t){let n={size:0,document:tb.newInvalidDocument(t)};return ik(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(iR(t))},(e,r)=>{n={document:this.ir(t,r),size:iu(r)}}).next(()=>n)}getEntries(e,t){let n=ns;return this._r(e,t,(e,t)=>{let r=this.ir(e,t);n=n.insert(e,r)}).next(()=>n)}ar(e,t){let n=ns,r=new eW(G.comparator);return this._r(e,t,(e,t)=>{let i=this.ir(e,t);n=n.insert(e,i),r=r.insert(e,iu(t))}).next(()=>({documents:n,ur:r}))}_r(e,t,n){if(t.isEmpty())return er.resolve();let r=new eY(iM);t.forEach(e=>r=r.add(e));let i=IDBKeyRange.bound(iR(r.first()),iR(r.last())),s=r.getIterator(),a=s.getNext();return ik(e).J({index:"documentKeyIndex",range:i},(e,t,r)=>{let i=G.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;a&&0>iM(a,i);)n(a,null),a=s.getNext();a&&a.isEqual(i)&&(n(a,t),a=s.hasNext()?s.getNext():null),a?r.$(iR(a)):r.done()}).next(()=>{for(;a;)n(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,t,n,r,i){let s=t.path,a=[s.popLast().toArray(),s.lastSegment(),rC(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return ik(e).U(IDBKeyRange.bound(a,o,!0)).next(e=>{null==i||i.incrementDocumentReadCount(e.length);let n=ns;for(let i of e){let e=this.ir(G.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(nt(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n})}getAllFromCollectionGroup(e,t,n,r){let i=ns,s=iV(t,n),a=iV(t,X.max());return ik(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(s,a,!0)},(e,t,n)=>{let s=this.ir(G.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(i=i.insert(s.key,s)).size===r&&n.done()}).next(()=>i)}newChangeBuffer(e){return new iN(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return iA(e).get("remoteDocumentGlobalKey").next(e=>(e||b(),e))}rr(e,t){return iA(e).put("remoteDocumentGlobalKey",t)}ir(e,t){if(t){let e=function(e,t){let n;if(t.document)n=rp(e.ct,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let e=G.fromSegments(t.noDocument.path),r=rA(t.noDocument.readTime);n=tb.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return b();{let e=G.fromSegments(t.unknownDocument.path),r=rA(t.unknownDocument.version);n=tb.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){let t=new P(e[0],e[1]);return U.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!(e.isNoDocument()&&e.version.isEqual(U.min())))return e}return tb.newInvalidDocument(e)}}class iN extends iD{constructor(e,t){super(),this.cr=e,this.trackRemovals=t,this.lr=new ni(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){let t=[],n=0,r=new eY((e,t)=>F(e.canonicalString(),t.canonicalString()));return this.changes.forEach((i,s)=>{let a=this.lr.get(i);if(t.push(this.cr.removeEntry(e,i,a.readTime)),s.isValidDocument()){let o=rD(this.cr.serializer,s);r=r.add(i.path.popLast());let l=iu(o);n+=l-a.size,t.push(this.cr.addEntry(e,i,o))}else if(n-=a.size,this.trackRemovals){let n=rD(this.cr.serializer,s.convertToNoDocument(U.min()));t.push(this.cr.addEntry(e,i,n))}}),r.forEach(n=>{t.push(this.cr.indexManager.addToCollectionParentIndex(e,n))}),t.push(this.cr.updateMetadata(e,n)),er.waitFor(t)}getFromCache(e,t){return this.cr.sr(e,t).next(e=>(this.lr.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.cr.ar(e,t).next(({documents:e,ur:t})=>(t.forEach((t,n)=>{this.lr.set(t,{size:n,readTime:e.get(t).readTime})}),e))}}function iA(e){return eG(e,"remoteDocumentGlobal")}function ik(e){return eG(e,"remoteDocumentsV14")}function iR(e){let t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function iV(e,t){let n=t.documentKey.path.toArray();return[e,rC(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function iM(e,t){let n=e.path.toArray(),r=t.path.toArray(),i=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(i=F(n[e],r[e]))return i;return(i=F(n.length,r.length))||(i=F(n[n.length-2],r[r.length-2]))||F(n[n.length-1],r[r.length-1])}class iO{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class iF{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next(r=>(n=r,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==n&&nV(n.mutation,e,e0.empty(),P.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,nd()).next(()=>t))}getLocalViewOfDocuments(e,t,n=nd()){let r=nu();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let t=no();return e.forEach((e,n)=>{t=t.insert(e,n.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){let n=nu();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,nd()))}populateOverlays(e,t,n){let r=[];return n.forEach(e=>{t.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,n)=>{t.set(e,n)})})}computeViews(e,t,n,r){let i=ns,s=nu(),a=nu();return t.forEach((e,t)=>{let a=n.get(t.key);r.has(t.key)&&(void 0===a||a.mutation instanceof nF)?i=i.insert(t.key,t):void 0!==a?(s.set(t.key,a.mutation.getFieldMask()),nV(a.mutation,t,a.mutation.getFieldMask(),P.now())):s.set(t.key,e0.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>s.set(e,t)),t.forEach((e,t)=>{var n;return a.set(e,new iO(t,null!=(n=s.get(e))?n:null))}),a))}recalculateAndSaveOverlays(e,t){let n=nu(),r=new eW((e,t)=>e-t),i=nd();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(let i of e)i.keys().forEach(e=>{let s=t.get(e);if(null===s)return;let a=n.get(e)||e0.empty();a=i.applyToLocalView(s,a),n.set(e,a);let o=(r.get(i.batchId)||nd()).add(e);r=r.insert(i.batchId,o)})}).next(()=>{let s=[],a=r.getReverseIterator();for(;a.hasNext();){let r=a.getNext(),o=r.key,l=r.value,u=nu();l.forEach(e=>{if(!i.has(e)){let r=nR(t.get(e),n.get(e));null!==r&&u.set(e,r),i=i.add(e)}}),s.push(this.documentOverlayCache.saveOverlays(e,o,u))}return er.waitFor(s)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,n,r){return G.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):t2(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next(i=>{let s=r-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-i.size):er.resolve(nu()),a=-1,o=i;return s.next(t=>er.forEach(t,(t,n)=>(a<n.largestBatchId&&(a=n.largestBatchId),i.get(t)?er.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{o=o.insert(t,e)}))).next(()=>this.populateOverlays(e,t,i)).next(()=>this.computeViews(e,o,t,nd())).next(e=>({batchId:a,changes:nl(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new G(t)).next(e=>{let t=no();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){let i=t.collectionGroup,s=no();return this.indexManager.getCollectionParents(e,i).next(a=>er.forEach(a,a=>{let o=new tZ(a.child(i),null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(e,o,n,r).next(e=>{e.forEach((e,t)=>{s=s.insert(e,t)})})}).next(()=>s))}getDocumentsMatchingCollectionQuery(e,t,n,r){let i;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next(s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,i,r))).next(e=>{i.forEach((t,n)=>{let r=n.getKey();null===e.get(r)&&(e=e.insert(r,tb.newInvalidDocument(r)))});let n=no();return e.forEach((e,r)=>{let s=i.get(e);void 0!==s&&nV(s.mutation,r,e0.empty(),P.now()),nt(t,r)&&(n=n.insert(e,r))}),n})}}class iL{constructor(e){this.serializer=e,this.hr=new Map,this.Pr=new Map}getBundleMetadata(e,t){return er.resolve(this.hr.get(t))}saveBundleMetadata(e,t){return this.hr.set(t.id,{id:t.id,version:t.version,createTime:rs(t.createTime)}),er.resolve()}getNamedQuery(e,t){return er.resolve(this.Pr.get(t))}saveNamedQuery(e,t){return this.Pr.set(t.name,{name:t.name,query:rM(t.bundledQuery),readTime:rs(t.readTime)}),er.resolve()}}class iP{constructor(){this.overlays=new eW(G.comparator),this.Ir=new Map}getOverlay(e,t){return er.resolve(this.overlays.get(t))}getOverlays(e,t){let n=nu();return er.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){return n.forEach((n,r)=>{this.ht(e,t,r)}),er.resolve()}removeOverlaysForBatchId(e,t,n){let r=this.Ir.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.Ir.delete(n)),er.resolve()}getOverlaysForCollection(e,t,n){let r=nu(),i=t.length+1,s=new G(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){let e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return er.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let i=new eW((e,t)=>e-t),s=this.overlays.getIterator();for(;s.hasNext();){let e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=nu(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}let a=nu(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return er.resolve(a)}ht(e,t,n){let r=this.overlays.get(n.key);if(null!==r){let e=this.Ir.get(r.largestBatchId).delete(n.key);this.Ir.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new nG(t,n));let i=this.Ir.get(t);void 0===i&&(i=nd(),this.Ir.set(t,i)),this.Ir.set(t,i.add(n.key))}}class iU{constructor(){this.sessionToken=e2.EMPTY_BYTE_STRING}getSessionToken(e){return er.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,er.resolve()}}class iq{constructor(){this.Tr=new eY(iB.Er),this.dr=new eY(iB.Ar)}isEmpty(){return this.Tr.isEmpty()}addReference(e,t){let n=new iB(e,t);this.Tr=this.Tr.add(n),this.dr=this.dr.add(n)}Rr(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.Vr(new iB(e,t))}mr(e,t){e.forEach(e=>this.removeReference(e,t))}gr(e){let t=new G(new B([])),n=new iB(t,e),r=new iB(t,e+1),i=[];return this.dr.forEachInRange([n,r],e=>{this.Vr(e),i.push(e.key)}),i}pr(){this.Tr.forEach(e=>this.Vr(e))}Vr(e){this.Tr=this.Tr.delete(e),this.dr=this.dr.delete(e)}yr(e){let t=new G(new B([])),n=new iB(t,e),r=new iB(t,e+1),i=nd();return this.dr.forEachInRange([n,r],e=>{i=i.add(e.key)}),i}containsKey(e){let t=new iB(e,0),n=this.Tr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class iB{constructor(e,t){this.key=e,this.wr=t}static Er(e,t){return G.comparator(e.key,t.key)||F(e.wr,t.wr)}static Ar(e,t){return F(e.wr,t.wr)||G.comparator(e.key,t.key)}}class iz{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Sr=1,this.br=new eY(iB.Er)}checkEmpty(e){return er.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){let i=this.Sr;this.Sr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let s=new nz(i,t,n,r);for(let t of(this.mutationQueue.push(s),r))this.br=this.br.add(new iB(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return er.resolve(s)}lookupMutationBatch(e,t){return er.resolve(this.Dr(t))}getNextMutationBatchAfterBatchId(e,t){let n=this.vr(t+1),r=n<0?0:n;return er.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return er.resolve(0===this.mutationQueue.length?-1:this.Sr-1)}getAllMutationBatches(e){return er.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let n=new iB(t,0),r=new iB(t,Number.POSITIVE_INFINITY),i=[];return this.br.forEachInRange([n,r],e=>{let t=this.Dr(e.wr);i.push(t)}),er.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new eY(F);return t.forEach(e=>{let t=new iB(e,0),r=new iB(e,Number.POSITIVE_INFINITY);this.br.forEachInRange([t,r],e=>{n=n.add(e.wr)})}),er.resolve(this.Cr(n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=n;G.isDocumentKey(i)||(i=i.child(""));let s=new iB(new G(i),0),a=new eY(F);return this.br.forEachWhile(e=>{let t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.wr)),!0)},s),er.resolve(this.Cr(a))}Cr(e){let t=[];return e.forEach(e=>{let n=this.Dr(e);null!==n&&t.push(n)}),t}removeMutationBatch(e,t){0===this.Fr(t.batchId,"removed")||b(),this.mutationQueue.shift();let n=this.br;return er.forEach(t.mutations,r=>{let i=new iB(r.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)}).next(()=>{this.br=n})}On(e){}containsKey(e,t){let n=new iB(t,0),r=this.br.firstAfterOrEqual(n);return er.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,er.resolve()}Fr(e,t){return this.vr(e)}vr(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Dr(e){let t=this.vr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class iK{constructor(e){this.Mr=e,this.docs=new eW(G.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.Mr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let n=this.docs.get(t);return er.resolve(n?n.document.mutableCopy():tb.newInvalidDocument(t))}getEntries(e,t){let n=ns;return t.forEach(e=>{let t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():tb.newInvalidDocument(e))}),er.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=ns,s=t.path,a=new G(s.child("")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){let{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||0>=Z(Y(a),n)||(r.has(a.key)||nt(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return er.resolve(i)}getAllFromCollectionGroup(e,t,n,r){b()}Or(e,t){return er.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new iG(this)}getSize(e){return er.resolve(this.size)}}class iG extends iD{constructor(e){super(),this.cr=e}applyChanges(e){let t=[];return this.changes.forEach((n,r)=>{r.isValidDocument()?t.push(this.cr.addEntry(e,r)):this.cr.removeEntry(n)}),er.waitFor(t)}getFromCache(e,t){return this.cr.getEntry(e,t)}getAllFromCache(e,t){return this.cr.getEntries(e,t)}}class i${constructor(e){this.persistence=e,this.Nr=new ni(e=>tj(e),tW),this.lastRemoteSnapshotVersion=U.min(),this.highestTargetId=0,this.Lr=0,this.Br=new iq,this.targetCount=0,this.kr=ip.Bn()}forEachTarget(e,t){return this.Nr.forEach((e,n)=>t(n)),er.resolve()}getLastRemoteSnapshotVersion(e){return er.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return er.resolve(this.Lr)}allocateTargetId(e){return this.highestTargetId=this.kr.next(),er.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Lr&&(this.Lr=t),er.resolve()}Kn(e){this.Nr.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.kr=new ip(t),this.highestTargetId=t),e.sequenceNumber>this.Lr&&(this.Lr=e.sequenceNumber)}addTargetData(e,t){return this.Kn(t),this.targetCount+=1,er.resolve()}updateTargetData(e,t){return this.Kn(t),er.resolve()}removeTargetData(e,t){return this.Nr.delete(t.target),this.Br.gr(t.targetId),this.targetCount-=1,er.resolve()}removeTargets(e,t,n){let r=0,i=[];return this.Nr.forEach((s,a)=>{a.sequenceNumber<=t&&null===n.get(a.targetId)&&(this.Nr.delete(s),i.push(this.removeMatchingKeysForTargetId(e,a.targetId)),r++)}),er.waitFor(i).next(()=>r)}getTargetCount(e){return er.resolve(this.targetCount)}getTargetData(e,t){let n=this.Nr.get(t)||null;return er.resolve(n)}addMatchingKeys(e,t,n){return this.Br.Rr(t,n),er.resolve()}removeMatchingKeys(e,t,n){this.Br.mr(t,n);let r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(t=>{i.push(r.markPotentiallyOrphaned(e,t))}),er.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.Br.gr(t),er.resolve()}getMatchingKeysForTargetId(e,t){let n=this.Br.yr(t);return er.resolve(n)}containsKey(e,t){return er.resolve(this.Br.containsKey(t))}}class iQ{constructor(e,t){this.qr={},this.overlays={},this.Qr=new ep(0),this.Kr=!1,this.Kr=!0,this.$r=new iU,this.referenceDelegate=e(this),this.Ur=new i$(this),this.indexManager=new r3,this.remoteDocumentCache=new iK(e=>this.referenceDelegate.Wr(e)),this.serializer=new rx(t),this.Gr=new iL(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Kr=!1,Promise.resolve()}get started(){return this.Kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new iP,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.qr[e.toKey()];return n||(n=new iz(t,this.referenceDelegate),this.qr[e.toKey()]=n),n}getGlobalsCache(){return this.$r}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Gr}runTransaction(e,t,n){I("MemoryPersistence","Starting transaction:",e);let r=new ij(this.Qr.next());return this.referenceDelegate.zr(),n(r).next(e=>this.referenceDelegate.jr(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Hr(e,t){return er.or(Object.values(this.qr).map(n=>()=>n.containsKey(e,t)))}}class ij extends et{constructor(e){super(),this.currentSequenceNumber=e}}class iW{constructor(e){this.persistence=e,this.Jr=new iq,this.Yr=null}static Zr(e){return new iW(e)}get Xr(){if(this.Yr)return this.Yr;throw b()}addReference(e,t,n){return this.Jr.addReference(n,t),this.Xr.delete(n.toString()),er.resolve()}removeReference(e,t,n){return this.Jr.removeReference(n,t),this.Xr.add(n.toString()),er.resolve()}markPotentiallyOrphaned(e,t){return this.Xr.add(t.toString()),er.resolve()}removeTarget(e,t){this.Jr.gr(t.targetId).forEach(e=>this.Xr.add(e.toString()));let n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.Xr.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}zr(){this.Yr=new Set}jr(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return er.forEach(this.Xr,n=>{let r=G.fromPath(n);return this.ei(e,r).next(e=>{e||t.removeEntry(r,U.min())})}).next(()=>(this.Yr=null,t.apply(e)))}updateLimboDocument(e,t){return this.ei(e,t).next(e=>{e?this.Xr.delete(t.toString()):this.Xr.add(t.toString())})}Wr(e){return 0}ei(e,t){return er.or([()=>er.resolve(this.Jr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Hr(e,t)])}}class iJ{constructor(e,t){this.persistence=e,this.ti=new ni(e=>eI(e.path),(e,t)=>e.isEqual(t)),this.garbageCollector=new ib(this,t)}static Zr(e,t){return new iJ(e,t)}zr(){}jr(e){return er.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}Yn(e){let t=this.er(e);return this.persistence.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}er(e){let t=0;return this.Zn(e,e=>{t++}).next(()=>t)}Zn(e,t){return er.forEach(this.ti,(n,r)=>this.nr(e,n,r).next(e=>e?er.resolve():t(r)))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0,r=this.persistence.getRemoteDocumentCache(),i=r.newChangeBuffer();return r.Or(e,r=>this.nr(e,r,t).next(e=>{e||(n++,i.removeEntry(r,U.min()))})).next(()=>i.apply(e)).next(()=>n)}markPotentiallyOrphaned(e,t){return this.ti.set(t,e.currentSequenceNumber),er.resolve()}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.ti.set(n,e.currentSequenceNumber),er.resolve()}removeReference(e,t,n){return this.ti.set(n,e.currentSequenceNumber),er.resolve()}updateLimboDocument(e,t){return this.ti.set(t,e.currentSequenceNumber),er.resolve()}Wr(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=function e(t){switch(ti(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:let n=e9(t);return n?16+e(n):16;case 5:return 2*t.stringValue.length;case 6:return e3(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return(t.arrayValue.values||[]).reduce((t,n)=>t+e(n),0);case 10:case 11:var r;let i;return r=t.mapValue,i=0,eQ(r.fields,(t,n)=>{i+=t.length+e(n)}),i;default:throw b()}}(e.data.value)),t}nr(e,t,n){return er.or([()=>this.persistence.Hr(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{let e=this.ti.get(t);return er.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class iH{constructor(e){this.serializer=e}O(e,t,n,r){let i=new ei("createOrUpgrade",t);n<1&&r>=1&&(e.createObjectStore("owner"),e.createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",eT,{unique:!0}),e.createObjectStore("documentMutations"),iY(e),e.createObjectStore("remoteDocuments"));let s=er.resolve();return n<3&&r>=3&&(0!==n&&(e.deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal"),iY(e)),s=s.next(()=>(function(e){let t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:U.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)})(i))),n<4&&r>=4&&(0!==n&&(s=s.next(()=>i.store("mutations").U().next(t=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",eT,{unique:!0});let n=i.store("mutations"),r=t.map(e=>n.put(e));return er.waitFor(r)}))),s=s.next(()=>{e.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&r>=5&&(s=s.next(()=>this.ni(i))),n<6&&r>=6&&(s=s.next(()=>(e.createObjectStore("remoteDocumentGlobal"),this.ri(i)))),n<7&&r>=7&&(s=s.next(()=>this.ii(i))),n<8&&r>=8&&(s=s.next(()=>this.si(e,i))),n<9&&r>=9&&(s=s.next(()=>{e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&r>=10&&(s=s.next(()=>this.oi(i))),n<11&&r>=11&&(s=s.next(()=>{e.createObjectStore("bundles",{keyPath:"bundleId"}),e.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&r>=12&&(s=s.next(()=>{let t=e.createObjectStore("documentOverlays",{keyPath:eO});t.createIndex("collectionPathOverlayIndex",eF,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",eL,{unique:!1})})),n<13&&r>=13&&(s=s.next(()=>(function(e){let t=e.createObjectStore("remoteDocumentsV14",{keyPath:eb});t.createIndex("documentKeyIndex",eS),t.createIndex("collectionGroupIndex",ex)})(e)).next(()=>this._i(e,i)).next(()=>e.deleteObjectStore("remoteDocuments"))),n<14&&r>=14&&(s=s.next(()=>this.ai(e,i))),n<15&&r>=15&&(s=s.next(()=>{e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:ek}).createIndex("sequenceNumberIndex",eR,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:eV}).createIndex("documentKeyIndex",eM,{unique:!1})})),n<16&&r>=16&&(s=s.next(()=>{t.objectStore("indexState").clear()}).next(()=>{t.objectStore("indexEntries").clear()})),n<17&&r>=17&&(s=s.next(()=>{e.createObjectStore("globals",{keyPath:"name"})})),s}ri(e){let t=0;return e.store("remoteDocuments").J((e,n)=>{t+=iu(n)}).next(()=>{let n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)})}ni(e){let t=e.store("mutationQueues"),n=e.store("mutations");return t.U().next(t=>er.forEach(t,t=>{let r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.U("userMutationsIndex",r).next(n=>er.forEach(n,n=>{n.userId===t.userId||b();let r=rk(this.serializer,n);return il(e,t.userId,r).next(()=>{})}))}))}ii(e){let t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(e=>{let r=[];return n.J((n,i)=>{let s=new B(n),a=[0,eI(s)];r.push(t.get(a).next(n=>n?er.resolve():t.put({targetId:0,path:eI(s),sequenceNumber:e.highestListenSequenceNumber})))}).next(()=>er.waitFor(r))})}si(e,t){e.createObjectStore("collectionParents",{keyPath:eA});let n=t.store("collectionParents"),r=new r6,i=e=>{if(r.add(e)){let t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:eI(r)})}};return t.store("remoteDocuments").J({H:!0},(e,t)=>i(new B(e).popLast())).next(()=>t.store("documentMutations").J({H:!0},([e,t,n],r)=>i(e_(t).popLast())))}oi(e){let t=e.store("targets");return t.J((e,n)=>{let r=rR(n),i=rV(this.serializer,r);return t.put(i)})}_i(e,t){let n=t.store("remoteDocuments"),r=[];return n.J((e,n)=>{let i=t.store("remoteDocumentsV14"),s=(n.document?new G(B.fromString(n.document.name).popFirst(5)):n.noDocument?G.fromSegments(n.noDocument.path):n.unknownDocument?G.fromSegments(n.unknownDocument.path):b()).path.toArray(),a={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(i.put(a))}).next(()=>er.waitFor(r))}ai(e,t){let n=t.store("mutations"),r=new iC(this.serializer),i=new iQ(iW.Zr,this.serializer.ct);return n.U().next(e=>{let n=new Map;return e.forEach(e=>{var t;let r=null!=(t=n.get(e.userId))?t:nd();rk(this.serializer,e).keys().forEach(e=>r=r.add(e)),n.set(e.userId,r)}),er.forEach(n,(e,n)=>{let s=new p(n),a=rB.lt(this.serializer,s),o=i.getIndexManager(s);return new iF(r,ih.lt(s,this.serializer,o,i.referenceDelegate),a,o).recalculateAndSaveOverlaysForDocumentKeys(new eK(t,ep.oe),e).next()})})}}function iY(e){e.createObjectStore("targetDocuments",{keyPath:eC}).createIndex("documentTargetsIndex",eN,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",eD,{unique:!0}),e.createObjectStore("targetGlobal")}let iX="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class iZ{constructor(e,t,n,r,i,s,a,o,l,u,h=17){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.ui=i,this.window=s,this.document=a,this.ci=l,this.li=u,this.hi=h,this.Qr=null,this.Kr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Pi=null,this.inForeground=!1,this.Ii=null,this.Ti=null,this.Ei=Number.NEGATIVE_INFINITY,this.di=e=>Promise.resolve(),!iZ.D())throw new x(S.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new iS(this,r),this.Ai=t+"main",this.serializer=new rx(o),this.Ri=new es(this.Ai,this.hi,new iH(this.serializer)),this.$r=new rK,this.Ur=new iy(this.referenceDelegate,this.serializer),this.remoteDocumentCache=new iC(this.serializer),this.Gr=new rP,this.window&&this.window.localStorage?this.Vi=this.window.localStorage:(this.Vi=null,!1===u&&_("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new x(S.FAILED_PRECONDITION,iX);return this.fi(),this.gi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Ur.getHighestSequenceNumber(e))}).then(e=>{this.Qr=new ep(e,this.ci)}).then(()=>{this.Kr=!0}).catch(e=>(this.Ri&&this.Ri.close(),Promise.reject(e)))}yi(e){return this.di=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ri.L(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.ui.enqueueAndForget(async()=>{this.started&&await this.mi()}))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>i1(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.wi(e).next(e=>{e||(this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)))})}).next(()=>this.Si(e)).next(t=>this.isPrimary&&!t?this.bi(e).next(()=>!1):!!t&&this.Di(e).next(()=>!0))).catch(e=>{if(eu(e))return I("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return I("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.ui.enqueueRetryable(()=>this.di(e)),this.isPrimary=e})}wi(e){return i0(e).get("owner").next(e=>er.resolve(this.vi(e)))}Ci(e){return i1(e).delete(this.clientId)}async Fi(){if(this.isPrimary&&!this.Mi(this.Ei,18e5)){this.Ei=Date.now();let e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let t=eG(e,"clientMetadata");return t.U().next(e=>{let n=this.xi(e,18e5),r=e.filter(e=>-1===n.indexOf(e));return er.forEach(r,e=>t.delete(e.clientId)).next(()=>r)})}).catch(()=>[]);if(this.Vi)for(let t of e)this.Vi.removeItem(this.Oi(t.clientId))}}pi(){this.Ti=this.ui.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.mi().then(()=>this.Fi()).then(()=>this.pi()))}vi(e){return!!e&&e.ownerId===this.clientId}Si(e){return this.li?er.resolve(!0):i0(e).get("owner").next(t=>{if(null!==t&&this.Mi(t.leaseTimestampMs,5e3)&&!this.Ni(t.ownerId)){if(this.vi(t)&&this.networkEnabled)return!0;if(!this.vi(t)){if(!t.allowTabSynchronization)throw new x(S.FAILED_PRECONDITION,iX);return!1}}return!(!this.networkEnabled||!this.inForeground)||i1(e).U().next(e=>void 0===this.xi(e,5e3).find(e=>{if(this.clientId!==e.clientId){let t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&I("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.Kr=!1,this.Li(),this.Ti&&(this.Ti.cancel(),this.Ti=null),this.Bi(),this.ki(),await this.Ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{let t=new eK(e,ep.oe);return this.bi(t).next(()=>this.Ci(t))}),this.Ri.close(),this.qi()}xi(e,t){return e.filter(e=>this.Mi(e.updateTimeMs,t)&&!this.Ni(e.clientId))}Qi(){return this.runTransaction("getActiveClients","readonly",e=>i1(e).U().next(e=>this.xi(e,18e5).map(e=>e.clientId)))}get started(){return this.Kr}getGlobalsCache(){return this.$r}getMutationQueue(e,t){return ih.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new r7(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return rB.lt(this.serializer,e)}getBundleCache(){return this.Gr}runTransaction(e,t,n){var r;let i;I("IndexedDbPersistence","Starting transaction:",e);let s=17===(r=this.hi)?ez:16===r||15===r?eB:14===r||13===r?eq:12===r?eU:11===r?eP:void b();return this.Ri.runTransaction(e,"readonly"===t?"readonly":"readwrite",s,r=>(i=new eK(r,this.Qr?this.Qr.next():ep.oe),"readwrite-primary"===t?this.wi(i).next(e=>!!e||this.Si(i)).next(t=>{if(!t)throw _(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.ui.enqueueRetryable(()=>this.di(!1)),new x(S.FAILED_PRECONDITION,ee);return n(i)}).next(e=>this.Di(i).next(()=>e)):this.Ki(i).next(()=>n(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Ki(e){return i0(e).get("owner").next(e=>{if(null!==e&&this.Mi(e.leaseTimestampMs,5e3)&&!this.Ni(e.ownerId)&&!this.vi(e)&&!(this.li||this.allowTabSynchronization&&e.allowTabSynchronization))throw new x(S.FAILED_PRECONDITION,iX)})}Di(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return i0(e).put("owner",t)}static D(){return es.D()}bi(e){let t=i0(e);return t.get("owner").next(e=>this.vi(e)?(I("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):er.resolve())}Mi(e,t){let n=Date.now();return!(e<n-t)&&(!(e>n)||(_(`Detected an update time that is in the future: ${e} > ${n}`),!1))}fi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ii=()=>{this.ui.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.mi()))},this.document.addEventListener("visibilitychange",this.Ii),this.inForeground="visible"===this.document.visibilityState)}Bi(){this.Ii&&(this.document.removeEventListener("visibilitychange",this.Ii),this.Ii=null)}gi(){var e;"function"==typeof(null==(e=this.window)?void 0:e.addEventListener)&&(this.Pi=()=>{this.Li();let e=/(?:Version|Mobile)\/1[456]/;(0,h.nr)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.ui.enterRestrictedMode(!0),this.ui.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Pi))}ki(){this.Pi&&(this.window.removeEventListener("pagehide",this.Pi),this.Pi=null)}Ni(e){var t;try{let n=null!==(null==(t=this.Vi)?void 0:t.getItem(this.Oi(e)));return I("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return _("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Li(){if(this.Vi)try{this.Vi.setItem(this.Oi(this.clientId),String(Date.now()))}catch(e){_("Failed to set zombie client id.",e)}}qi(){if(this.Vi)try{this.Vi.removeItem(this.Oi(this.clientId))}catch(e){}}Oi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function i0(e){return eG(e,"owner")}function i1(e){return eG(e,"clientMetadata")}function i2(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class i5{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.$i=n,this.Ui=r}static Wi(e,t){let n=nd(),r=nd();for(let e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new i5(e,t.fromCache,n,r)}}class i4{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class i8{constructor(){this.Gi=!1,this.zi=!1,this.ji=100,this.Hi=(0,h.nr)()?8:ea((0,h.ZQ)())>0?6:4}initialize(e,t){this.Ji=e,this.indexManager=t,this.Gi=!0}getDocumentsMatchingQuery(e,t,n,r){let i={result:null};return this.Yi(e,t).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.Zi(e,t,r,n).next(e=>{i.result=e})}).next(()=>{if(i.result)return;let n=new i4;return this.Xi(e,t,n).next(r=>{if(i.result=r,this.zi)return this.es(e,t,n,r.size)})}).next(()=>i.result)}es(e,t,n,r){return n.documentReadCount<this.ji?(v()<=u.$b.DEBUG&&I("QueryEngine","SDK will not create cache indexes for query:",ne(t),"since it only creates cache indexes for collection contains","more than or equal to",this.ji,"documents"),er.resolve()):(v()<=u.$b.DEBUG&&I("QueryEngine","Query:",ne(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.Hi*r?(v()<=u.$b.DEBUG&&I("QueryEngine","The SDK decides to create cache indexes for query:",ne(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,t4(t))):er.resolve())}Yi(e,t){if(t1(t))return er.resolve(null);let n=t4(t);return this.indexManager.getIndexType(e,n).next(r=>0===r?null:(null!==t.limit&&1===r&&(n=t4(t=t6(t,null,"F"))),this.indexManager.getDocumentsMatchingTarget(e,n).next(r=>{let i=nd(...r);return this.Ji.getDocuments(e,i).next(r=>this.indexManager.getMinOffset(e,n).next(n=>{let s=this.ts(t,r);return this.ns(t,s,i,n.readTime)?this.Yi(e,t6(t,null,"F")):this.rs(e,s,t,n)}))})))}Zi(e,t,n,r){return t1(t)||r.isEqual(U.min())?er.resolve(null):this.Ji.getDocuments(e,n).next(i=>{let s=this.ts(t,i);return this.ns(t,s,n,r)?er.resolve(null):(v()<=u.$b.DEBUG&&I("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),ne(t)),this.rs(e,s,t,H(r,-1)).next(e=>e))})}ts(e,t){let n=new eY(nr(e));return t.forEach((t,r)=>{nt(e,r)&&(n=n.add(r))}),n}ns(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;let i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}Xi(e,t,n){return v()<=u.$b.DEBUG&&I("QueryEngine","Using full collection scan to execute query:",ne(t)),this.Ji.getDocumentsMatchingQuery(e,t,X.min(),n)}rs(e,t,n,r){return this.Ji.getDocumentsMatchingQuery(e,n,r).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}class i3{constructor(e,t,n,r){this.persistence=e,this.ss=t,this.serializer=r,this.os=new eW(F),this._s=new ni(e=>tj(e),tW),this.us=new Map,this.cs=e.getRemoteDocumentCache(),this.Ur=e.getTargetCache(),this.Gr=e.getBundleCache(),this.ls(n)}ls(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new iF(this.cs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.cs.setIndexManager(this.indexManager),this.ss.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.os))}}async function i6(e,t){return await e.persistence.runTransaction("Handle user change","readonly",n=>{let r;return e.mutationQueue.getAllMutationBatches(n).next(i=>(r=i,e.ls(t),e.mutationQueue.getAllMutationBatches(n))).next(t=>{let i=[],s=[],a=nd();for(let e of r)for(let t of(i.push(e.batchId),e.mutations))a=a.add(t.key);for(let e of t)for(let t of(s.push(e.batchId),e.mutations))a=a.add(t.key);return e.localDocuments.getDocuments(n,a).next(e=>({hs:e,removedBatchIds:i,addedBatchIds:s}))})})}function i9(e){return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Ur.getLastRemoteSnapshotVersion(t))}function i7(e,t,n){let r=nd(),i=nd();return n.forEach(e=>r=r.add(e)),t.getEntries(e,r).next(e=>{let r=ns;return n.forEach((n,s)=>{let a=e.get(n);s.isFoundDocument()!==a.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual(U.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):I("LocalStore","Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",s.version)}),{Ps:r,Is:i}})}function se(e,t){return e.persistence.runTransaction("Allocate target","readwrite",n=>{let r;return e.Ur.getTargetData(n,t).next(i=>i?(r=i,er.resolve(r)):e.Ur.allocateTargetId(n).next(i=>(r=new rS(t,i,"TargetPurposeListen",n.currentSequenceNumber),e.Ur.addTargetData(n,r).next(()=>r))))}).then(n=>{let r=e.os.get(n.targetId);return(null===r||n.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(e.os=e.os.insert(n.targetId,n),e._s.set(t,n.targetId)),n})}async function st(e,t,n){let r=e.os.get(t);try{n||await e.persistence.runTransaction("Release target",n?"readwrite":"readwrite-primary",t=>e.persistence.referenceDelegate.removeTarget(t,r))}catch(e){if(!eu(e))throw e;I("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}e.os=e.os.remove(t),e._s.delete(r.target)}function sn(e,t,n){let r=U.min(),i=nd();return e.persistence.runTransaction("Execute query","readwrite",s=>(function(e,t,n){let r=e._s.get(n);return void 0!==r?er.resolve(e.os.get(r)):e.Ur.getTargetData(t,n)})(e,s,t4(t)).next(t=>{if(t)return r=t.lastLimboFreeSnapshotVersion,e.Ur.getMatchingKeysForTargetId(s,t.targetId).next(e=>{i=e})}).next(()=>e.ss.getDocumentsMatchingQuery(s,t,n?r:U.min(),n?i:nd())).next(n=>(ss(e,nn(t),n),{documents:n,Ts:i})))}function sr(e,t){let n=e.Ur,r=e.os.get(t);return r?Promise.resolve(r.target):e.persistence.runTransaction("Get target data","readonly",e=>n.ot(e,t).next(e=>e?e.target:null))}function si(e,t){let n=e.us.get(t)||U.min();return e.persistence.runTransaction("Get new document changes","readonly",r=>e.cs.getAllFromCollectionGroup(r,t,H(n,-1),Number.MAX_SAFE_INTEGER)).then(n=>(ss(e,t,n),n))}function ss(e,t,n){let r=e.us.get(t)||U.min();n.forEach((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)}),e.us.set(t,r)}async function sa(e,t,n,r){let i=nd(),s=ns;for(let e of n){let n=t.Es(e.metadata.name);e.document&&(i=i.add(n));let r=t.ds(e);r.setReadTime(t.As(e.metadata.readTime)),s=s.insert(n,r)}let a=e.cs.newChangeBuffer({trackRemovals:!0}),o=await se(e,t4(t0(B.fromString(`__bundle__/docs/${r}`))));return e.persistence.runTransaction("Apply bundle documents","readwrite",t=>i7(t,a,s).next(e=>(a.apply(t),e)).next(n=>e.Ur.removeMatchingKeysForTargetId(t,o.targetId).next(()=>e.Ur.addMatchingKeys(t,i,o.targetId)).next(()=>e.localDocuments.getLocalViewOfDocuments(t,n.Ps,n.Is)).next(()=>n.Ps)))}async function so(e,t,n=nd()){let r=await se(e,t4(rM(t.bundledQuery)));return e.persistence.runTransaction("Save named query","readwrite",i=>{let s=rs(t.readTime);if(r.snapshotVersion.compareTo(s)>=0)return e.Gr.saveNamedQuery(i,t);let a=r.withResumeToken(e2.EMPTY_BYTE_STRING,s);return e.os=e.os.insert(a.targetId,a),e.Ur.updateTargetData(i,a).next(()=>e.Ur.removeMatchingKeysForTargetId(i,r.targetId)).next(()=>e.Ur.addMatchingKeys(i,n,r.targetId)).next(()=>e.Gr.saveNamedQuery(i,t))})}function sl(e,t){return`firestore_clients_${e}_${t}`}function su(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function sh(e,t){return`firestore_targets_${e}_${t}`}class sc{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Rs(e,t,n){let r=JSON.parse(n),i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(i=new x(r.error.code,r.error.message)),s?new sc(e,t,r.state,i):(_("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Vs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class sd{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Rs(e,t){let n=JSON.parse(t),r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new x(n.error.code,n.error.message)),i?new sd(e,n.state,r):(_("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Vs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class sf{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Rs(e,t){let n=JSON.parse(t),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=nf;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=ev(n.activeTargetIds[e]),i=i.add(n.activeTargetIds[e]);return r?new sf(e,i):(_("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class sm{constructor(e,t){this.clientId=e,this.onlineState=t}static Rs(e){let t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new sm(t.clientId,t.onlineState):(_("SharedClientState",`Failed to parse online state: ${e}`),null)}}class sg{constructor(){this.activeTargetIds=nf}fs(e){this.activeTargetIds=this.activeTargetIds.add(e)}gs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Vs(){return JSON.stringify({activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()})}}class sp{constructor(e,t,n,r,i){var s,a,o;this.window=e,this.ui=t,this.persistenceKey=n,this.ps=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ys=this.ws.bind(this),this.Ss=new eW(F),this.started=!1,this.bs=[];let l=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.Ds=sl(this.persistenceKey,this.ps),this.vs=(s=this.persistenceKey,`firestore_sequence_number_${s}`),this.Ss=this.Ss.insert(this.ps,new sg),this.Cs=RegExp(`^firestore_clients_${l}_([^_]*)$`),this.Fs=RegExp(`^firestore_mutations_${l}_(\\d+)(?:_(.*))?$`),this.Ms=RegExp(`^firestore_targets_${l}_(\\d+)$`),this.xs=(a=this.persistenceKey,`firestore_online_state_${a}`),this.Os=(o=this.persistenceKey,`firestore_bundle_loaded_v2_${o}`),this.window.addEventListener("storage",this.ys)}static D(e){return!(!e||!e.localStorage)}async start(){for(let e of(await this.syncEngine.Qi())){if(e===this.ps)continue;let t=this.getItem(sl(this.persistenceKey,e));if(t){let n=sf.Rs(e,t);n&&(this.Ss=this.Ss.insert(n.clientId,n))}}this.Ns();let e=this.storage.getItem(this.xs);if(e){let t=this.Ls(e);t&&this.Bs(t)}for(let e of this.bs)this.ws(e);this.bs=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.vs,JSON.stringify(e))}getAllActiveQueryTargets(){return this.ks(this.Ss)}isActiveQueryTarget(e){let t=!1;return this.Ss.forEach((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.qs(e,"pending")}updateMutationState(e,t,n){this.qs(e,t,n),this.Qs(e)}addLocalQueryTarget(e,t=!0){let n="not-current";if(this.isActiveQueryTarget(e)){let t=this.storage.getItem(sh(this.persistenceKey,e));if(t){let r=sd.Rs(e,t);r&&(n=r.state)}}return t&&this.Ks.fs(e),this.Ns(),n}removeLocalQueryTarget(e){this.Ks.gs(e),this.Ns()}isLocalQueryTarget(e){return this.Ks.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(sh(this.persistenceKey,e))}updateQueryState(e,t,n){this.$s(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Qs(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Us(e)}notifyBundleLoaded(e){this.Ws(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ys),this.removeItem(this.Ds),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return I("SharedClientState","READ",e,t),t}setItem(e,t){I("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){I("SharedClientState","REMOVE",e),this.storage.removeItem(e)}ws(e){if(e.storageArea===this.storage){if(I("SharedClientState","EVENT",e.key,e.newValue),e.key===this.Ds)return void _("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.ui.enqueueRetryable(async()=>{if(this.started){if(null!==e.key){if(this.Cs.test(e.key)){if(null==e.newValue){let t=this.Gs(e.key);return this.zs(t,null)}{let t=this.js(e.key,e.newValue);if(t)return this.zs(t.clientId,t)}}else if(this.Fs.test(e.key)){if(null!==e.newValue){let t=this.Hs(e.key,e.newValue);if(t)return this.Js(t)}}else if(this.Ms.test(e.key)){if(null!==e.newValue){let t=this.Ys(e.key,e.newValue);if(t)return this.Zs(t)}}else if(e.key===this.xs){if(null!==e.newValue){let t=this.Ls(e.newValue);if(t)return this.Bs(t)}}else if(e.key===this.vs){let t=function(e){let t=ep.oe;if(null!=e)try{let n=JSON.parse(e);"number"==typeof n||b(),t=n}catch(e){_("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(e.newValue);t!==ep.oe&&this.sequenceNumberHandler(t)}else if(e.key===this.Os){let t=this.Xs(e.newValue);await Promise.all(t.map(e=>this.syncEngine.eo(e)))}}}else this.bs.push(e)})}}get Ks(){return this.Ss.get(this.ps)}Ns(){this.setItem(this.Ds,this.Ks.Vs())}qs(e,t,n){let r=new sc(this.currentUser,e,t,n),i=su(this.persistenceKey,this.currentUser,e);this.setItem(i,r.Vs())}Qs(e){let t=su(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Us(e){let t={clientId:this.ps,onlineState:e};this.storage.setItem(this.xs,JSON.stringify(t))}$s(e,t,n){let r=sh(this.persistenceKey,e),i=new sd(e,t,n);this.setItem(r,i.Vs())}Ws(e){let t=JSON.stringify(Array.from(e));this.setItem(this.Os,t)}Gs(e){let t=this.Cs.exec(e);return t?t[1]:null}js(e,t){let n=this.Gs(e);return sf.Rs(n,t)}Hs(e,t){let n=this.Fs.exec(e),r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return sc.Rs(new p(i),r,t)}Ys(e,t){let n=Number(this.Ms.exec(e)[1]);return sd.Rs(n,t)}Ls(e){return sm.Rs(e)}Xs(e){return JSON.parse(e)}async Js(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.no(e.batchId,e.state,e.error);I("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}Zs(e){return this.syncEngine.ro(e.targetId,e.state,e.error)}zs(e,t){let n=t?this.Ss.insert(e,t):this.Ss.remove(e),r=this.ks(this.Ss),i=this.ks(n),s=[],a=[];return i.forEach(e=>{r.has(e)||s.push(e)}),r.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.io(s,a).then(()=>{this.Ss=n})}Bs(e){this.Ss.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}ks(e){let t=nf;return e.forEach((e,n)=>{t=t.unionWith(n.activeTargetIds)}),t}}class sy{constructor(){this.so=new sg,this.oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e,t=!0){return t&&this.so.fs(e),this.oo[e]||"not-current"}updateQueryState(e,t,n){this.oo[e]=t}removeLocalQueryTarget(e){this.so.gs(e)}isLocalQueryTarget(e){return this.so.activeTargetIds.has(e)}clearQueryState(e){delete this.oo[e]}getAllActiveQueryTargets(){return this.so.activeTargetIds}isActiveQueryTarget(e){return this.so.activeTargetIds.has(e)}start(){return this.so=new sg,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class sw{_o(e){}shutdown(){}}class sv{constructor(){this.ao=()=>this.uo(),this.co=()=>this.lo(),this.ho=[],this.Po()}_o(e){this.ho.push(e)}shutdown(){window.removeEventListener("online",this.ao),window.removeEventListener("offline",this.co)}Po(){window.addEventListener("online",this.ao),window.addEventListener("offline",this.co)}uo(){for(let e of(I("ConnectivityMonitor","Network connectivity changed: AVAILABLE"),this.ho))e(0)}lo(){for(let e of(I("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE"),this.ho))e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let sI=null;function s_(){return null===sI?sI=0x10000000+Math.round(0x80000000*Math.random()):sI++,"0x"+sI.toString(16)}let sT={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class sE{constructor(e){this.Io=e.Io,this.To=e.To}Eo(e){this.Ao=e}Ro(e){this.Vo=e}mo(e){this.fo=e}onMessage(e){this.po=e}close(){this.To()}send(e){this.Io(e)}yo(){this.Ao()}wo(){this.Vo()}So(e){this.fo(e)}bo(e){this.po(e)}}let sb="WebChannelConnection";class sS extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.Do=t+"://"+e.host,this.vo=`projects/${n}/databases/${r}`,this.Co="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get Fo(){return!1}Mo(e,t,n,r,i){let s=s_(),a=this.xo(e,t.toUriEncodedString());I("RestConnection",`Sending RPC '${e}' ${s}:`,a,n);let o={"google-cloud-resource-prefix":this.vo,"x-goog-request-params":this.Co};return this.Oo(o,r,i),this.No(e,a,o,n).then(t=>(I("RestConnection",`Received RPC '${e}' ${s}: `,t),t),t=>{throw T("RestConnection",`RPC '${e}' ${s} failed with error: `,t,"url: ",a,"request:",n),t})}Lo(e,t,n,r,i,s){return this.Mo(e,t,n,r,i)}Oo(e,t,n){e["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+y}(),e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,n)=>e[n]=t),n&&n.headers.forEach((t,n)=>e[n]=t)}xo(e,t){let n=sT[e];return`${this.Do}/v1/${t}:${n}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}No(e,t,n,r){let i=s_();return new Promise((s,a)=>{let o=new d.ZS;o.setWithCredentials(!0),o.listenOnce(d.Bx.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case d.O4.NO_ERROR:let t=o.getResponseJson();I(sb,`XHR for RPC '${e}' ${i} received:`,JSON.stringify(t)),s(t);break;case d.O4.TIMEOUT:I(sb,`RPC '${e}' ${i} timed out`),a(new x(S.DEADLINE_EXCEEDED,"Request time out"));break;case d.O4.HTTP_ERROR:let n=o.getStatus();if(I(sb,`RPC '${e}' ${i} failed with status:`,n,"response text:",o.getResponseText()),n>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);let t=null==e?void 0:e.error;if(t&&t.status&&t.message){let e=function(e){let t=e.toLowerCase().replace(/_/g,"-");return Object.values(S).indexOf(t)>=0?t:S.UNKNOWN}(t.status);a(new x(e,t.message))}else a(new x(S.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new x(S.UNAVAILABLE,"Connection failed."));break;default:b()}}finally{I(sb,`RPC '${e}' ${i} completed.`)}});let l=JSON.stringify(r);I(sb,`RPC '${e}' ${i} sending request:`,r),o.send(t,"POST",l,n,15)})}Bo(e,t,n){let i=s_(),s=[this.Do,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=(0,d.fF)(),o=(0,d.Ao)(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(l.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(l.useFetchStreams=!0),this.Oo(l.initMessageHeaders,t,n),l.encodeInitMessageHeaders=!0;let h=s.join("");I(sb,`Creating RPC '${e}' stream ${i}: ${h}`,l);let c=a.createWebChannel(h,l),f=!1,m=!1,g=new sE({Io:t=>{m?I(sb,`Not sending because RPC '${e}' stream ${i} is closed:`,t):(f||(I(sb,`Opening RPC '${e}' stream ${i} transport.`),c.open(),f=!0),I(sb,`RPC '${e}' stream ${i} sending:`,t),c.send(t))},To:()=>c.close()}),p=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return p(c,d.iO.EventType.OPEN,()=>{m||(I(sb,`RPC '${e}' stream ${i} transport opened.`),g.yo())}),p(c,d.iO.EventType.CLOSE,()=>{m||(m=!0,I(sb,`RPC '${e}' stream ${i} transport closed`),g.So())}),p(c,d.iO.EventType.ERROR,t=>{m||(m=!0,T(sb,`RPC '${e}' stream ${i} transport errored:`,t),g.So(new x(S.UNAVAILABLE,"The operation could not be completed")))}),p(c,d.iO.EventType.MESSAGE,t=>{var n;if(!m){let s=t.data[0];s||b();let a=s.error||(null==(n=s[0])?void 0:n.error);if(a){I(sb,`RPC '${e}' stream ${i} received error:`,a);let t=a.status,n=function(e){let t=r[e];if(void 0!==t)return nj(t)}(t),s=a.message;void 0===n&&(n=S.INTERNAL,s="Unknown error status: "+t+" with message "+a.message),m=!0,g.So(new x(n,s)),c.close()}else I(sb,`RPC '${e}' stream ${i} received:`,s),g.bo(s)}}),p(o,d.Jh.STAT_EVENT,t=>{t.stat===d.ro.PROXY?I(sb,`RPC '${e}' stream ${i} detected buffering proxy`):t.stat===d.ro.NOPROXY&&I(sb,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{g.wo()},0),g}}function sx(){return"undefined"!=typeof window?window:null}function sD(){return"undefined"!=typeof document?document:null}function sC(e){return new rt(e,!0)}class sN{constructor(e,t,n=1e3,r=1.5,i=6e4){this.ui=e,this.timerId=t,this.ko=n,this.qo=r,this.Qo=i,this.Ko=0,this.$o=null,this.Uo=Date.now(),this.reset()}reset(){this.Ko=0}Wo(){this.Ko=this.Qo}Go(e){this.cancel();let t=Math.floor(this.Ko+this.zo()),n=Math.max(0,Date.now()-this.Uo),r=Math.max(0,t-n);r>0&&I("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Ko} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.$o=this.ui.enqueueAfterDelay(this.timerId,r,()=>(this.Uo=Date.now(),e())),this.Ko*=this.qo,this.Ko<this.ko&&(this.Ko=this.ko),this.Ko>this.Qo&&(this.Ko=this.Qo)}jo(){null!==this.$o&&(this.$o.skipDelay(),this.$o=null)}cancel(){null!==this.$o&&(this.$o.cancel(),this.$o=null)}zo(){return(Math.random()-.5)*this.Ko}}class sA{constructor(e,t,n,r,i,s,a,o){this.ui=e,this.Ho=n,this.Jo=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.Yo=0,this.Zo=null,this.Xo=null,this.stream=null,this.e_=0,this.t_=new sN(e,t)}n_(){return 1===this.state||5===this.state||this.r_()}r_(){return 2===this.state||3===this.state}start(){this.e_=0,4!==this.state?this.auth():this.i_()}async stop(){this.n_()&&await this.close(0)}s_(){this.state=0,this.t_.reset()}o_(){this.r_()&&null===this.Zo&&(this.Zo=this.ui.enqueueAfterDelay(this.Ho,6e4,()=>this.__()))}a_(e){this.u_(),this.stream.send(e)}async __(){if(this.r_())return this.close(0)}u_(){this.Zo&&(this.Zo.cancel(),this.Zo=null)}c_(){this.Xo&&(this.Xo.cancel(),this.Xo=null)}async close(e,t){this.u_(),this.c_(),this.t_.cancel(),this.Yo++,4!==e?this.t_.reset():t&&t.code===S.RESOURCE_EXHAUSTED?(_(t.toString()),_("Using maximum backoff delay to prevent overloading the backend."),this.t_.Wo()):t&&t.code===S.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.l_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.mo(t)}l_(){}auth(){this.state=1;let e=this.h_(this.Yo),t=this.Yo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,n])=>{this.Yo===t&&this.P_(e,n)},t=>{e(()=>{let e=new x(S.UNKNOWN,"Fetching auth token failed: "+t.message);return this.I_(e)})})}P_(e,t){let n=this.h_(this.Yo);this.stream=this.T_(e,t),this.stream.Eo(()=>{n(()=>this.listener.Eo())}),this.stream.Ro(()=>{n(()=>(this.state=2,this.Xo=this.ui.enqueueAfterDelay(this.Jo,1e4,()=>(this.r_()&&(this.state=3),Promise.resolve())),this.listener.Ro()))}),this.stream.mo(e=>{n(()=>this.I_(e))}),this.stream.onMessage(e=>{n(()=>1==++this.e_?this.E_(e):this.onNext(e))})}i_(){this.state=5,this.t_.Go(async()=>{this.state=0,this.start()})}I_(e){return I("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}h_(e){return t=>{this.ui.enqueueAndForget(()=>this.Yo===e?t():(I("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class sk extends sA{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}T_(e,t){return this.connection.Bo("Listen",e,t)}E_(e){return this.onNext(e)}onNext(e){this.t_.reset();let t=function(e,t){let n;if("targetChange"in t){var r,i;t.targetChange;let s="NO_CHANGE"===(r=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===r?1:"REMOVE"===r?2:"CURRENT"===r?3:"RESET"===r?4:b(),a=t.targetChange.targetIds||[],o=(i=t.targetChange.resumeToken,e.useProto3Json?(void 0===i||"string"==typeof i||b(),e2.fromBase64String(i||"")):(void 0===i||i instanceof m||i instanceof Uint8Array||b(),e2.fromUint8Array(i||new Uint8Array))),l=t.targetChange.cause;n=new n5(s,a,o,l&&new x(void 0===l.code?S.UNKNOWN:nj(l.code),l.message||"")||null)}else if("documentChange"in t){t.documentChange;let r=t.documentChange;r.document,r.document.name,r.document.updateTime;let i=rh(e,r.document.name),s=rs(r.document.updateTime),a=r.document.createTime?rs(r.document.createTime):U.min(),o=new tE({mapValue:{fields:r.document.fields}}),l=tb.newFoundDocument(i,s,a,o);n=new n1(r.targetIds||[],r.removedTargetIds||[],l.key,l)}else if("documentDelete"in t){t.documentDelete;let r=t.documentDelete;r.document;let i=rh(e,r.document),s=r.readTime?rs(r.readTime):U.min(),a=tb.newNoDocument(i,s);n=new n1([],r.removedTargetIds||[],a.key,a)}else if("documentRemove"in t){t.documentRemove;let r=t.documentRemove;r.document;let i=rh(e,r.document);n=new n1([],r.removedTargetIds||[],i,null)}else{if(!("filter"in t))return b();{t.filter;let e=t.filter;e.targetId;let{count:r=0,unchangedNames:i}=e,s=new n$(r,i);n=new n2(e.targetId,s)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return U.min();let t=e.targetChange;return t.targetIds&&t.targetIds.length?U.min():t.readTime?rs(t.readTime):U.min()}(e);return this.listener.d_(t,n)}A_(e){let t={};t.database=rf(this.serializer),t.addTarget=function(e,t){let n,r=t.target;if((n=tJ(r)?{documents:rv(e,r)}:{query:rI(e,r)._t}).targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=ri(e,t.resumeToken);let r=rn(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(U.min())>0){n.readTime=rr(e,t.snapshotVersion.toTimestamp());let r=rn(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);let n=function(e,t){let n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return b()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.a_(t)}R_(e){let t={};t.database=rf(this.serializer),t.removeTarget=e,this.a_(t)}}class sR extends sA{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}get V_(){return this.e_>0}start(){this.lastStreamToken=void 0,super.start()}l_(){this.V_&&this.m_([])}T_(e,t){return this.connection.Bo("Write",e,t)}E_(e){return e.streamToken||b(),this.lastStreamToken=e.streamToken,e.writeResults&&0!==e.writeResults.length&&b(),this.listener.f_()}onNext(e){var t,n;e.streamToken||b(),this.lastStreamToken=e.streamToken,this.t_.reset();let r=(t=e.writeResults,n=e.commitTime,t&&t.length>0?(void 0!==n||b(),t.map(e=>{let t;return(t=e.updateTime?rs(e.updateTime):rs(n)).isEqual(U.min())&&(t=rs(n)),new nC(t,e.transformResults||[])})):[]),i=rs(e.commitTime);return this.listener.g_(i,r)}p_(){let e={};e.database=rf(this.serializer),this.a_(e)}m_(e){let t={streamToken:this.lastStreamToken,writes:e.map(e=>ry(this.serializer,e))};this.a_(t)}}class sV extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.y_=!1}w_(){if(this.y_)throw new x(S.FAILED_PRECONDITION,"The client has already been terminated.")}Mo(e,t,n,r){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,s])=>this.connection.Mo(e,ro(t,n),r,i,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===S.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new x(S.UNKNOWN,e.toString())})}Lo(e,t,n,r,i){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.Lo(e,ro(t,n),r,s,a,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===S.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new x(S.UNKNOWN,e.toString())})}terminate(){this.y_=!0,this.connection.terminate()}}class sM{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.S_=0,this.b_=null,this.D_=!0}v_(){0===this.S_&&(this.C_("Unknown"),this.b_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.b_=null,this.F_("Backend didn't respond within 10 seconds."),this.C_("Offline"),Promise.resolve())))}M_(e){"Online"===this.state?this.C_("Unknown"):(this.S_++,this.S_>=1&&(this.x_(),this.F_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.C_("Offline")))}set(e){this.x_(),this.S_=0,"Online"===e&&(this.D_=!1),this.C_(e)}C_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}F_(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.D_?(_(t),this.D_=!1):I("OnlineStateTracker",t)}x_(){null!==this.b_&&(this.b_.cancel(),this.b_=null)}}class sO{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.O_=[],this.N_=new Map,this.L_=new Set,this.B_=[],this.k_=i,this.k_._o(e=>{n.enqueueAndForget(async()=>{sG(this)&&(I("RemoteStore","Restarting streams for network reachability change."),await async function(e){e.L_.add(4),await sL(e),e.q_.set("Unknown"),e.L_.delete(4),await sF(e)}(this))})}),this.q_=new sM(n,r)}}async function sF(e){if(sG(e))for(let t of e.B_)await t(!0)}async function sL(e){for(let t of e.B_)await t(!1)}function sP(e,t){e.N_.has(t.targetId)||(e.N_.set(t.targetId,t),sK(e)?sz(e):s3(e).r_()&&sq(e,t))}function sU(e,t){let n=s3(e);e.N_.delete(t),n.r_()&&sB(e,t),0===e.N_.size&&(n.r_()?n.o_():sG(e)&&e.q_.set("Unknown"))}function sq(e,t){if(e.Q_.xe(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(U.min())>0){let n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}s3(e).A_(t)}function sB(e,t){e.Q_.xe(t),s3(e).R_(t)}function sz(e){e.Q_=new n8({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),ot:t=>e.N_.get(t)||null,tt:()=>e.datastore.serializer.databaseId}),s3(e).start(),e.q_.v_()}function sK(e){return sG(e)&&!s3(e).n_()&&e.N_.size>0}function sG(e){return 0===e.L_.size}async function s$(e){e.q_.set("Online")}async function sQ(e){e.N_.forEach((t,n)=>{sq(e,t)})}async function sj(e,t){e.Q_=void 0,sK(e)?(e.q_.M_(t),sz(e)):e.q_.set("Unknown")}async function sW(e,t,n){if(e.q_.set("Online"),t instanceof n5&&2===t.state&&t.cause)try{await async function(e,t){let n=t.cause;for(let r of t.targetIds)e.N_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.N_.delete(r),e.Q_.removeTarget(r))}(e,t)}catch(n){I("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await sJ(e,n)}else if(t instanceof n1?e.Q_.Ke(t):t instanceof n2?e.Q_.He(t):e.Q_.We(t),!n.isEqual(U.min()))try{let t=await i9(e.localStore);n.compareTo(t)>=0&&await function(e,t){let n=e.Q_.rt(t);return n.targetChanges.forEach((n,r)=>{if(n.resumeToken.approximateByteSize()>0){let i=e.N_.get(r);i&&e.N_.set(r,i.withResumeToken(n.resumeToken,t))}}),n.targetMismatches.forEach((t,n)=>{let r=e.N_.get(t);if(!r)return;e.N_.set(t,r.withResumeToken(e2.EMPTY_BYTE_STRING,r.snapshotVersion)),sB(e,t);let i=new rS(r.target,t,n,r.sequenceNumber);sq(e,i)}),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){I("RemoteStore","Failed to raise snapshot:",t),await sJ(e,t)}}async function sJ(e,t,n){if(!eu(t))throw t;e.L_.add(1),await sL(e),e.q_.set("Offline"),n||(n=()=>i9(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{I("RemoteStore","Retrying IndexedDB access"),await n(),e.L_.delete(1),await sF(e)})}function sH(e,t){return t().catch(n=>sJ(e,n,t))}async function sY(e){var t;let n=s6(e),r=e.O_.length>0?e.O_[e.O_.length-1].batchId:-1;for(;sG(t=e)&&t.O_.length<10;)try{let t=await function(e,t){return e.persistence.runTransaction("Get next mutation batch","readonly",n=>(void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)))}(e.localStore,r);if(null===t){0===e.O_.length&&n.o_();break}r=t.batchId,function(e,t){e.O_.push(t);let n=s6(e);n.r_()&&n.V_&&n.m_(t.mutations)}(e,t)}catch(t){await sJ(e,t)}sX(e)&&sZ(e)}function sX(e){return sG(e)&&!s6(e).n_()&&e.O_.length>0}function sZ(e){s6(e).start()}async function s0(e){s6(e).p_()}async function s1(e){let t=s6(e);for(let n of e.O_)t.m_(n.mutations)}async function s2(e,t,n){let r=e.O_.shift(),i=nK.from(r,t,n);await sH(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await sY(e)}async function s5(e,t){t&&s6(e).V_&&await async function(e,t){var n;if(nQ(n=t.code)&&n!==S.ABORTED){let n=e.O_.shift();s6(e).s_(),await sH(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await sY(e)}}(e,t),sX(e)&&sZ(e)}async function s4(e,t){e.asyncQueue.verifyOperationInProgress(),I("RemoteStore","RemoteStore received new credentials");let n=sG(e);e.L_.add(3),await sL(e),n&&e.q_.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.L_.delete(3),await sF(e)}async function s8(e,t){t?(e.L_.delete(2),await sF(e)):t||(e.L_.add(2),await sL(e),e.q_.set("Unknown"))}function s3(e){var t,n,r;return e.K_||(t=e.datastore,n=e.asyncQueue,r={Eo:s$.bind(null,e),Ro:sQ.bind(null,e),mo:sj.bind(null,e),d_:sW.bind(null,e)},t.w_(),e.K_=new sk(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r),e.B_.push(async t=>{t?(e.K_.s_(),sK(e)?sz(e):e.q_.set("Unknown")):(await e.K_.stop(),e.Q_=void 0)})),e.K_}function s6(e){var t,n,r;return e.U_||(t=e.datastore,n=e.asyncQueue,r={Eo:()=>Promise.resolve(),Ro:s0.bind(null,e),mo:s5.bind(null,e),f_:s1.bind(null,e),g_:s2.bind(null,e)},t.w_(),e.U_=new sR(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r),e.B_.push(async t=>{t?(e.U_.s_(),await sY(e)):(await e.U_.stop(),e.O_.length>0&&(I("RemoteStore",`Stopping write stream with ${e.O_.length} pending writes`),e.O_=[]))})),e.U_}class s9{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new D,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){let s=new s9(e,t,Date.now()+n,r,i);return s.start(n),s}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new x(S.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function s7(e,t){if(_("AsyncQueue",`${t}: ${e}`),eu(e))return new x(S.UNAVAILABLE,`${t}: ${e}`);throw e}class ae{constructor(e){this.comparator=e?(t,n)=>e(t,n)||G.comparator(t.key,n.key):(e,t)=>G.comparator(e.key,t.key),this.keyedMap=no(),this.sortedSet=new eW(this.comparator)}static emptySet(e){return new ae(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,n)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof ae)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){let n=new ae;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class at{constructor(){this.W_=new eW(G.comparator)}track(e){let t=e.doc.key,n=this.W_.get(t);n?0!==e.type&&3===n.type?this.W_=this.W_.insert(t,e):3===e.type&&1!==n.type?this.W_=this.W_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.W_=this.W_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.W_=this.W_.remove(t):1===e.type&&2===n.type?this.W_=this.W_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.W_=this.W_.insert(t,{type:2,doc:e.doc}):b():this.W_=this.W_.insert(t,e)}G_(){let e=[];return this.W_.inorderTraversal((t,n)=>{e.push(n)}),e}}class an{constructor(e,t,n,r,i,s,a,o,l){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=l}static fromInitialDocuments(e,t,n,r,i){let s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new an(e,t,ae.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&t9(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class ar{constructor(){this.z_=void 0,this.j_=[]}H_(){return this.j_.some(e=>e.J_())}}class ai{constructor(){this.queries=as(),this.onlineState="Unknown",this.Y_=new Set}terminate(){!function(e,t){let n=e.queries;e.queries=as(),n.forEach((e,n)=>{for(let e of n.j_)e.onError(t)})}(this,new x(S.ABORTED,"Firestore shutting down"))}}function as(){return new ni(e=>t7(e),t9)}async function aa(e,t){let n=3,r=t.query,i=e.queries.get(r);i?!i.H_()&&t.J_()&&(n=2):(i=new ar,n=+!t.J_());try{switch(n){case 0:i.z_=await e.onListen(r,!0);break;case 1:i.z_=await e.onListen(r,!1);break;case 2:await e.onFirstRemoteStoreListen(r)}}catch(n){let e=s7(n,`Initialization of query '${ne(t.query)}' failed`);return void t.onError(e)}e.queries.set(r,i),i.j_.push(t),t.Z_(e.onlineState),i.z_&&t.X_(i.z_)&&ah(e)}async function ao(e,t){let n=t.query,r=3,i=e.queries.get(n);if(i){let e=i.j_.indexOf(t);e>=0&&(i.j_.splice(e,1),0===i.j_.length?r=+!t.J_():!i.H_()&&t.J_()&&(r=2))}switch(r){case 0:return e.queries.delete(n),e.onUnlisten(n,!0);case 1:return e.queries.delete(n),e.onUnlisten(n,!1);case 2:return e.onLastRemoteStoreUnlisten(n);default:return}}function al(e,t){let n=!1;for(let r of t){let t=r.query,i=e.queries.get(t);if(i){for(let e of i.j_)e.X_(r)&&(n=!0);i.z_=r}}n&&ah(e)}function au(e,t,n){let r=e.queries.get(t);if(r)for(let e of r.j_)e.onError(n);e.queries.delete(t)}function ah(e){e.Y_.forEach(e=>{e.next()})}(a=s||(s={})).ea="default",a.Cache="cache";class ac{constructor(e,t,n){this.query=e,this.ta=t,this.na=!1,this.ra=null,this.onlineState="Unknown",this.options=n||{}}X_(e){if(!this.options.includeMetadataChanges){let t=[];for(let n of e.docChanges)3!==n.type&&t.push(n);e=new an(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.na?this.ia(e)&&(this.ta.next(e),t=!0):this.sa(e,this.onlineState)&&(this.oa(e),t=!0),this.ra=e,t}onError(e){this.ta.error(e)}Z_(e){this.onlineState=e;let t=!1;return this.ra&&!this.na&&this.sa(this.ra,e)&&(this.oa(this.ra),t=!0),t}sa(e,t){return!(e.fromCache&&this.J_())||(!this.options._a||"Offline"===t)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}ia(e){if(e.docChanges.length>0)return!0;let t=this.ra&&this.ra.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}oa(e){e=an.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.na=!0,this.ta.next(e)}J_(){return this.options.source!==s.Cache}}class ad{constructor(e,t){this.aa=e,this.byteLength=t}ua(){return"metadata"in this.aa}}class af{constructor(e){this.serializer=e}Es(e){return rh(this.serializer,e)}ds(e){return e.metadata.exists?rp(this.serializer,e.document,!1):tb.newNoDocument(this.Es(e.metadata.name),this.As(e.metadata.readTime))}As(e){return rs(e)}}class am{constructor(e){this.key=e}}class ag{constructor(e){this.key=e}}class ap{constructor(e,t){this.query=e,this.Ta=t,this.Ea=null,this.hasCachedResults=!1,this.current=!1,this.da=nd(),this.mutatedKeys=nd(),this.Aa=nr(e),this.Ra=new ae(this.Aa)}get Va(){return this.Ta}ma(e,t){let n=t?t.fa:new at,r=t?t.Ra:this.Ra,i=t?t.mutatedKeys:this.mutatedKeys,s=r,a=!1,o="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,l="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal((e,t)=>{let u=r.get(e),h=nt(this.query,t)?t:null,c=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations),f=!1;u&&h?u.data.isEqual(h.data)?c!==d&&(n.track({type:3,doc:h}),f=!0):this.ga(u,h)||(n.track({type:2,doc:h}),f=!0,(o&&this.Aa(h,o)>0||l&&0>this.Aa(h,l))&&(a=!0)):!u&&h?(n.track({type:0,doc:h}),f=!0):u&&!h&&(n.track({type:1,doc:u}),f=!0,(o||l)&&(a=!0)),f&&(h?(s=s.add(h),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))}),null!==this.query.limit)for(;s.size>this.query.limit;){let e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{Ra:s,fa:n,ns:a,mutatedKeys:i}}ga(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){let i=this.Ra;this.Ra=e.Ra,this.mutatedKeys=e.mutatedKeys;let s=e.fa.G_();s.sort((e,t)=>(function(e,t){let n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return b()}};return n(e)-n(t)})(e.type,t.type)||this.Aa(e.doc,t.doc)),this.pa(n),r=null!=r&&r;let a=t&&!r?this.ya():[],o=0===this.da.size&&this.current&&!r?1:0,l=o!==this.Ea;return(this.Ea=o,0!==s.length||l)?{snapshot:new an(this.query,e.Ra,i,s,e.mutatedKeys,0===o,l,!1,!!n&&n.resumeToken.approximateByteSize()>0),wa:a}:{wa:a}}Z_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Ra:this.Ra,fa:new at,mutatedKeys:this.mutatedKeys,ns:!1},!1)):{wa:[]}}Sa(e){return!this.Ta.has(e)&&!!this.Ra.has(e)&&!this.Ra.get(e).hasLocalMutations}pa(e){e&&(e.addedDocuments.forEach(e=>this.Ta=this.Ta.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Ta=this.Ta.delete(e)),this.current=e.current)}ya(){if(!this.current)return[];let e=this.da;this.da=nd(),this.Ra.forEach(e=>{this.Sa(e.key)&&(this.da=this.da.add(e.key))});let t=[];return e.forEach(e=>{this.da.has(e)||t.push(new ag(e))}),this.da.forEach(n=>{e.has(n)||t.push(new am(n))}),t}ba(e){this.Ta=e.Ts,this.da=nd();let t=this.ma(e.documents);return this.applyChanges(t,!0)}Da(){return an.fromInitialDocuments(this.query,this.Ra,this.mutatedKeys,0===this.Ea,this.hasCachedResults)}}class ay{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class aw{constructor(e){this.key=e,this.va=!1}}class av{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.Ca={},this.Fa=new ni(e=>t7(e),t9),this.Ma=new Map,this.xa=new Set,this.Oa=new eW(G.comparator),this.Na=new Map,this.La=new iq,this.Ba={},this.ka=new Map,this.qa=ip.kn(),this.onlineState="Unknown",this.Qa=void 0}get isPrimaryClient(){return!0===this.Qa}}async function aI(e,t,n=!0){let r,i=aH(e),s=i.Fa.get(t);return s?(i.sharedClientState.addLocalQueryTarget(s.targetId),r=s.view.Da()):r=await aT(i,t,n,!0),r}async function a_(e,t){let n=aH(e);await aT(n,t,!0,!1)}async function aT(e,t,n,r){let i,s=await se(e.localStore,t4(t)),a=s.targetId,o=e.sharedClientState.addLocalQueryTarget(a,n);return r&&(i=await aE(e,t,a,"current"===o,s.resumeToken)),e.isPrimaryClient&&n&&sP(e.remoteStore,s),i}async function aE(e,t,n,r,i){e.Ka=(t,n,r)=>(async function(e,t,n,r){let i=t.view.ma(n);i.ns&&(i=await sn(e.localStore,t.query,!1).then(({documents:e})=>t.view.ma(e,i)));let s=r&&r.targetChanges.get(t.targetId),a=r&&null!=r.targetMismatches.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s,a);return aF(e,t.targetId,o.wa),o.snapshot})(e,t,n,r);let s=await sn(e.localStore,t,!0),a=new ap(t,s.Ts),o=a.ma(s.documents),l=n0.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,i),u=a.applyChanges(o,e.isPrimaryClient,l);aF(e,n,u.wa);let h=new ay(t,n,a);return e.Fa.set(t,h),e.Ma.has(n)?e.Ma.get(n).push(t):e.Ma.set(n,[t]),u.snapshot}async function ab(e,t,n){let r=e.Fa.get(t),i=e.Ma.get(r.targetId);if(i.length>1)return e.Ma.set(r.targetId,i.filter(e=>!t9(e,t))),void e.Fa.delete(t);e.isPrimaryClient?(e.sharedClientState.removeLocalQueryTarget(r.targetId),e.sharedClientState.isActiveQueryTarget(r.targetId)||await st(e.localStore,r.targetId,!1).then(()=>{e.sharedClientState.clearQueryState(r.targetId),n&&sU(e.remoteStore,r.targetId),aM(e,r.targetId)}).catch(en)):(aM(e,r.targetId),await st(e.localStore,r.targetId,!0))}async function aS(e,t){let n=e.Fa.get(t),r=e.Ma.get(n.targetId);e.isPrimaryClient&&1===r.length&&(e.sharedClientState.removeLocalQueryTarget(n.targetId),sU(e.remoteStore,n.targetId))}async function ax(e,t,n){let r=aY(e);try{var i;let e,s=await function(e,t){let n,r,i=P.now(),s=t.reduce((e,t)=>e.add(t.key),nd());return e.persistence.runTransaction("Locally write mutations","readwrite",a=>{let o=ns,l=nd();return e.cs.getEntries(a,s).next(e=>{(o=e).forEach((e,t)=>{t.isValidDocument()||(l=l.add(e))})}).next(()=>e.localDocuments.getOverlayedDocuments(a,o)).next(r=>{n=r;let s=[];for(let e of t){let t=function(e,t){let n=null;for(let r of e.fieldTransforms){let e=t.data.field(r.field),i=nw(r.transform,e||null);null!=i&&(null===n&&(n=tE.empty()),n.set(r.field,i))}return n||null}(e,n.get(e.key).overlayedDocument);null!=t&&s.push(new nF(e.key,t,function e(t){let n=[];return eQ(t.fields,(t,r)=>{let i=new K([t]);if(tp(r)){let t=e(r.mapValue).fields;if(0===t.length)n.push(i);else for(let e of t)n.push(i.child(e))}else n.push(i)}),new e0(n)}(t.value.mapValue),nN.exists(!0)))}return e.mutationQueue.addMutationBatch(a,i,s,t)}).next(t=>{r=t;let i=t.applyToLocalDocumentSet(n,l);return e.documentOverlayCache.saveOverlays(a,t.batchId,i)})}).then(()=>({batchId:r.batchId,changes:nl(n)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(s.batchId),i=s.batchId,(e=r.Ba[r.currentUser.toKey()])||(e=new eW(F)),e=e.insert(i,n),r.Ba[r.currentUser.toKey()]=e,await aP(r,s.changes),await sY(r.remoteStore)}catch(t){let e=s7(t,"Failed to persist write");n.reject(e)}}async function aD(e,t){try{let n=await function(e,t){let n=t.snapshotVersion,r=e.os;return e.persistence.runTransaction("Apply remote event","readwrite-primary",i=>{let s=e.cs.newChangeBuffer({trackRemovals:!0});r=e.os;let a=[];t.targetChanges.forEach((s,o)=>{var l;let u=r.get(o);if(!u)return;a.push(e.Ur.removeMatchingKeys(i,s.removedDocuments,o).next(()=>e.Ur.addMatchingKeys(i,s.addedDocuments,o)));let h=u.withSequenceNumber(i.currentSequenceNumber);null!==t.targetMismatches.get(o)?h=h.withResumeToken(e2.EMPTY_BYTE_STRING,U.min()).withLastLimboFreeSnapshotVersion(U.min()):s.resumeToken.approximateByteSize()>0&&(h=h.withResumeToken(s.resumeToken,n)),r=r.insert(o,h),l=h,(0===u.resumeToken.approximateByteSize()||l.snapshotVersion.toMicroseconds()-u.snapshotVersion.toMicroseconds()>=3e8||s.addedDocuments.size+s.modifiedDocuments.size+s.removedDocuments.size>0)&&a.push(e.Ur.updateTargetData(i,h))});let o=ns,l=nd();if(t.documentUpdates.forEach(n=>{t.resolvedLimboDocuments.has(n)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(i,n))}),a.push(i7(i,s,t.documentUpdates).next(e=>{o=e.Ps,l=e.Is})),!n.isEqual(U.min())){let t=e.Ur.getLastRemoteSnapshotVersion(i).next(t=>e.Ur.setTargetsMetadata(i,i.currentSequenceNumber,n));a.push(t)}return er.waitFor(a).next(()=>s.apply(i)).next(()=>e.localDocuments.getLocalViewOfDocuments(i,o,l)).next(()=>o)}).then(t=>(e.os=r,t))}(e.localStore,t);t.targetChanges.forEach((t,n)=>{let r=e.Na.get(n);r&&(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1||b(),t.addedDocuments.size>0?r.va=!0:t.modifiedDocuments.size>0?r.va||b():t.removedDocuments.size>0&&(r.va||b(),r.va=!1))}),await aP(e,n,t)}catch(e){await en(e)}}function aC(e,t,n){var r;if(e.isPrimaryClient&&0===n||!e.isPrimaryClient&&1===n){let n,i=[];e.Fa.forEach((e,n)=>{let r=n.view.Z_(t);r.snapshot&&i.push(r.snapshot)}),(r=e.eventManager).onlineState=t,n=!1,r.queries.forEach((e,r)=>{for(let e of r.j_)e.Z_(t)&&(n=!0)}),n&&ah(r),i.length&&e.Ca.d_(i),e.onlineState=t,e.isPrimaryClient&&e.sharedClientState.setOnlineState(t)}}async function aN(e,t,n){e.sharedClientState.updateQueryState(t,"rejected",n);let r=e.Na.get(t),i=r&&r.key;if(i){let n=new eW(G.comparator);n=n.insert(i,tb.newNoDocument(i,U.min()));let r=nd().add(i),s=new nZ(U.min(),new Map,new eW(F),n,r);await aD(e,s),e.Oa=e.Oa.remove(i),e.Na.delete(t),aL(e)}else await st(e.localStore,t,!1).then(()=>aM(e,t,n)).catch(en)}async function aA(e,t){var n;let r=t.batch.batchId;try{let i=await (n=e.localStore,n.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{let r=t.batch.keys(),i=n.cs.newChangeBuffer({trackRemovals:!0});return(function(e,t,n,r){let i=n.batch,s=i.keys(),a=er.resolve();return s.forEach(e=>{a=a.next(()=>r.getEntry(t,e)).next(t=>{let s=n.docVersions.get(e);null!==s||b(),0>t.version.compareTo(s)&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))})(n,e,t,i).next(()=>i.apply(e)).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=nd();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t))).next(()=>n.localDocuments.getDocuments(e,r))}));aV(e,r,null),aR(e,r),e.sharedClientState.updateMutationState(r,"acknowledged"),await aP(e,i)}catch(e){await en(e)}}async function ak(e,t,n){var r;try{let i=await (r=e.localStore,r.persistence.runTransaction("Reject batch","readwrite-primary",e=>{let n;return r.mutationQueue.lookupMutationBatch(e,t).next(t=>(null!==t||b(),n=t.keys(),r.mutationQueue.removeMutationBatch(e,t))).next(()=>r.mutationQueue.performConsistencyCheck(e)).next(()=>r.documentOverlayCache.removeOverlaysForBatchId(e,n,t)).next(()=>r.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,n)).next(()=>r.localDocuments.getDocuments(e,n))}));aV(e,t,n),aR(e,t),e.sharedClientState.updateMutationState(t,"rejected",n),await aP(e,i)}catch(e){await en(e)}}function aR(e,t){(e.ka.get(t)||[]).forEach(e=>{e.resolve()}),e.ka.delete(t)}function aV(e,t,n){let r=e.Ba[e.currentUser.toKey()];if(r){let i=r.get(t);i&&(n?i.reject(n):i.resolve(),r=r.remove(t)),e.Ba[e.currentUser.toKey()]=r}}function aM(e,t,n=null){for(let r of(e.sharedClientState.removeLocalQueryTarget(t),e.Ma.get(t)))e.Fa.delete(r),n&&e.Ca.$a(r,n);e.Ma.delete(t),e.isPrimaryClient&&e.La.gr(t).forEach(t=>{e.La.containsKey(t)||aO(e,t)})}function aO(e,t){e.xa.delete(t.path.canonicalString());let n=e.Oa.get(t);null!==n&&(sU(e.remoteStore,n),e.Oa=e.Oa.remove(t),e.Na.delete(n),aL(e))}function aF(e,t,n){for(let r of n)r instanceof am?(e.La.addReference(r.key,t),function(e,t){let n=t.key,r=n.path.canonicalString();e.Oa.get(n)||e.xa.has(r)||(I("SyncEngine","New document in limbo: "+n),e.xa.add(r),aL(e))}(e,r)):r instanceof ag?(I("SyncEngine","Document no longer in limbo: "+r.key),e.La.removeReference(r.key,t),e.La.containsKey(r.key)||aO(e,r.key)):b()}function aL(e){for(;e.xa.size>0&&e.Oa.size<e.maxConcurrentLimboResolutions;){let t=e.xa.values().next().value;e.xa.delete(t);let n=new G(B.fromString(t)),r=e.qa.next();e.Na.set(r,new aw(n)),e.Oa=e.Oa.insert(n,r),sP(e.remoteStore,new rS(t4(t0(n.path)),r,"TargetPurposeLimboResolution",ep.oe))}}async function aP(e,t,n){let r=[],i=[],s=[];e.Fa.isEmpty()||(e.Fa.forEach((a,o)=>{s.push(e.Ka(o,t,n).then(t=>{var s;if((t||n)&&e.isPrimaryClient){let r=t?!t.fromCache:null==(s=null==n?void 0:n.targetChanges.get(o.targetId))?void 0:s.current;e.sharedClientState.updateQueryState(o.targetId,r?"current":"not-current")}if(t){r.push(t);let e=i5.Wi(o.targetId,t);i.push(e)}}))}),await Promise.all(s),e.Ca.d_(r),await async function(e,t){try{await e.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>er.forEach(t,t=>er.forEach(t.$i,r=>e.persistence.referenceDelegate.addReference(n,t.targetId,r)).next(()=>er.forEach(t.Ui,r=>e.persistence.referenceDelegate.removeReference(n,t.targetId,r)))))}catch(e){if(!eu(e))throw e;I("LocalStore","Failed to update sequence numbers: "+e)}for(let n of t){let t=n.targetId;if(!n.fromCache){let n=e.os.get(t),r=n.snapshotVersion,i=n.withLastLimboFreeSnapshotVersion(r);e.os=e.os.insert(t,i)}}}(e.localStore,i))}async function aU(e,t){if(!e.currentUser.isEqual(t)){I("SyncEngine","User change. New user:",t.toKey());let n=await i6(e.localStore,t);e.currentUser=t,e.ka.forEach(e=>{e.forEach(e=>{e.reject(new x(S.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.ka.clear(),e.sharedClientState.handleUserChange(t,n.removedBatchIds,n.addedBatchIds),await aP(e,n.hs)}}function aq(e,t){let n=e.Na.get(t);if(n&&n.va)return nd().add(n.key);{let n=nd(),r=e.Ma.get(t);if(!r)return n;for(let t of r){let r=e.Fa.get(t);n=n.unionWith(r.view.Va)}return n}}async function aB(e,t){let n=await sn(e.localStore,t.query,!0),r=t.view.ba(n);return e.isPrimaryClient&&aF(e,t.targetId,r.wa),r}async function az(e,t){return si(e.localStore,t).then(t=>aP(e,t))}async function aK(e,t,n,r){var i;let s=await function(e,t){let n=e.mutationQueue;return e.persistence.runTransaction("Lookup mutation documents","readonly",r=>n.Mn(r,t).next(t=>t?e.localDocuments.getDocuments(r,t):er.resolve(null)))}(e.localStore,t);null!==s?("pending"===n?await sY(e.remoteStore):"acknowledged"===n||"rejected"===n?(aV(e,t,r||null),aR(e,t),i=e.localStore,i.mutationQueue.On(t)):b(),await aP(e,s)):I("SyncEngine","Cannot apply mutation batch with id: "+t)}async function aG(e,t){if(aH(e),aY(e),!0===t&&!0!==e.Qa){let t=e.sharedClientState.getAllActiveQueryTargets(),n=await a$(e,t.toArray());for(let t of(e.Qa=!0,await s8(e.remoteStore,!0),n))sP(e.remoteStore,t)}else if(!1===t&&!1!==e.Qa){let t=[],n=Promise.resolve();e.Ma.forEach((r,i)=>{e.sharedClientState.isLocalQueryTarget(i)?t.push(i):n=n.then(()=>(aM(e,i),st(e.localStore,i,!0))),sU(e.remoteStore,i)}),await n,await a$(e,t),e.Na.forEach((t,n)=>{sU(e.remoteStore,n)}),e.La.pr(),e.Na=new Map,e.Oa=new eW(G.comparator),e.Qa=!1,await s8(e.remoteStore,!1)}}async function a$(e,t,n){let r=[],i=[];for(let n of t){let t,s=e.Ma.get(n);if(s&&0!==s.length)for(let n of(t=await se(e.localStore,t4(s[0])),s)){let t=e.Fa.get(n),r=await aB(e,t);r.snapshot&&i.push(r.snapshot)}else{let r=await sr(e.localStore,n);t=await se(e.localStore,r),await aE(e,aQ(r),n,!1,t.resumeToken)}r.push(t)}return e.Ca.d_(i),r}function aQ(e){var t,n,r,i,s;return t=e.path,n=e.collectionGroup,r=e.orderBy,i=e.filters,s=e.limit,new tZ(t,n,r,i,s,"F",e.startAt,e.endAt)}function aj(e){return e.localStore.persistence.Qi()}async function aW(e,t,n,r){if(e.Qa)return void I("SyncEngine","Ignoring unexpected query state notification.");let i=e.Ma.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{let r=await si(e.localStore,nn(i[0])),s=nZ.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,e2.EMPTY_BYTE_STRING);await aP(e,r,s);break}case"rejected":await st(e.localStore,t,!0),aM(e,t,r);break;default:b()}}async function aJ(e,t,n){let r=aH(e);if(r.Qa){for(let e of t){if(r.Ma.has(e)&&r.sharedClientState.isActiveQueryTarget(e)){I("SyncEngine","Adding an already active target "+e);continue}let t=await sr(r.localStore,e),n=await se(r.localStore,t);await aE(r,aQ(t),n.targetId,!1,n.resumeToken),sP(r.remoteStore,n)}for(let e of n)r.Ma.has(e)&&await st(r.localStore,e,!1).then(()=>{sU(r.remoteStore,e),aM(r,e)}).catch(en)}}function aH(e){return e.remoteStore.remoteSyncer.applyRemoteEvent=aD.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=aq.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=aN.bind(null,e),e.Ca.d_=al.bind(null,e.eventManager),e.Ca.$a=au.bind(null,e.eventManager),e}function aY(e){return e.remoteStore.remoteSyncer.applySuccessfulWrite=aA.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=ak.bind(null,e),e}class aX{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=sC(e.databaseInfo.databaseId),this.sharedClientState=this.Wa(e),this.persistence=this.Ga(e),await this.persistence.start(),this.localStore=this.za(e),this.gcScheduler=this.ja(e,this.localStore),this.indexBackfillerScheduler=this.Ha(e,this.localStore)}ja(e,t){return null}Ha(e,t){return null}za(e){var t,n;return t=this.persistence,n=new i8,new i3(t,n,e.initialUser,this.serializer)}Ga(e){return new iQ(iW.Zr,this.serializer)}Wa(e){return new sy}async terminate(){var e,t;null==(e=this.gcScheduler)||e.stop(),null==(t=this.indexBackfillerScheduler)||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}aX.provider={build:()=>new aX};class aZ extends aX{constructor(e){super(),this.cacheSizeBytes=e}ja(e,t){return this.persistence.referenceDelegate instanceof iJ||b(),new iE(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Ga(e){let t=void 0!==this.cacheSizeBytes?io.withCacheSize(this.cacheSizeBytes):io.DEFAULT;return new iQ(e=>iJ.Zr(e,t),this.serializer)}}class a0 extends aX{constructor(e,t,n){super(),this.Ja=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Ja.initialize(this,e),await aY(this.Ja.syncEngine),await sY(this.Ja.remoteStore),await this.persistence.yi(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}za(e){var t,n;return t=this.persistence,n=new i8,new i3(t,n,e.initialUser,this.serializer)}ja(e,t){return new iE(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Ha(e,t){let n=new eg(t,this.persistence);return new em(e.asyncQueue,n)}Ga(e){let t=i2(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?io.withCacheSize(this.cacheSizeBytes):io.DEFAULT;return new iZ(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,sx(),sD(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Wa(e){return new sy}}class a1 extends a0{constructor(e,t){super(e,t,!1),this.Ja=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);let t=this.Ja.syncEngine;this.sharedClientState instanceof sp&&(this.sharedClientState.syncEngine={no:aK.bind(null,t),ro:aW.bind(null,t),io:aJ.bind(null,t),Qi:aj.bind(null,t),eo:az.bind(null,t)},await this.sharedClientState.start()),await this.persistence.yi(async e=>{await aG(this.Ja.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}Wa(e){let t=sx();if(!sp.D(t))throw new x(S.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");let n=i2(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new sp(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class a2{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>aC(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=aU.bind(null,this.syncEngine),await s8(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new ai}createDatastore(e){var t;let n=sC(e.databaseInfo.databaseId),r=new sS(e.databaseInfo);return t=e.authCredentials,new sV(t,e.appCheckCredentials,r,n)}createRemoteStore(e){var t,n;return t=this.localStore,n=this.datastore,new sO(t,n,e.asyncQueue,e=>aC(this.syncEngine,e,0),sv.D()?new sv:new sw)}createSyncEngine(e,t){return function(e,t,n,r,i,s,a){let o=new av(e,t,n,r,i,s);return a&&(o.Qa=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e,t;await async function(e){I("RemoteStore","RemoteStore shutting down."),e.L_.add(5),await sL(e),e.k_.shutdown(),e.q_.set("Unknown")}(this.remoteStore),null==(e=this.datastore)||e.terminate(),null==(t=this.eventManager)||t.terminate()}}a2.provider={build:()=>new a2};class a5{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Ya(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Ya(this.observer.error,e):_("Uncaught Error in snapshot listener:",e.toString()))}Za(){this.muted=!0}Ya(e,t){setTimeout(()=>{this.muted||e(t)},0)}}class a4{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new x(S.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;let t=await async function(e,t){let n={documents:t.map(t=>ru(e.serializer,t))},r=await e.Lo("BatchGetDocuments",e.serializer.databaseId,B.emptyPath(),n,t.length),i=new Map;r.forEach(t=>{var n;let r=(n=e.serializer,"found"in t?function(e,t){t.found||b(),t.found.name,t.found.updateTime;let n=rh(e,t.found.name),r=rs(t.found.updateTime),i=t.found.createTime?rs(t.found.createTime):U.min(),s=new tE({mapValue:{fields:t.found.fields}});return tb.newFoundDocument(n,r,i,s)}(n,t):"missing"in t?function(e,t){t.missing||b(),t.readTime||b();let n=rh(e,t.missing),r=rs(t.readTime);return tb.newNoDocument(n,r)}(n,t):b());i.set(r.key.toString(),r)});let s=[];return t.forEach(e=>{let t=i.get(e.toString());t||b(),s.push(t)}),s}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new nq(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;let e=this.readVersions;this.mutations.forEach(t=>{e.delete(t.key.toString())}),e.forEach((e,t)=>{let n=G.fromPath(t);this.mutations.push(new nB(n,this.precondition(n)))}),await async function(e,t){let n={writes:t.map(t=>ry(e.serializer,t))};await e.Mo("Commit",e.serializer.databaseId,B.emptyPath(),n)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw b();t=U.min()}let n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new x(S.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){let t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(U.min())?nN.exists(!1):nN.updateTime(t):nN.none()}preconditionForUpdate(e){let t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(U.min()))throw new x(S.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return nN.updateTime(t)}return nN.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class a8{constructor(e,t,n,r,i){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=i,this._u=n.maxAttempts,this.t_=new sN(this.asyncQueue,"transaction_retry")}au(){this._u-=1,this.uu()}uu(){this.t_.Go(async()=>{let e=new a4(this.datastore),t=this.cu(e);t&&t.then(t=>{this.asyncQueue.enqueueAndForget(()=>e.commit().then(()=>{this.deferred.resolve(t)}).catch(e=>{this.lu(e)}))}).catch(e=>{this.lu(e)})})}cu(e){try{let t=this.updateFunction(e);return!ey(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}lu(e){this._u>0&&this.hu(e)?(this._u-=1,this.asyncQueue.enqueueAndForget(()=>(this.uu(),Promise.resolve()))):this.deferred.reject(e)}hu(e){if("FirebaseError"===e.name){let t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!nQ(t)}return!1}}class a3{constructor(e,t,n,r,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=p.UNAUTHENTICATED,this.clientId=O.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=i,this.authCredentials.start(n,async e=>{I("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(I("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();let e=new D;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(n){let t=s7(n,"Failed to shutdown persistence");e.reject(t)}}),e.promise}}async function a6(e,t){e.asyncQueue.verifyOperationInProgress(),I("FirestoreClient","Initializing OfflineComponentProvider");let n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await i6(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function a9(e,t){e.asyncQueue.verifyOperationInProgress();let n=await a7(e);I("FirestoreClient","Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener(e=>s4(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,n)=>s4(t.remoteStore,n)),e._onlineComponents=t}async function a7(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){I("FirestoreClient","Using user provided OfflineComponentProvider");try{await a6(e,e._uninitializedComponentsProvider._offline)}catch(t){if(!("FirebaseError"===t.name?t.code===S.FAILED_PRECONDITION||t.code===S.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code))throw t;T("Error using user provided cache. Falling back to memory cache: "+t),await a6(e,new aX)}}else I("FirestoreClient","Using default OfflineComponentProvider"),await a6(e,new aX);return e._offlineComponents}async function oe(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(I("FirestoreClient","Using user provided OnlineComponentProvider"),await a9(e,e._uninitializedComponentsProvider._online)):(I("FirestoreClient","Using default OnlineComponentProvider"),await a9(e,new a2))),e._onlineComponents}async function ot(e){let t=await oe(e),n=t.eventManager;return n.onListen=aI.bind(null,t.syncEngine),n.onUnlisten=ab.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=a_.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=aS.bind(null,t.syncEngine),n}function on(e){let t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}let or=new Map;function oi(e,t,n){if(!n)throw new x(S.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function os(e){if(!G.isDocumentKey(e))throw new x(S.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function oa(e){if(G.isDocumentKey(e))throw new x(S.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function oo(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{var t;let n=(t=e).constructor?t.constructor.name:null;return n?`a custom ${n} object`:"an object"}}return"function"==typeof e?"a function":b()}function ol(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new x(S.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let n=oo(e);throw new x(S.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}class ou{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new x(S.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null==(t=e.ssl)||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=0x2800000;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new x(S.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}(function(e,t,n,r){if(!0===t&&!0===r)throw new x(S.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)})("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=on(null!=(n=e.experimentalLongPollingOptions)?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new x(S.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new x(S.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new x(S.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){var t,n;return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class oh{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new ou({}),this._settingsFrozen=!1,this._terminateTask="notTerminated"}get app(){if(!this._app)throw new x(S.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new x(S.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new ou(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new N;switch(e.type){case"firstParty":return new R(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new x(S.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let t=or.get(e);t&&(I("ComponentProvider","Removing Datastore"),or.delete(e),t.terminate())}(this),Promise.resolve()}}class oc{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new oc(this.firestore,e,this._query)}}class od{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new of(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new od(this.firestore,e,this._key)}}class of extends oc{constructor(e,t,n){super(e,t,t0(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new od(this.firestore,null,new G(e))}withConverter(e){return new of(this.firestore,e,this._path)}}function om(e,t,...n){if(e=(0,h.Ku)(e),oi("collection","path",t),e instanceof oh){let r=B.fromString(t,...n);return oa(r),new of(e,null,r)}{if(!(e instanceof od||e instanceof of))throw new x(S.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child(B.fromString(t,...n));return oa(r),new of(e.firestore,null,r)}}function og(e,t,...n){if(e=(0,h.Ku)(e),1==arguments.length&&(t=O.newId()),oi("doc","path",t),e instanceof oh){let r=B.fromString(t,...n);return os(r),new od(e,null,new G(r))}{if(!(e instanceof od||e instanceof of))throw new x(S.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child(B.fromString(t,...n));return os(r),new od(e.firestore,e instanceof of?e.converter:null,new G(r))}}class op{constructor(e=Promise.resolve()){this.Pu=[],this.Iu=!1,this.Tu=[],this.Eu=null,this.du=!1,this.Au=!1,this.Ru=[],this.t_=new sN(this,"async_queue_retry"),this.Vu=()=>{let e=sD();e&&I("AsyncQueue","Visibility state changed to "+e.visibilityState),this.t_.jo()},this.mu=e;let t=sD();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this.Vu)}get isShuttingDown(){return this.Iu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.fu(),this.gu(e)}enterRestrictedMode(e){if(!this.Iu){this.Iu=!0,this.Au=e||!1;let t=sD();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Vu)}}enqueue(e){if(this.fu(),this.Iu)return new Promise(()=>{});let t=new D;return this.gu(()=>this.Iu&&this.Au?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Pu.push(e),this.pu()))}async pu(){if(0!==this.Pu.length){try{await this.Pu[0](),this.Pu.shift(),this.t_.reset()}catch(e){if(!eu(e))throw e;I("AsyncQueue","Operation failed with retryable error: "+e)}this.Pu.length>0&&this.t_.Go(()=>this.pu())}}gu(e){let t=this.mu.then(()=>(this.du=!0,e().catch(e=>{let t;throw this.Eu=e,this.du=!1,_("INTERNAL UNHANDLED ERROR: ",(t=e.message||"",e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t)),e}).then(e=>(this.du=!1,e))));return this.mu=t,t}enqueueAfterDelay(e,t,n){this.fu(),this.Ru.indexOf(e)>-1&&(t=0);let r=s9.createAndSchedule(this,e,t,n,e=>this.yu(e));return this.Tu.push(r),r}fu(){this.Eu&&b()}verifyOperationInProgress(){}async wu(){let e;do e=this.mu,await e;while(e!==this.mu)}Su(e){for(let t of this.Tu)if(t.timerId===e)return!0;return!1}bu(e){return this.wu().then(()=>{for(let t of(this.Tu.sort((e,t)=>e.targetTimeMs-t.targetTimeMs),this.Tu))if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.wu()})}Du(e){this.Ru.push(e)}yu(e){let t=this.Tu.indexOf(e);this.Tu.splice(t,1)}}class oy extends oh{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new op,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){let e=this._firestoreClient.terminate();this._queue=new op(e),this._firestoreClient=void 0,await e}}}function ow(e,t,n){n||(n="(default)");let r=(0,o.j6)(e,"firestore");if(r.isInitialized(n)){let e=r.getImmediate({identifier:n}),i=r.getOptions(n);if((0,h.bD)(i,t))return e;throw new x(S.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==t.cacheSizeBytes&&void 0!==t.localCache)throw new x(S.INVALID_ARGUMENT,"cache and cacheSizeBytes cannot be specified at the same time as cacheSizeBytes willbe deprecated. Instead, specify the cache size in the cache object");if(void 0!==t.cacheSizeBytes&&-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new x(S.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return r.initialize({options:t,instanceIdentifier:n})}function ov(e){if(e._terminated)throw new x(S.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||oI(e),e._firestoreClient}function oI(e){var t,n,r,i,s;let a=e._freezeSettings(),o=(i=e._databaseId,s=(null==(t=e._app)?void 0:t.options.appId)||"",new te(i,s,e._persistenceKey,a.host,a.ssl,a.experimentalForceLongPolling,a.experimentalAutoDetectLongPolling,on(a.experimentalLongPollingOptions),a.useFetchStreams));e._componentsProvider||(null==(n=a.localCache)?void 0:n._offlineComponentProvider)&&(null==(r=a.localCache)?void 0:r._onlineComponentProvider)&&(e._componentsProvider={_offline:a.localCache._offlineComponentProvider,_online:a.localCache._onlineComponentProvider}),e._firestoreClient=new a3(e._authCredentials,e._appCheckCredentials,e._queue,o,e._componentsProvider&&function(e){let t=null==e?void 0:e._online.build();return{_offline:null==e?void 0:e._offline.build(t),_online:t}}(e._componentsProvider))}class o_{constructor(e){this._byteString=e}static fromBase64String(e){try{return new o_(e2.fromBase64String(e))}catch(e){throw new x(S.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new o_(e2.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class oT{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new x(S.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new K(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class oE{constructor(e){this._methodName=e}}class ob{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new x(S.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new x(S.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return F(this._lat,e._lat)||F(this._long,e._long)}}class oS{constructor(e){this._values=(e||[]).map(e=>e)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(this._values,e._values)}}let ox=/^__.*__$/;class oD{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new nF(e,this.data,this.fieldMask,t,this.fieldTransforms):new nO(e,this.data,t,this.fieldTransforms)}}class oC{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new nF(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function oN(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw b()}}class oA{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.vu(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get Cu(){return this.settings.Cu}Fu(e){return new oA(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Mu(e){var t;let n=null==(t=this.path)?void 0:t.child(e),r=this.Fu({path:n,xu:!1});return r.Ou(e),r}Nu(e){var t;let n=null==(t=this.path)?void 0:t.child(e),r=this.Fu({path:n,xu:!1});return r.vu(),r}Lu(e){return this.Fu({path:void 0,xu:!0})}Bu(e){return oH(e,this.settings.methodName,this.settings.ku||!1,this.path,this.settings.qu)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}vu(){if(this.path)for(let e=0;e<this.path.length;e++)this.Ou(this.path.get(e))}Ou(e){if(0===e.length)throw this.Bu("Document fields must not be empty");if(oN(this.Cu)&&ox.test(e))throw this.Bu('Document fields cannot begin and end with "__"')}}class ok{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||sC(e)}Qu(e,t,n,r=!1){return new oA({Cu:e,methodName:t,qu:n,path:K.emptyPath(),xu:!1,ku:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function oR(e){let t=e._freezeSettings(),n=sC(e._databaseId);return new ok(e._databaseId,!!t.ignoreUndefinedProperties,n)}function oV(e,t,n,r,i,s={}){let a,o,l=e.Qu(s.merge||s.mergeFields?2:0,t,n,i);oQ("Data must be an object, but it was:",l,r);let u=oG(r,l);if(s.merge)a=new e0(l.fieldMask),o=l.fieldTransforms;else if(s.mergeFields){let e=[];for(let r of s.mergeFields){let i=oj(t,r,n);if(!l.contains(i))throw new x(S.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);oY(e,i)||e.push(i)}a=new e0(e),o=l.fieldTransforms.filter(e=>a.covers(e.field))}else a=null,o=l.fieldTransforms;return new oD(new tE(u),a,o)}class oM extends oE{_toFieldTransform(e){if(2!==e.Cu)throw 1===e.Cu?e.Bu(`${this._methodName}() can only appear at the top level of your update data`):e.Bu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof oM}}function oO(e,t,n){return new oA({Cu:3,qu:t.settings.qu,methodName:e._methodName,xu:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class oF extends null{_toFieldTransform(e){return new nD(e.path,new nv)}isEqual(e){return e instanceof oF}}class oL extends oE{constructor(e,t){super(e),this.Ku=t}_toFieldTransform(e){let t=oO(this,e,!0),n=new nI(this.Ku.map(e=>oK(e,t)));return new nD(e.path,n)}isEqual(e){return e instanceof oL&&(0,h.bD)(this.Ku,e.Ku)}}class oP extends oE{constructor(e,t){super(e),this.Ku=t}_toFieldTransform(e){let t=oO(this,e,!0),n=new nT(this.Ku.map(e=>oK(e,t)));return new nD(e.path,n)}isEqual(e){return e instanceof oP&&(0,h.bD)(this.Ku,e.Ku)}}class oU extends oE{constructor(e,t){super(e),this.$u=t}_toFieldTransform(e){let t=new nb(e.serializer,np(e.serializer,this.$u));return new nD(e.path,t)}isEqual(e){return e instanceof oU&&this.$u===e.$u}}function oq(e,t,n,r){let i=e.Qu(1,t,n);oQ("Data must be an object, but it was:",i,r);let s=[],a=tE.empty();return eQ(r,(e,r)=>{let o=oJ(t,e,n);r=(0,h.Ku)(r);let l=i.Nu(o);if(r instanceof oM)s.push(o);else{let e=oK(r,l);null!=e&&(s.push(o),a.set(o,e))}}),new oC(a,new e0(s),i.fieldTransforms)}function oB(e,t,n,r,i,s){let a=e.Qu(1,t,n),o=[oj(t,r,n)],l=[i];if(s.length%2!=0)throw new x(S.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<s.length;e+=2)o.push(oj(t,s[e])),l.push(s[e+1]);let u=[],c=tE.empty();for(let e=o.length-1;e>=0;--e)if(!oY(u,o[e])){let t=o[e],n=l[e];n=(0,h.Ku)(n);let r=a.Nu(t);if(n instanceof oM)u.push(t);else{let e=oK(n,r);null!=e&&(u.push(t),c.set(t,e))}}return new oC(c,new e0(u),a.fieldTransforms)}function oz(e,t,n,r=!1){return oK(n,e.Qu(r?4:3,t))}function oK(e,t){if(o$(e=(0,h.Ku)(e)))return oQ("Unsupported field value:",t,e),oG(e,t);if(e instanceof oE)return function(e,t){if(!oN(t.Cu))throw t.Bu(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Bu(`${e._methodName}() is not currently supported inside arrays`);let n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.xu&&4!==t.Cu)throw t.Bu("Nested arrays are not supported");let n=[],r=0;for(let i of e){let e=oK(i,t.Lu(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}return function(e,t){if(null===(e=(0,h.Ku)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return np(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){let n=P.fromDate(e);return{timestampValue:rr(t.serializer,n)}}if(e instanceof P){let n=new P(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:rr(t.serializer,n)}}if(e instanceof ob)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof o_)return{bytesValue:ri(t.serializer,e._byteString)};if(e instanceof od){let n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.Bu(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:ra(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof oS)return{mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{values:e.toArray().map(e=>{if("number"!=typeof e)throw t.Bu("VectorValues must only contain numeric values.");return nm(t.serializer,e)})}}}}};throw t.Bu(`Unsupported field value: ${oo(e)}`)}(e,t)}function oG(e,t){let n={};return ej(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):eQ(e,(e,r)=>{let i=oK(r,t.Mu(e));null!=i&&(n[e]=i)}),{mapValue:{fields:n}}}function o$(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof P||e instanceof ob||e instanceof o_||e instanceof od||e instanceof oE||e instanceof oS)}function oQ(e,t,n){if(!o$(n)||"object"!=typeof n||null===n||Object.getPrototypeOf(n)!==Object.prototype&&null!==Object.getPrototypeOf(n)){let r=oo(n);throw"an object"===r?t.Bu(e+" a custom object"):t.Bu(e+" "+r)}}function oj(e,t,n){if((t=(0,h.Ku)(t))instanceof oT)return t._internalPath;if("string"==typeof t)return oJ(e,t);throw oH("Field path arguments must be of type string or ",e,!1,void 0,n)}let oW=RegExp("[~\\*/\\[\\]]");function oJ(e,t,n){if(t.search(oW)>=0)throw oH(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new oT(...t.split("."))._internalPath}catch(r){throw oH(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function oH(e,t,n,r,i){let s=r&&!r.isEmpty(),a=void 0!==i,o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${r}`),a&&(l+=` in document ${i}`),l+=")"),new x(S.INVALID_ARGUMENT,o+e+l)}function oY(e,t){return e.some(e=>e.isEqual(t))}class oX{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new od(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){let e=new oZ(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(o0("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class oZ extends oX{data(){return super.data()}}function o0(e,t){return"string"==typeof t?oJ(e,t):t instanceof oT?t._internalPath:t._delegate._internalPath}class o1{}class o2 extends o1{}function o5(e,t,...n){let r=[];for(let i of(t instanceof o1&&r.push(t),function(e){let t=e.filter(e=>e instanceof o3).length,n=e.filter(e=>e instanceof o4).length;if(t>1||t>0&&n>0)throw new x(S.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r=r.concat(n)),r))e=i._apply(e);return e}class o4 extends o2{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new o4(e,t,n)}_apply(e){let t=this._parse(e);return ls(e._query,t),new oc(e.firestore,e.converter,t3(e._query,t))}_parse(e){let t=oR(e.firestore);return function(e,t,n,r,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new x(S.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){li(a,s);let t=[];for(let n of a)t.push(lr(r,e,n));o={arrayValue:{values:t}}}else o=lr(r,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||li(a,s),o=oz(n,t,a,"in"===s||"not-in"===s);return tA.create(i,s,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}function o8(e,t,n){let r=o0("where",e);return o4._create(r,t,n)}class o3 extends o1{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new o3(e,t)}_parse(e){let t=this._queryConstraints.map(t=>t._parse(e)).filter(e=>e.getFilters().length>0);return 1===t.length?t[0]:tk.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;for(let e of t.getFlattenedFilters())ls(n,e),n=t3(n,e)}(e._query,t),new oc(e.firestore,e.converter,t3(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class o6 extends o2{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new o6(e,t)}_apply(e){let t=function(e,t,n){if(null!==e.startAt)throw new x(S.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new x(S.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new tC(t,n)}(e._query,this._field,this._direction);return new oc(e.firestore,e.converter,function(e,t){let n=e.explicitOrderBy.concat([t]);return new tZ(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function o9(e,t="asc"){let n=o0("orderBy",e);return o6._create(n,t)}class o7 extends o2{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new o7(e,t,n)}_apply(e){return new oc(e.firestore,e.converter,t6(e._query,this._limit,this._limitType))}}class le extends o2{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new le(e,t,n)}_apply(e){var t;let n=ln(e,this.type,this._docOrFields,this._inclusive);return new oc(e.firestore,e.converter,(t=e._query,new tZ(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,n,t.endAt)))}}class lt extends o2{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new lt(e,t,n)}_apply(e){var t;let n=ln(e,this.type,this._docOrFields,this._inclusive);return new oc(e.firestore,e.converter,(t=e._query,new tZ(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,n)))}}function ln(e,t,n,r){if(n[0]=(0,h.Ku)(n[0]),n[0]instanceof oX)return function(e,t,n,r,i){if(!r)throw new x(S.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);let s=[];for(let n of t5(e))if(n.field.isKeyField())s.push(tc(t,r.key));else{let e=r.data.field(n.field);if(e6(e))throw new x(S.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){let e=n.field.canonicalString();throw new x(S.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new tS(s,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{let i=oR(e.firestore);return function(e,t,n,r,i,s){let a=e.explicitOrderBy;if(i.length>a.length)throw new x(S.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let o=[];for(let s=0;s<i.length;s++){let l=i[s];if(a[s].field.isKeyField()){if("string"!=typeof l)throw new x(S.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof l}`);if(!t2(e)&&-1!==l.indexOf("/"))throw new x(S.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${l}' contains a slash.`);let n=e.path.child(B.fromString(l));if(!G.isDocumentKey(n))throw new x(S.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);let i=new G(n);o.push(tc(t,i))}else{let e=oz(n,r,l);o.push(e)}}return new tS(o,s)}(e._query,e.firestore._databaseId,i,t,n,r)}}function lr(e,t,n){if("string"==typeof(n=(0,h.Ku)(n))){if(""===n)throw new x(S.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!t2(t)&&-1!==n.indexOf("/"))throw new x(S.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);let r=t.path.child(B.fromString(n));if(!G.isDocumentKey(r))throw new x(S.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return tc(e,new G(r))}if(n instanceof od)return tc(e,n._key);throw new x(S.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${oo(n)}.`)}function li(e,t){if(!Array.isArray(e)||0===e.length)throw new x(S.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function ls(e,t){let n=function(e,t){for(let n of e)for(let e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new x(S.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new x(S.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}class la{convertValue(e,t="none"){switch(ti(e)){case 0:return null;case 1:return e.booleanValue;case 2:return e8(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(e3(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw b()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let n={};return eQ(e,(e,r)=>{n[e]=this.convertValue(r,t)}),n}convertVectorValue(e){var t,n,r;return new oS(null==(r=null==(n=null==(t=e.fields)?void 0:t.value.arrayValue)?void 0:n.values)?void 0:r.map(e=>e8(e.doubleValue)))}convertGeoPoint(e){return new ob(e8(e.latitude),e8(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":let n=e9(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(e7(e));default:return null}}convertTimestamp(e){let t=e4(e);return new P(t.seconds,t.nanos)}convertDocumentKey(e,t){let n=B.fromString(e);rb(n)||b();let r=new tt(n.get(1),n.get(3)),i=new G(n.popFirst(5));return r.isEqual(t)||_(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function lo(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class ll extends la{constructor(e){super(),this.firestore=e}convertBytes(e){return new o_(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new od(this.firestore,null,t)}}class lu{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class lh extends oX{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new lc(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let n=this._document.data.field(o0("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class lc extends lh{data(e={}){return super.data(e)}}class ld{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new lu(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){let e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(n=>{e.call(t,new lc(this._firestore,this._userDataWriter,n.key,n,new lu(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){let t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new x(S.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map(n=>{let r=new lc(e._firestore,e._userDataWriter,n.doc.key,n.doc,new lu(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}})}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter(e=>t||3!==e.type).map(t=>{let r=new lc(e._firestore,e._userDataWriter,t.doc.key,t.doc,new lu(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter),i=-1,s=-1;return 0!==t.type&&(i=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(s=(n=n.add(t.doc)).indexOf(t.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return b()}}(t.type),doc:r,oldIndex:i,newIndex:s}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function lf(e){e=ol(e,od);let t=ol(e.firestore,oy);return(function(e,t,n={}){let r=new D;return e.asyncQueue.enqueueAndForget(async()=>(function(e,t,n,r,i){let s=new a5({next:o=>{s.Za(),t.enqueueAndForget(()=>ao(e,a));let l=o.docs.has(n);!l&&o.fromCache?i.reject(new x(S.UNAVAILABLE,"Failed to get document because the client is offline.")):l&&o.fromCache&&r&&"server"===r.source?i.reject(new x(S.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):i.resolve(o)},error:e=>i.reject(e)}),a=new ac(t0(n.path),s,{includeMetadataChanges:!0,_a:!0});return aa(e,a)})(await ot(e),e.asyncQueue,t,n,r)),r.promise})(ov(t),e._key).then(n=>(function(e,t,n){let r=n.docs.get(t._key),i=new lm(e);return new lh(e,i,t._key,r,new lu(n.hasPendingWrites,n.fromCache),t.converter)})(t,e,n))}class lm extends la{constructor(e){super(),this.firestore=e}convertBytes(e){return new o_(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new od(this.firestore,null,t)}}function lg(e){e=ol(e,oc);let t=ol(e.firestore,oy),n=ov(t),r=new lm(t);return function(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new x(S.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}(e._query),(function(e,t,n={}){let r=new D;return e.asyncQueue.enqueueAndForget(async()=>(function(e,t,n,r,i){let s=new a5({next:n=>{s.Za(),t.enqueueAndForget(()=>ao(e,a)),n.fromCache&&"server"===r.source?i.reject(new x(S.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(n)},error:e=>i.reject(e)}),a=new ac(n,s,{includeMetadataChanges:!0,_a:!0});return aa(e,a)})(await ot(e),e.asyncQueue,t,n,r)),r.promise})(n,e._query).then(n=>new ld(t,r,e,n))}function lp(e,t,n){e=ol(e,od);let r=ol(e.firestore,oy),i=lo(e.converter,t,n);return lw(r,[oV(oR(r),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,nN.none())])}function ly(e){return lw(ol(e.firestore,oy),[new nq(e._key,nN.none())])}function lw(e,t){var n=ov(e);let r=new D;return n.asyncQueue.enqueueAndForget(async()=>ax(await oe(n).then(e=>e.syncEngine),t,r)),r.promise}class lv{constructor(e){let t;this.kind="persistent",(null==e?void 0:e.tabManager)?(e.tabManager._initialize(e),t=e.tabManager):(t=function(e){return new l_(null==e?void 0:e.forceOwnership)}(void 0))._initialize(e),this._onlineComponentProvider=t._onlineComponentProvider,this._offlineComponentProvider=t._offlineComponentProvider}toJSON(){return{kind:this.kind}}}function lI(e){return new lv(e)}class l_{constructor(e){this.forceOwnership=e,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=a2.provider,this._offlineComponentProvider={build:t=>new a0(t,null==e?void 0:e.cacheSizeBytes,this.forceOwnership)}}}let lT={maxAttempts:5};class lE{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=oR(e)}set(e,t,n){this._verifyNotCommitted();let r=lb(e,this._firestore),i=lo(r.converter,t,n),s=oV(this._dataReader,"WriteBatch.set",r._key,i,null!==r.converter,n);return this._mutations.push(s.toMutation(r._key,nN.none())),this}update(e,t,n,...r){let i;this._verifyNotCommitted();let s=lb(e,this._firestore);return i="string"==typeof(t=(0,h.Ku)(t))||t instanceof oT?oB(this._dataReader,"WriteBatch.update",s._key,t,n,r):oq(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,nN.exists(!0))),this}delete(e){this._verifyNotCommitted();let t=lb(e,this._firestore);return this._mutations=this._mutations.concat(new nq(t._key,nN.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new x(S.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function lb(e,t){if((e=(0,h.Ku)(e)).firestore!==t)throw new x(S.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class lS extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=oR(e)}get(e){let t=lb(e,this._firestore),n=new ll(this._firestore);return this._transaction.lookup([t._key]).then(e=>{if(!e||1!==e.length)return b();let r=e[0];if(r.isFoundDocument())return new oX(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new oX(this._firestore,n,t._key,null,t.converter);throw b()})}set(e,t,n){let r=lb(e,this._firestore),i=lo(r.converter,t,n),s=oV(this._dataReader,"Transaction.set",r._key,i,null!==r.converter,n);return this._transaction.set(r._key,s),this}update(e,t,n,...r){let i,s=lb(e,this._firestore);return i="string"==typeof(t=(0,h.Ku)(t))||t instanceof oT?oB(this._dataReader,"Transaction.update",s._key,t,n,r):oq(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){let t=lb(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){let t=lb(e,this._firestore),n=new lm(this._firestore);return super.get(e).then(e=>new lh(this._firestore,n,t._key,e._document,new lu(!1,!1),t.converter))}}function lx(e,t,n){e=ol(e,oy);let r=Object.assign(Object.assign({},lT),n);if(r.maxAttempts<1)throw new x(S.INVALID_ARGUMENT,"Max attempts must be at least 1");return function(e,t,n){let r=new D;return e.asyncQueue.enqueueAndForget(async()=>{let i=await oe(e).then(e=>e.datastore);new a8(e.asyncQueue,i,n,t,r).au()}),r.promise}(ov(e),n=>t(new lS(e,n)),r)}function lD(e){return ov(e=ol(e,oy)),new lE(e,t=>lw(e,t))}new WeakMap,!function(e,t=!0){y=o.MF,(0,o.om)(new l.uA("firestore",(e,{instanceIdentifier:n,options:r})=>{let i=e.getProvider("app").getImmediate(),s=new oy(new A(e.getProvider("auth-internal")),new M(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new x(S.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new tt(e.options.projectId,t)}(i,n),i);return r=Object.assign({useFetchStreams:t},r),s._setSettings(r),s},"PUBLIC").setMultipleInstances(!0)),(0,o.KO)(g,"4.7.3",void 0),(0,o.KO)(g,"4.7.3","esm2017")}()}}]);